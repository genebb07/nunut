{% extends base_template %}
{% load static %}

{% block title %}Inicio | nunut{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
    rel="stylesheet" />

<style>
    :root {
        --primary-elite: #85c81a;
        --primary-dark-elite: #6fb015;
        --bg-light-elite: #f7f8f6;
        --bg-dark-elite: #1b2111;
    }

    /* Evitar conflictos con base.html pero mantener el look de index.html */
    .dashboard-elite {
        font-family: 'Inter', sans-serif;
    }

    /* Utilidades Personalizadas */
    .rounded-4 {
        border-radius: 1.5rem !important;
    }

    .card-custom {
        background: var(--bg-content);
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 1.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        overflow: hidden;
        box-sizing: border-box;
        transition: all 0.3s ease;
    }

    body.dark-mode .card-custom {
        background: #1a1d14;
        border-color: rgba(133, 200, 26, 0.2);
        box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.3);
    }

    .hero-card {
        background: linear-gradient(135deg, var(--primary-elite), var(--primary-dark-elite));
        color: white;
        border: none;
        box-shadow: 0 1rem 3rem rgba(133, 200, 26, 0.2);
    }

    .glass-inner {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
    }

    /* Iconos con fondo suave */
    .icon-box {
        padding: 0.75rem;
        border-radius: 1rem;
        display: inline-flex;
    }

    /* Im치genes de comida */
    .meal-img {
        height: 160px;
        background-size: cover;
        background-position: center;
        transition: transform 0.5s ease;
    }

    .card-custom:hover .meal-img {
        transform: scale(1.05);
    }

    /* Gr치ficos circulares SVG */
    .svg-chart {
        transform: rotate(-90deg);
    }

    /* Ajustes de texto */
    .text-xs-bold {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Guest Mode Styles */
    .blur-preview {
        filter: blur(8px);
        user-select: none;
        pointer-events: none;
        opacity: 0.6;
    }

    .lock-overlay {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(4px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: 1.5rem;
    }

    /* Energy Selector Styles */
    .energy-btn {
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
        opacity: 0.7;
        filter: grayscale(100%);
    }

    .energy-btn:hover {
        transform: translateY(-3px);
        opacity: 1;
        filter: grayscale(0%);
    }

    .btn-check:checked+.energy-btn {
        background-color: var(--primary-elite) !important;
        color: white !important;
        transform: scale(1.1);
        box-shadow: 0 8px 20px rgba(133, 200, 26, 0.3);
        opacity: 1;
        filter: grayscale(0%);
        border: none !important;
    }

    /* Time Input Styles */
    input[type="time"] {
        border-radius: 1rem;
        font-family: 'Inter', sans-serif;
        color: var(--bg-dark-elite);
        cursor: pointer;
    }

    input[type="time"]::-webkit-calendar-picker-indicator {
        background: transparent;
        bottom: 0;
        color: transparent;
        cursor: pointer;
        height: auto;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
        width: auto;
    }

    /* Macro Minimal Cards */
    .macro-mini-card {
        background: white;
        border-radius: 1.2rem;
        padding: 1.2rem;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        border: 1px solid rgba(0, 0, 0, 0.03);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.02);
        transition: transform 0.2s;
    }

    .macro-mini-card:hover {
        transform: translateY(-3px);
    }

    body.dark-mode .macro-mini-card {
        background: #252a1c;
        border-color: rgba(255, 255, 255, 0.05);
    }



    body.dark-mode .lock-overlay {
        background: rgba(0, 0, 0, 0.4);
    }

    .position-relative {
        position: relative !important;
    }

    /* Glass Icons */
    .water-glass {
        color: #cbd5e1;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        font-size: 28px;
    }

    .water-glass.active {
        color: #3abff8;
        transform: scale(1.15) translateY(-2px);
        filter: drop-shadow(0 4px 8px rgba(58, 191, 248, 0.3));
        font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    .btn-water {
        border: 2px solid #3abff8;
        color: #3abff8;
        background: transparent;
        width: 36px;
        height: 36px;
        transition: all 0.2s;
    }

    .btn-water:hover {
        background: #3abff8;
        color: white;
        transform: scale(1.1);
    }

    body.dark-mode .water-glass {
        color: #334155;
    }

    body.dark-mode .water-glass.active {
        color: #3abff8;
    }

    /* Macro Cards con gr치ficos circulares */
    .macro-card {
        position: relative;
        padding: 1.5rem;
    }

    .macro-circle-container {
        position: relative;
        width: 80px;
        height: 80px;
        margin: 0 auto 1rem;
    }

    .macro-circle-bg {
        fill: none;
        stroke: #e5e7eb;
        stroke-width: 8;
    }

    body.dark-mode .macro-circle-bg {
        stroke: #374151;
    }

    .macro-circle-progress {
        fill: none;
        stroke-width: 8;
        stroke-linecap: round;
        transition: stroke-dashoffset 1s ease;
    }

    .macro-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.25rem;
        font-weight: 900;
    }

    /* Sleep Input Styles */
    .sleep-input-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(133, 200, 26, 0.1);
        padding: 0.75rem;
        border-radius: 12px;
    }

    body.dark-mode .sleep-input-group {
        background: rgba(133, 200, 26, 0.15);
    }

    .sleep-input {
        width: 60px;
        text-align: center;
        border: 2px solid var(--primary-elite);
        border-radius: 8px;
        padding: 0.5rem;
        font-weight: 700;
        background: var(--bg-content);
    }

    body.dark-mode .sleep-input {
        background: #0f1108;
        color: var(--text-primary);
        border-color: var(--primary-dark-elite);
    }

    /* Progress bars dark mode */
    body.dark-mode .progress {
        background-color: #374151;
    }

    /* Border dashed dark mode */
    body.dark-mode .border-dashed {
        border-color: rgba(133, 200, 26, 0.3) !important;
    }
</style>
{% endblock %}

{% block container_class %}container max-w-7xl dashboard-elite{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-5 mt-2">
    <div class="d-flex align-items-center gap-3">
        <div class="rounded-circle border border-2 border-success p-1 shadow-sm" style="width: 62px; height: 62px;">
            {% if user.is_authenticated and user.perfil.foto_perfil %}
            <img src="data:image/png;base64,{{ user.perfil.get_foto_base64 }}" class="rounded-circle w-100 h-100"
                style="object-fit: cover;">
            {% else %}
            <div class="w-100 h-100 rounded-circle bg-success-subtle d-flex align-items-center justify-content-center fw-bold"
                style="color: var(--primary);">
                {{ user.username.0|upper }}
            </div>
            {% endif %}
        </div>
        <div>
            {% if es_invitado %}
            <h2 class="text-xs-bold text-muted mb-0">Modo Invitado</h2>
            <p class="h3 fw-900 mb-0" style="font-weight: 900;">Vista Previa</p>
            {% else %}
            <h2 class="text-xs-bold text-muted mb-0">춰Hola de nuevo, {{ user.first_name|default:user.username }}!</h2>
            <p class="h3 fw-900 mb-0" style="font-weight: 900;">Dashboard Nutricional</p>
            {% endif %}
        </div>
    </div>
    <div class="d-none d-md-flex align-items-center gap-3 card-custom px-4 py-2 shadow-sm"
        style="border: 1px solid rgba(0, 0, 0, 0.08); box-sizing: border-box;">
        <span class="material-symbols-outlined fs-2" style="color: var(--primary);">local_fire_department</span>
        <div>
            <p class="text-xs-bold text-muted mb-0">Racha Actual</p>
            <span class="fw-bold fs-5" id="streak-counter">{{ mensaje_racha|default:"춰Comienza hoy!" }}</span>
        </div>
    </div>
</div>

<div class="row g-4">
    <main class="col-lg-8">
        {% if informe %}
        <section class="card-custom hero-card p-4 p-md-5 mb-4 position-relative">
            {% if es_invitado %}
            <div class="lock-overlay">
                <span class="material-symbols-outlined fs-2 text-white mb-2">lock</span>
                <span class="badge bg-white text-dark rounded-pill fw-bold border-0 px-3 py-2">AN츼LISIS DE
                    CALOR칈AS</span>
            </div>
            <div class="blur-preview">
                {% endif %}
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <p class="text-xs-bold text-white-50 mb-1">Calor칤as Restantes</p>
                        <h3 class="display-3 fw-900 mb-4" style="font-weight: 900;">{{ informe.plan.calorias_dia }}
                            <small class="fs-4 fw-normal opacity-75">kcal</small>
                        </h3>

                        <div class="mb-2 d-flex justify-content-between text-xs-bold opacity-75">
                            <span>Consumido: <span id="calorias-consumidas">0</span> kcal</span>
                            <span>Objetivo: {{ informe.plan.calorias_dia }} kcal</span>
                        </div>
                        <div class="progress"
                            style="height: 12px; border-radius: 10px; background: rgba(255,255,255,0.2);">
                            <div class="progress-bar bg-white shadow-sm" id="progress-calorias"
                                style="width: 0%; border-radius: 10px;"></div>
                        </div>
                    </div>
                    <div class="col-md-4 d-flex justify-content-center mt-4 mt-md-0">
                        <div class="position-relative" style="width: 170px; height: 170px;">
                            <svg class="svg-chart w-100 h-100">
                                <circle cx="85" cy="85" r="75" fill="none" stroke="rgba(255,255,255,0.2)"
                                    stroke-width="12">
                                </circle>
                                <circle cx="85" cy="85" r="75" fill="none" stroke="white" stroke-width="12"
                                    stroke-dasharray="471" stroke-dashoffset="471" stroke-linecap="round"></circle>
                            </svg>
                            <div class="position-absolute top-50 start-50 translate-middle glass-inner d-flex flex-column align-items-center justify-content-center"
                                style="width: 130px; height: 130px;">
                                <span class="h2 fw-900 mb-0" id="porcentaje-calorias">0%</span>
                                <span class="text-xs-bold" style="font-size: 0.6rem;">Meta Diaria</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% if es_invitado %}
            </div>{% endif %}
        </section>

        <h3 class="h5 fw-900 mb-4">Distribuci칩n de Nutrientes</h3>
        <div class="position-relative mb-5">
            {% if es_invitado %}
            <div class="lock-overlay" style="z-index: 20;">
                <span class="material-symbols-outlined fs-1 text-primary mb-2">lock</span>
                <span class="badge bg-dark text-white rounded-pill fw-bold border-0 px-3 py-2">MACRONUTRIENTES</span>
            </div>
            <div class="blur-preview">
                {% endif %}

                <div class="row g-3">
                    <!-- Prote칤na -->
                    <div class="col-md-4 col-sm-6">
                        <div class="macro-mini-card border-bottom border-primary border-4">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="icon-box bg-primary bg-opacity-10 text-primary p-2 rounded-circle">
                                    <span class="material-symbols-outlined fs-5">fitness_center</span>
                                </div>
                                <span class="badge bg-light text-muted fw-bold border header-badge">Prote칤na</span>
                            </div>
                            <div>
                                <h4 class="h4 fw-900 mb-1"><span id="consumo-proteina">0</span>g</h4>
                                <div class="d-flex justify-content-between x-small text-muted fw-bold mb-1">
                                    <span>Progreso</span>
                                    <span>{{ informe.plan.proteinas_g }}g Meta</span>
                                </div>
                                <div class="progress"
                                    style="height: 6px; border-radius: 3px; background-color: rgba(0,0,0,0.05);">
                                    <div class="progress-bar bg-primary" id="bar-proteina" role="progressbar"
                                        style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Carbohidratos -->
                    <div class="col-md-4 col-sm-6">
                        <div class="macro-mini-card border-bottom border-4 border-warning">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="icon-box bg-warning text-warning p-2 rounded-circle">
                                    <span class="material-symbols-outlined fs-5">bakery_dining</span>
                                </div>
                                <span class="badge bg-light text-muted fw-bold border header-badge">Carbos</span>
                            </div>
                            <div>
                                <h4 class="h4 fw-900 mb-1"><span id="consumo-carbos">0</span>g</h4>
                                <div class="d-flex justify-content-between x-small text-muted fw-bold mb-1">
                                    <span>Progreso</span>
                                    <span>{{ informe.plan.carbohidratos_g }}g Meta</span>
                                </div>
                                <div class="progress"
                                    style="height: 6px; border-radius: 3px; background-color: rgba(0,0,0,0.05);">
                                    <div class="progress-bar bg-warning" id="bar-carbos" role="progressbar"
                                        style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grasas -->
                    <div class="col-md-4 col-sm-6">
                        <div class="macro-mini-card border-bottom border-4 border-danger">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="icon-box bg-danger text-danger p-2 rounded-circle">
                                    <span class="material-symbols-outlined fs-5">oil_barrel</span>
                                </div>
                                <span class="badge bg-light text-muted fw-bold border header-badge">Grasas</span>
                            </div>
                            <div>
                                <h4 class="h4 fw-900 mb-1"><span id="consumo-grasas">0</span>g</h4>
                                <div class="d-flex justify-content-between x-small text-muted fw-bold mb-1">
                                    <span>Progreso</span>
                                    <span>{{ informe.plan.grasas_g }}g Meta</span>
                                </div>
                                <div class="progress"
                                    style="height: 6px; border-radius: 3px; background-color: rgba(0,0,0,0.05);">
                                    <div class="progress-bar bg-danger" id="bar-grasas" role="progressbar"
                                        style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if es_invitado %}
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="card-custom p-5 text-center mb-4">
            <span class="material-symbols-outlined display-1 text-muted mb-3">clinical_notes</span>
            <h3 class="fw-900">Perfil Incompleto</h3>
            <p class="text-muted">Necesitamos conocer tu altura, peso y edad para calcular tu plan nutricional elite.
            </p>
            <a href="{% url 'base:perfil' %}" class="btn btn-success rounded-pill px-4 py-2 fw-bold"
                style="background-color: var(--primary-elite); border-color: var(--primary-elite);">Completar Perfil</a>
        </div>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="h5 fw-900 mb-0">Comidas Sugeridas</h3>
            <a href="{% url 'base:planes' %}" hx-get="{% url 'base:planes' %}" hx-target="#main-content"
                hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true"
                class="fw-bold text-decoration-none small" style="color: var(--primary);">Ver plan completo</a>
        </div>
        <div class="row g-3">
            {% for receta in recetas_sugeridas %}
            <div class="col-6 col-md-3">
                <div class="card-custom h-100 position-relative overflow-hidden shadow-sm"
                    style="transition: transform 0.3s ease;">
                    <div class="meal-img position-relative"
                        style="background-image: url('{% if receta.imagen_url %}{{ receta.imagen_url }}{% else %}https://images.unsplash.com/photo-1495521821757-a1efb6729352?w=300{% endif %}'); height: 120px; background-size: cover; background-position: center;">

                        <button
                            class="favorite-btn position-absolute {% if receta.id in favoritas_ids %}active{% endif %}"
                            style="top: 8px; right: 8px; width: 30px; height: 30px; border-radius: 50%; border: none; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 5;"
                            onclick="toggleFavorite( {{ receta.id }}, this )">
                            <span
                                class="material-symbols-outlined fs-6 {% if receta.id in favoritas_ids %}text-primary{% else %}text-muted{% endif %}">favorite</span>
                        </button>

                        <div class="position-absolute bottom-0 start-0 w-100 p-2 bg-dark bg-opacity-50">
                            <span class="text-white fw-bold" style="font-size: 0.6rem; letter-spacing: 1px;">{{ receta.get_tipo_dieta_display|upper }}</span>
                        </div>
                    </div>
                    <div class="p-3">
                        <p class="fw-bold mb-1 text-truncate" style="font-size: 0.9rem;">{{ receta.titulo }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small fw-bold">{{ receta.calorias }} kcal</span>
                            <a href="{% url 'base:planes' %}?receta={{ receta.id }}"
                                class="btn btn-primary btn-sm rounded-circle d-flex align-items-center justify-content-center"
                                style="width: 25px; height: 25px; background-color: var(--primary); border: none;">
                                <span class="material-symbols-outlined"
                                    style="font-size: 14px; color: white;">arrow_forward</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </main>

    <aside class="col-lg-4">
        <!-- SECCI칍N DE RECOMENDACIONES IA PREMIUM -->
        <div class="card-custom p-4 mb-4 border-0 shadow-lg position-relative overflow-hidden"
            style="background: linear-gradient(135deg, #12140d 0%, #1e2615 100%);">
            <!-- Glass Background Decor -->
            <div class="position-absolute"
                style="top: -20px; right: -20px; width: 100px; height: 100px; background: var(--primary); filter: blur(60px); opacity: 0.3;">
            </div>

            <div class="d-flex align-items-center gap-3 mb-3 position-relative" style="z-index: 2;">
                <div class="d-flex align-items-center justify-content-center"
                    style="width: 48px; height: 48px; border-radius: 12px; background: rgba(133, 200, 26, 0.15);">
                    <span class="material-symbols-outlined text-primary fs-3">psychology</span>
                </div>
                <div>
                    <h4 class="fw-800 h6 mb-0 text-white" style="letter-spacing: 0.5px;">Coach IA nunut</h4>
                    <span class="text-xs-bold text-primary" style="font-size: 0.6rem; opacity: 0.8;">An치lisis
                        Activo</span>
                </div>
            </div>

            <div id="ia-recommendation-container" class="position-relative mb-3" style="z-index: 2;">
                <p class="small text-white opacity-90 mb-0 ps-2 italic lh-base" id="ia-message"
                    style="font-size: 0.85rem; font-weight: 500; border-left: 2px solid var(--primary);">
                    {{ recomendacion_ia }}
                </p>
            </div>

            <div class="d-flex gap-2 mb-0" style="z-index: 2; position: relative;">
                <span
                    class="badge rounded-pill bg-primary bg-opacity-20 text-white x-small fw-bold border border-white border-opacity-10"
                    style="font-size: 0.6rem; padding: 4px 10px; letter-spacing: 0.5px;">#INTELIGENCIA-VITAL</span>
                <span
                    class="badge rounded-pill bg-primary bg-opacity-40 text-white x-small fw-bold border border-primary border-opacity-10"
                    style="font-size: 0.6rem; padding: 4px 10px; letter-spacing: 0.5px;">#NUNUT-ELITE</span>
            </div>
        </div>

        <style>
            @keyframes pulse-soft {
                0% {
                    transform: scale(0.95);
                    opacity: 0.2;
                }

                50% {
                    transform: scale(1.05);
                    opacity: 0.4;
                }

                100% {
                    transform: scale(0.95);
                    opacity: 0.2;
                }
            }

            .animate-pulse {
                animation: pulse-soft 2s infinite ease-in-out;
            }
        </style>

        <div class="card-custom p-4 mb-4 border-start border-4 border-info position-relative overflow-hidden"
            style="border-color: #3abff8 !important; background: linear-gradient(145deg, var(--bg-content), rgba(58, 191, 248, 0.05));">
            {% if es_invitado %}
            <div class="lock-overlay">
                <span class="material-symbols-outlined fs-2 text-info">lock</span>
            </div>
            <div class="blur-preview">
                {% endif %}
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex align-items-center gap-2">
                        <div class="bg-info bg-opacity-10 p-2 rounded-circle">
                            <span class="material-symbols-outlined text-info fs-3">water_drop</span>
                        </div>
                        <h4 class="fw-900 h5 mb-0">Hidrataci칩n</h4>
                    </div>
                    <span class="badge bg-info bg-opacity-20 text-white rounded-pill text-xs-bold px-3 py-2"
                        id="water-percentage">
                        {{ registro_agua.porcentaje|default:"0" }} % Meta
                    </span>
                </div>

                <div class="d-flex align-items-center justify-content-center gap-4 mb-4">
                    <button class="btn btn-water rounded-circle d-flex align-items-center justify-content-center p-0"
                        onclick="updateWater(-1)">
                        <span class="material-symbols-outlined fs-5">remove</span>
                    </button>

                    <div class="d-flex flex-wrap justify-content-center gap-2" id="water-glasses-container"
                        style="max-width: 180px;">
                        <!-- JS generar치 los vasos -->
                    </div>

                    <button class="btn btn-water rounded-circle d-flex align-items-center justify-content-center p-0"
                        onclick="updateWater(1)">
                        <span class="material-symbols-outlined fs-5">add</span>
                    </button>
                </div>

                <div class="text-center">
                    <h4 class="h2 fw-900 mb-0">
                        <span id="water-liters">{{ registro_agua.litros|default:"0.0"|floatformat:1 }}</span>
                        <small class="text-muted h6">/ <span id="meta-liters-display">{{ registro_agua.meta_litros|default:"2.0" }}</span> Lts</small>
                    </h4>
                    <p class="text-xs-bold text-muted mb-0" id="water-status">
                        Vasos: <span id="current-vasos-display">{{ registro_agua.cantidad_vasos|default:"0" }}</span> /
                        <span id="meta-vasos-display">{{ registro_agua.meta_vasos|default:"8" }}</span>
                    </p>
                </div>
                {% if es_invitado %}
            </div>{% endif %}
        </div>

        <div class="card-custom p-4 mb-4 border-start border-4 border-success position-relative"
            style="border-color: var(--primary) !important;">
            {% if es_invitado %}
            <div class="lock-overlay">
                <span class="material-symbols-outlined fs-2 text-primary">lock</span>
            </div>
            <div class="blur-preview">
                {% endif %}
                <div class="d-flex align-items-center gap-2 mb-3">
                    <span class="material-symbols-outlined fs-2" style="color: var(--primary);">bedtime</span>
                    <h4 class="fw-900 h5 mb-0">Sue침o</h4>
                </div>
            </div>

            <!-- SECCI칍N DE HORARIOS DE SUE칌O -->
            <div class="sleep-input-group mb-4">
                <div class="row g-3">
                    <div class="col-6">
                        <div
                            class="p-3 bg-light rounded-4 border border-opacity-10 text-center position-relative overflow-hidden">
                            <span
                                class="material-symbols-outlined position-absolute top-0 start-0 m-2 text-muted opacity-25">bedtime</span>
                            <label class="x-small fw-bold text-muted text-uppercase d-block mb-2">Dormir</label>
                            <input type="time" id="sleep-start"
                                class="form-control form-control-lg fw-900 text-center bg-transparent border-0 p-0 fs-3"
                                style="color: var(--bg-dark-elite);" value="23:00" onchange="calculateSleep()">
                        </div>
                    </div>
                    <div class="col-6">
                        <div
                            class="p-3 bg-light rounded-4 border border-opacity-10 text-center position-relative overflow-hidden">
                            <span
                                class="material-symbols-outlined position-absolute top-0 start-0 m-2 text-muted opacity-25">wb_sunny</span>
                            <label class="x-small fw-bold text-muted text-uppercase d-block mb-2">Despertar</label>
                            <input type="time" id="sleep-end"
                                class="form-control form-control-lg fw-900 text-center bg-transparent border-0 p-0 fs-3"
                                style="color: var(--bg-dark-elite);" value="07:00" onchange="calculateSleep()">
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mb-4">
                <span class="badge bg-dark px-4 py-2 rounded-pill shadow-sm">
                    <span class="text-white opacity-75 fw-normal me-1">Total Calculado:</span>
                    <span class="text-white fw-900 fs-5 align-middle" id="sleep-total-display">8.0</span>
                    <span class="text-white opacity-75 small fw-bold">horas</span>
                </span>
                <input type="hidden" id="sleep-slider" value="8.0"> <!-- Hidden input para compatibilidad JS -->
            </div>


            <div class="mb-4">
                <label class="small fw-bold mb-2 text-muted text-uppercase" style="letter-spacing: 1px;">Nivel de
                    Energ칤a</label>
                <div class="d-flex justify-content-between gap-1 p-1 rounded-4 bg-light" id="energy-selector"
                    style="border: 1px solid rgba(0,0,0,0.05);">
                    {% for i in "12345"|make_list %}
                    <input type="radio" class="btn-check" name="energy-level" id="energy-{{ i }}" value="{{ i }}" {% if sueno_hoy.calidad|slugify == i %}checked{% elif not sueno_hoy and i == "3" %}checked{% endif %}>

                    <label
                        class="btn btn-sm btn-outline-light border-0 flex-grow-1 py-2 rounded-3 text-dark fw-bold position-relative overflow-hidden energy-btn"
                        for="energy-{{ i }}" onclick="selectEnergy(this)" style="transition: all 0.2s ease;">

                        <span class="position-relative z-1 d-block fs-4 mb-1">
                            {% if i == "1" %}游땺{% elif i == "2" %}游땱{% elif i == "3" %}游땛{% elif i == "4" %}游땕{% elif i == "5" %}游{% endif %}
                        </span>

                        <span class="d-block x-small lh-1 opacity-75">
                            {% if i == "1" %}Baja{% elif i == "2" %}Leve{% elif i == "3" %}Normal{% elif i == "4" %}Bien{% elif i == "5" %}Excelente{% endif %}
                        </span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="mt-3 text-center mb-3">
                <p class="small text-muted mb-0 fst-italic" id="sleep-status">
                    {% if sueno_hoy %}춰Registro de hoy guardado!{% else %}Registra tu sue침o de anoche{% endif %}
                </p>
            </div>

            <button
                class="btn btn-success w-100 py-3 rounded-4 fw-bold shadow-sm d-flex align-items-center justify-content-center gap-2"
                style="background: var(--primary-elite); border: none;" onclick="saveSleep()">
                <span class="material-symbols-outlined">save</span>
                Guardar Registro
            </button>
            {% if es_invitado %}
        </div>{% endif %}
</div>

<div class="card-custom p-4 border-dashed position-relative"
    style="background: linear-gradient(145deg, var(--bg-light-elite), white); border-color: rgba(133, 200, 26, 0.2);">
    {% if es_invitado %}
    <div class="lock-overlay">
        <span class="material-symbols-outlined fs-2 text-primary">lock</span>
        <a href="{% url 'base:registro' %}" class="btn btn-sm btn-dark rounded-pill mt-2">Crear Cuenta</a>
    </div>
    <div class="blur-preview">
        {% endif %}
        <h4 class="fw-900 h5 mb-4 text-brand">An치lisis Semanal</h4>

        <div class="d-flex justify-content-between mb-3 border-bottom pb-3"
            style="border-color: rgba(0,0,0,0.05) !important;">
            <div>
                <span class="text-muted small fw-bold text-uppercase d-block mb-1">Consumo Diario</span>
                <h5 class="fw-900 mb-0">{{ analisis_semanal.calorias }} <small
                        class="text-muted fs-6 fw-normal">kcal</small></h5>
            </div>
            <div class="text-center d-flex align-items-center">
                <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-2 py-1">Avg 7
                    d칤as</span>
            </div>
        </div>

        <div class="d-flex justify-content-between mb-4 border-bottom pb-3"
            style="border-color: rgba(0,0,0,0.05) !important;">
            <div>
                <span class="text-muted small fw-bold text-uppercase d-block mb-1">Descanso</span>
                <h5 class="fw-900 mb-0">{{ analisis_semanal.sueno }} <small
                        class="text-muted fs-6 fw-normal">horas</small></h5>
            </div>
            <div class="text-center d-flex align-items-center">
                <span class="badge bg-info bg-opacity-10 text-info rounded-pill px-2 py-1">Avg 7 d칤as</span>
            </div>
        </div>

        <button class="btn btn-outline-success w-100 py-3 text-xs-bold rounded-4"
            style="border-color: var(--primary-elite); color: var(--primary-dark-elite);" onclick="downloadReport()">
            <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 20px;">download</span>
            Descargar Informe PDF
        </button>
        {% if es_invitado %}
    </div>{% endif %}
</div>
<script>
    function toggleFavorite(recetaId, btn) {
        const icon = btn.querySelector('.material-symbols-outlined');
        fetch(`/api/toggle_favorito/${recetaId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    if (data.is_favorite) {
                        btn.classList.add('active');
                        icon.classList.remove('text-muted');
                        icon.classList.add('text-primary');
                        showToast('A침adido a favoritos', 'success');
                    } else {
                        btn.classList.remove('active');
                        icon.classList.remove('text-primary');
                        icon.classList.add('text-muted');
                        showToast('Eliminado de favoritos', 'info');
                    }
<<<<<<< HEAD
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            if (data.is_favorite) {
                                btn.classList.add('active');
                                icon.classList.remove('text-muted');
                                icon.classList.add('text-primary');
                                showToast('A침adido a favoritos', 'success');
                            } else {
                                btn.classList.remove('active');
                                icon.classList.remove('text-primary');
                                icon.classList.add('text-muted');
                                showToast('Eliminado de favoritos', 'info');
                            }
                        } else {
                            showToast('Debes iniciar sesi칩n para guardar favoritos', 'warning');
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        showToast('Error al procesar favoritos', 'error');
                    });
            }
        </script>

        <script>
            // Usamos el objeto window para evitar errores de "already declared" con let/const
            window.currentWater = parseInt("{{ registro_agua.cantidad_vasos|default:0 }}");
            window.metaWater = parseInt("{{ registro_agua.meta_vasos|default:8 }}");

            // Envolvemos todo en una funci칩n global para que no se duplique
            window.renderGlasses = function() {
                const container = document.getElementById('water-glasses-container');
                if (!container) return;

                container.innerHTML = '';
                for (let i = 1; i <= window.metaWater; i++) {
                    const glass = document.createElement('span');
                    glass.className = `material-symbols-outlined water-glass ${i <= window.currentWater ? 'active' : ''}`;
                    glass.innerText = 'local_drink';
                    container.appendChild(glass);
                }
            };

            window.updateWater = function(cambio) {
                {% if es_invitado %}
                showToast('Reg칤strate para guardar tu hidrataci칩n', 'info');
                return;
                {% endif %}

                const nuevoValor = Math.max(0, window.currentWater + cambio);
                if (nuevoValor === window.currentWater && cambio !== 0) return;

                fetch('/api/actualizar_agua/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cambio: cambio })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.currentWater = data.cantidad_vasos;
                        window.metaWater = data.meta_vasos;
                        
                        document.getElementById('water-liters').innerText = data.litros.toFixed(1);
                        document.getElementById('meta-liters-display').innerText = (data.meta_vasos * 0.25).toFixed(1);
                        document.getElementById('water-percentage').innerText = data.porcentaje + '% Meta';
                        document.getElementById('current-vasos-display').innerText = data.cantidad_vasos;
                        document.getElementById('meta-vasos-display').innerText = data.meta_vasos;
                        
                        window.renderGlasses();

                        if (cambio > 0) {
                            showToast('춰Vaso registrado! 游눦', 'success');
                        }
                    }
                })
                .catch(err => {
                    console.error(err);
                    showToast('Error al actualizar agua', 'error');
                });
            };

            // Ejecuci칩n inicial segura
            if (document.readyState === 'complete') {
                window.renderGlasses();
            }
        </script>
    </aside>
=======
                } else {
                    showToast('Debes iniciar sesi칩n para guardar favoritos', 'warning');
                }
            })
            .catch(err => {
                console.error(err);
                showToast('Error al procesar favoritos', 'error');
            });
    }
</script>

<!-- Datos para JavaScript (Patr칩n seguro para evitar errores de linter) -->
<div id="page-data" style="display: none;" data-is-guest="{{ es_invitado|yesno:'true,false' }}"
    data-csrf-token="{{ csrf_token }}" data-has-report="{% if informe %}true{% else %}false{% endif %}"
    data-water-current="{{ registro_agua.cantidad_vasos|default:0 }}"
    data-water-meta="{{ registro_agua.meta_vasos|default:8 }}"
    data-goal-cals="{{ informe.plan.calorias_dia|default:2000 }}"
    data-goal-prot="{{ informe.plan.proteinas_g|default:150 }}"
    data-goal-carb="{{ informe.plan.carbohidratos_g|default:200 }}"
    data-goal-fat="{{ informe.plan.grasas_g|default:60 }}">
</div>

<script>
    // Leer configuraci칩n desde el DOM
    const pageData = document.getElementById('page-data').dataset;

    // Estado global de la aplicaci칩n
    window.appState = {
        isGuest: pageData.isGuest === 'true',
        csrfToken: pageData.csrfToken,
        hasReport: pageData.hasReport === 'true',
        goals: {
            cals: parseInt(pageData.goalCals),
            prot: parseInt(pageData.goalProt),
            carb: parseInt(pageData.goalCarb),
            fat: parseInt(pageData.goalFat)
        }
    };

    // Usamos el objeto window para evitar errores de "already declared" con let/const
    window.currentWater = parseInt(pageData.waterCurrent);
    window.metaWater = parseInt(pageData.waterMeta);

    // Envolvemos todo en una funci칩n global para que no se duplique
    window.renderGlasses = function () {
        const container = document.getElementById('water-glasses-container');
        if (!container) return;

        container.innerHTML = '';
        for (let i = 1; i <= window.metaWater; i++) {
            const glass = document.createElement('span');
            glass.className = `material-symbols-outlined water-glass ${i <= window.currentWater ? 'active' : ''}`;
            glass.innerText = 'local_drink';
            container.appendChild(glass);
        }
    };

    window.updateWater = function (cambio) {
        if (window.appState.isGuest) {
            showToast('Reg칤strate para guardar tu hidrataci칩n', 'info');
            return;
        }

        const nuevoValor = Math.max(0, window.currentWater + cambio);
        if (nuevoValor === window.currentWater && cambio !== 0) return;

        fetch('/api/actualizar_agua/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': window.appState.csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cambio: cambio })
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    window.currentWater = data.cantidad_vasos;
                    window.metaWater = data.meta_vasos;

                    document.getElementById('water-liters').innerText = data.litros.toFixed(1);
                    document.getElementById('meta-liters-display').innerText = (data.meta_vasos * 0.25).toFixed(1);
                    document.getElementById('water-percentage').innerText = data.porcentaje + '% Meta';
                    document.getElementById('current-vasos-display').innerText = data.cantidad_vasos;
                    document.getElementById('meta-vasos-display').innerText = data.meta_vasos;

                    window.renderGlasses();

                    if (cambio > 0) {
                        showToast('춰Vaso registrado! 游눦', 'success');
                    }
                }
            })
            .catch(err => {
                console.error(err);
                showToast('Error al actualizar agua', 'error');
            });
    };

    // Ejecuci칩n inicial segura
    if (document.readyState === 'complete') {
        window.renderGlasses();
    } else {
        document.addEventListener('DOMContentLoaded', window.renderGlasses);
    }
</script>

<script>
    // ========== C츼LCULO DE CONSUMO DIARIO ==========
    window.loadDailyConsumption = function () {
        // Si es invitado o no hay informe, no hacemos nada
        if (window.appState.isGuest || !window.appState.hasReport) return;

        // Obtener comidas del d칤a desde la API
        fetch('/api/comidas_hoy/', {
            headers: {
                'X-CSRFToken': window.appState.csrfToken
            }
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    const consumo = data.consumo;
                    const metas = {
                        calorias: window.appState.goals.cals,
                        proteinas: window.appState.goals.prot,
                        carbos: window.appState.goals.carb,
                        grasas: window.appState.goals.fat
                    };

                    // Actualizar calor칤as
                    const calPct = Math.min(Math.round((consumo.calorias / metas.calorias) * 100), 100);
                    const calEl = document.getElementById('calorias-consumidas');
                    if (calEl) {
                        calEl.innerText = consumo.calorias;
                        document.getElementById('porcentaje-calorias').innerText = calPct + '%';
                        document.getElementById('progress-calorias').style.width = calPct + '%';
                    }

                    // Actualizar macros con animaci칩n
                    updateMacroCircle('proteina', consumo.proteinas, metas.proteinas);
                    updateMacroCircle('carbos', consumo.carbos, metas.carbos);
                    updateMacroCircle('grasas', consumo.grasas, metas.grasas);
                }
            })
            .catch(err => console.error('Error cargando consumo:', err));
    };

    function updateMacroCircle(macro, consumido, meta) {
        const pct = Math.min(Math.round((consumido / meta) * 100), 100);
        const circle = document.getElementById('circle-' + macro);
        const pctSpan = document.getElementById('pct-' + macro);
        const consumoSpan = document.getElementById('consumo-' + macro);

        if (circle && pctSpan && consumoSpan) {
            // Calcular stroke-dashoffset (226 es la circunferencia)
            const offset = 226 - (226 * pct / 100);

            // Animar el c칤rculo
            setTimeout(() => {
                circle.style.strokeDashoffset = offset;
            }, 100);

            // Actualizar textos
            pctSpan.innerText = pct;
            consumoSpan.innerText = consumido;
        }
    }

    // ========== FUNCIONES DE SUE칌O ==========
    window.updateSleepDisplay = function (val) {
        val = parseFloat(val);
        const display = document.getElementById('sleep-display');
        if (display) display.innerHTML = val + '<span class="fs-4 text-muted">h</span>';
        const slider = document.getElementById('sleep-slider');
        if (slider) slider.value = val;
    };

    // Nueva funci칩n para calcular horas de sue침o desde inputs time
    window.calculateSleep = function () {
        const startInput = document.getElementById('sleep-start');
        const endInput = document.getElementById('sleep-end');
        const slider = document.getElementById('sleep-slider');

        if (!startInput || !endInput) return;

        // Parsear horas
        let start = startInput.value;
        let end = endInput.value;

        // Crear fechas arbitrarias para comparar
        let dateStart = new Date(`2000-01-01T${start}`);
        let dateEnd = new Date(`2000-01-01T${end}`);

        // Si la hora de fin es menor, asumimos que es al d칤a siguiente
        if (dateEnd <= dateStart) {
            dateEnd.setDate(dateEnd.getDate() + 1);
        }

        // Diferencia en horas
        let diff = (dateEnd - dateStart) / (1000 * 60 * 60);

        // Redondear a un decimal
        let total = Math.round(diff * 10) / 10;

        // Actualizar UI
        const display = document.getElementById('sleep-total-display');
        if (display) display.innerText = total;
        if (slider) slider.value = total;
    };

    window.adjustSleep = function (val) {
        // Legacy support or empty
    };

    // Override saveSleep para usar el nuevo valor
    window.saveSleep = function () {
        if (window.appState.isGuest) {
            showToast('Funci칩n exclusiva para usuarios registrados', 'info');
            return;
        }

        const slider = document.getElementById('sleep-slider');
        const hours = parseFloat(slider.value); // Calculado por calculateSleep

        const qualityInput = document.querySelector('input[name="energy-level"]:checked');
        const quality = qualityInput ? parseInt(qualityInput.value) : 3;

        // Animaci칩n de guardado
        const btn = document.querySelector('button[onclick="saveSleep()"]');
        const originalText = btn ? btn.innerHTML : '';
        if (btn) {
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';
            btn.disabled = true;
        }

        fetch('/api/guardar_sueno/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.appState.csrfToken
            },
            body: JSON.stringify({ horas: hours, calidad: quality })
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('춰Buenas noches! Registro guardado 游깿', 'success');
                    const status = document.getElementById('sleep-status');
                    if (status) {
                        status.innerText = '춰Registro Completado!';
                        status.className = 'small text-success fw-bold mb-0';
                    }
                } else {
                    showToast('Error: ' + data.message, 'error');
                }
            })
            .catch(err => showToast('Error de conexi칩n', 'error'))
            .finally(() => {
                if (btn) {
                    btn.innerHTML = '<span class="material-symbols-outlined">check</span> Guardado';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 2000);
                }
            });
    };

    window.selectEnergy = function (label) {
        // Feedback visual ya manejado por CSS
    };

    window.downloadReport = function () {
        if (window.appState.isGuest) {
            showToast('Reg칤strate para descargar tu informe', 'info');
            return;
        }

        showToast('Generando informe...', 'info');

        fetch('/api/generar_informe_pdf/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': window.appState.csrfToken
            }
        })
            .then(res => {
                if (res.ok) {
                    return res.blob();
                }
                throw new Error('Error al generar PDF');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `informe_nunut_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                showToast('춰Informe descargado! 游늯', 'success');
            })
            .catch(err => {
                console.error(err);
                showToast('Error al generar informe', 'error');
            });
    };

    // ========== INICIALIZACI칍N ==========
    document.addEventListener('DOMContentLoaded', function () {
        if (window.loadDailyConsumption) window.loadDailyConsumption();
        if (window.renderGlasses) window.renderGlasses();
        if (window.calculateSleep) window.calculateSleep();
    });

</script>
</aside>
>>>>>>> 1bfdbbe (m치s avances)
</div>
{% endblock %}