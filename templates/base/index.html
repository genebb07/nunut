{% extends base_template %}
{% load static %}

{% block title %}Inicio | nunut{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
    rel="stylesheet" />

<style>
    :root {
        --primary-elite: #85c81a;
        --primary-dark-elite: #6fb015;
        --bg-light-elite: #f7f8f6;
        --bg-dark-elite: #1b2111;
    }

    /* Evitar conflictos con base.html pero mantener el look de index.html */
    .dashboard-elite {
        font-family: 'Inter', sans-serif;
    }

    /* Utilidades Personalizadas */
    .rounded-4 {
        border-radius: 1.5rem !important;
    }

    .card-custom {
        background: var(--bg-content);
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 1.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        overflow: hidden;
        box-sizing: border-box;
    }

    body.dark-mode .card-custom {
        border-color: rgba(255, 255, 255, 0.1);
    }

    .hero-card {
        background: linear-gradient(135deg, var(--primary-elite), var(--primary-dark-elite));
        color: white;
        border: none;
        box-shadow: 0 1rem 3rem rgba(133, 200, 26, 0.2);
    }

    .glass-inner {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
    }

    /* Iconos con fondo suave */
    .icon-box {
        padding: 0.75rem;
        border-radius: 1rem;
        display: inline-flex;
    }

    /* Grid de hidrataci√≥n */
    .water-grid .col-auto {
        flex: 1;
        height: 48px;
        border-radius: 8px;
    }

    /* Im√°genes de comida */
    .meal-img {
        height: 160px;
        background-size: cover;
        background-position: center;
        transition: transform 0.5s ease;
    }

    .card-custom:hover .meal-img {
        transform: scale(1.05);
    }

    /* Gr√°ficos circulares SVG */
    .svg-chart {
        transform: rotate(-90deg);
    }

    /* Ajustes de texto */
    .text-xs-bold {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Guest Mode Styles */
    .blur-preview {
        filter: blur(8px);
        user-select: none;
        pointer-events: none;
        opacity: 0.6;
    }

    .lock-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(4px);
        z-index: 10;
        border-radius: 1.5rem;
    }

    body.dark-mode .lock-overlay {
        background: rgba(0, 0, 0, 0.4);
    }

    .position-relative {
        position: relative !important;
    }

    /* Glass Icons */
    .water-glass {
        color: #e2e8f0;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    .water-glass.active {
        color: #3abff8;
        transform: scale(1.2) translateY(-2px);
        filter: drop-shadow(0 4px 8px rgba(58, 191, 248, 0.3));
        font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    .btn-water {
        border: 2px solid #3abff8;
        color: #3abff8;
        background: transparent;
        width: 36px;
        height: 36px;
        transition: all 0.2s;
    }

    .btn-water:hover {
        background: #3abff8;
        color: white;
        transform: scale(1.1);
    }

    .dark-mode .water-glass {
        color: #2c2f26;
    }

    .dark-mode .water-glass.active {
        color: #3abff8;
    }
</style>
{% endblock %}

{% block container_class %}container max-w-7xl dashboard-elite{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-5 mt-2">
    <div class="d-flex align-items-center gap-3">
        <div class="rounded-circle border border-2 border-success p-1 shadow-sm" style="width: 62px; height: 62px;">
            {% if user.is_authenticated and user.perfil.foto_perfil %}
            <img src="data:image/png;base64,{{ user.perfil.get_foto_base64 }}" class="rounded-circle w-100 h-100"
                style="object-fit: cover;">
            {% else %}
            <div class="w-100 h-100 rounded-circle bg-success-subtle d-flex align-items-center justify-content-center fw-bold"
                style="color: var(--primary);">
                {{ user.username.0|upper }}
            </div>
            {% endif %}
        </div>
        <div>
            {% if es_invitado %}
            <h2 class="text-xs-bold text-muted mb-0">Modo Invitado</h2>
            <p class="h3 fw-900 mb-0" style="font-weight: 900;">Vista Previa</p>
            {% else %}
            <h2 class="text-xs-bold text-muted mb-0">¬°Hola de nuevo, {{ user.first_name|default:user.username }}!</h2>
            <p class="h3 fw-900 mb-0" style="font-weight: 900;">Dashboard Nutricional</p>
            {% endif %}
        </div>
    </div>
    <div class="d-none d-md-flex align-items-center gap-3 card-custom px-4 py-2 shadow-sm"
        style="border: 1px solid rgba(0, 0, 0, 0.08); box-sizing: border-box;">
        <span class="material-symbols-outlined fs-2" style="color: var(--primary);">local_fire_department</span>
        <div>
            <p class="text-xs-bold text-muted mb-0">Racha Actual</p>
            <span class="fw-bold fs-5" id="streak-counter">{{ mensaje_racha|default:"¬°Comienza hoy!" }}</span>
        </div>
    </div>
</div>

<div class="row g-4">
    <main class="col-lg-8">
        {% if informe %}
        <section class="card-custom hero-card p-4 p-md-5 mb-4 position-relative">
            {% if es_invitado %}
            <div class="lock-overlay">
                <span class="material-symbols-outlined fs-2 text-white mb-2">lock</span>
                <span class="badge bg-white text-dark rounded-pill fw-bold border-0 px-3 py-2">AN√ÅLISIS DE
                    CALOR√çAS</span>
            </div>
            <div class="blur-preview">
                {% endif %}
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <p class="text-xs-bold text-white-50 mb-1">Calor√≠as Restantes</p>
                        <h3 class="display-3 fw-900 mb-4" style="font-weight: 900;">{{ informe.plan.calorias_dia }}
                            <small class="fs-4 fw-normal opacity-75">kcal</small>
                        </h3>

                        <div class="mb-2 d-flex justify-content-between text-xs-bold opacity-75">
                            <span>Consumido: 0 kcal</span>
                            <span>Objetivo: {{ informe.plan.calorias_dia }} kcal</span>
                        </div>
                        <div class="progress"
                            style="height: 12px; border-radius: 10px; background: rgba(255,255,255,0.2);">
                            <div class="progress-bar bg-white shadow-sm" style="width: 0%; border-radius: 10px;"></div>
                        </div>
                    </div>
                    <div class="col-md-4 d-flex justify-content-center mt-4 mt-md-0">
                        <div class="position-relative" style="width: 170px; height: 170px;">
                            <svg class="svg-chart w-100 h-100">
                                <circle cx="85" cy="85" r="75" fill="none" stroke="rgba(255,255,255,0.2)"
                                    stroke-width="12">
                                </circle>
                                <circle cx="85" cy="85" r="75" fill="none" stroke="white" stroke-width="12"
                                    stroke-dasharray="471" stroke-dashoffset="471" stroke-linecap="round"></circle>
                            </svg>
                            <div class="position-absolute top-50 start-50 translate-middle glass-inner d-flex flex-column align-items-center justify-content-center"
                                style="width: 130px; height: 130px;">
                                <span class="h2 fw-900 mb-0">0%</span>
                                <span class="text-xs-bold" style="font-size: 0.6rem;">Meta Diaria</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% if es_invitado %}
            </div>{% endif %}
        </section>

        <h3 class="h5 fw-900 mb-4">Distribuci√≥n de Macros</h3>
        <div class="position-relative">
            {% if es_invitado %}
            <div class="lock-overlay" style="z-index: 20;">
                <span class="material-symbols-outlined fs-1 text-primary mb-2">lock</span>
                <span class="badge bg-dark text-white rounded-pill fw-bold border-0 px-3 py-2">MACRONUTRIENTES</span>
            </div>
            <div class="blur-preview">
                {% endif %}
                <div class="row row-cols-2 row-cols-lg-4 g-3 mb-5">
                    <div class="col">
                        <div class="card-custom p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="icon-box bg-primary-subtle text-primary">
                                    <span class="material-symbols-outlined">fitness_center</span>
                                </div>
                                <span class="text-xs-bold text-muted">{{ informe.porcentajes.prot_pct }}%</span>
                            </div>
                            <h4 class="h3 fw-900 mb-0">{{ informe.plan.proteinas_g }}g</h4>
                            <p class="text-muted small fw-bold">Prote√≠na</p>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-primary" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card-custom p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="icon-box bg-warning-subtle text-warning">
                                    <span class="material-symbols-outlined">bakery_dining</span>
                                </div>
                                <span class="text-xs-bold text-muted">{{ informe.porcentajes.carbs_pct }}%</span>
                            </div>
                            <h4 class="h3 fw-900 mb-0">{{ informe.plan.carbohidratos_g }}g</h4>
                            <p class="text-muted small fw-bold">Carbos</p>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-warning" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card-custom p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="icon-box bg-danger-subtle text-danger">
                                    <span class="material-symbols-outlined">oil_barrel</span>
                                </div>
                                <span class="text-xs-bold text-muted">{{ informe.porcentajes.grasa_pct }}%</span>
                            </div>
                            <h4 class="h3 fw-900 mb-0">{{ informe.plan.grasas_g }}g</h4>
                            <p class="text-muted small fw-bold">Grasas</p>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-danger" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card-custom p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="icon-box bg-success-subtle" style="color: var(--primary);">
                                    <span class="material-symbols-outlined">eco</span>
                                </div>
                                <span class="text-xs-bold text-muted">OBJ</span>
                            </div>
                            <h4 class="h3 fw-900 mb-0">{{ user.perfil.get_objetivo_display|default:"Salud" }}</h4>
                            <p class="text-muted small fw-bold">Meta</p>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success"
                                    style="width: 100%; background-color: var(--primary) !important;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                {% if es_invitado %}
            </div>{% endif %}
        </div>
        {% else %}
        <div class="card-custom p-5 text-center mb-4">
            <span class="material-symbols-outlined display-1 text-muted mb-3">clinical_notes</span>
            <h3 class="fw-900">Perfil Incompleto</h3>
            <p class="text-muted">Necesitamos conocer tu altura, peso y edad para calcular tu plan nutricional elite.
            </p>
            <a href="{% url 'base:perfil' %}" class="btn btn-success rounded-pill px-4 py-2 fw-bold"
                style="background-color: var(--primary); border-color: var(--primary);">Completar
                Perfil</a>
        </div>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="h5 fw-900 mb-0">Comidas Sugeridas</h3>
            <a href="{% url 'base:planes' %}" hx-get="{% url 'base:planes' %}" hx-target="#main-content"
                hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true"
                class="fw-bold text-decoration-none small" style="color: var(--primary);">Ver plan completo</a>
        </div>
        <div class="row g-3">
            {% for receta in recetas_sugeridas %}
            <div class="col-6 col-md-3">
                <div class="card-custom h-100 position-relative overflow-hidden shadow-sm"
                    style="transition: transform 0.3s ease;">
                    <div class="meal-img position-relative"
                        style="background-image: url('{% if receta.imagen_url %}{{ receta.imagen_url }}{% else %}https://images.unsplash.com/photo-1495521821757-a1efb6729352?w=300{% endif %}'); height: 120px; background-size: cover; background-position: center;">

                        <button
                            class="favorite-btn position-absolute {% if receta.id in favoritas_ids %}active{% endif %}"
                            style="top: 8px; right: 8px; width: 30px; height: 30px; border-radius: 50%; border: none; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 5;"
                            onclick="toggleFavorite({{ receta.id }}, this)">
                            <span
                                class="material-symbols-outlined fs-6 {% if receta.id in favoritas_ids %}text-primary{% else %}text-muted{% endif %}">favorite</span>
                        </button>

                        <div class="position-absolute bottom-0 start-0 w-100 p-2 bg-dark bg-opacity-50">
                            <span class="text-white fw-bold" style="font-size: 0.6rem; letter-spacing: 1px;">{{
                                receta.get_tipo_dieta_display|upper }}</span>
                        </div>
                    </div>
                    <div class="p-3">
                        <p class="fw-bold mb-1 text-truncate" style="font-size: 0.9rem;">{{ receta.titulo }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small fw-bold">{{ receta.calorias }} kcal</span>
                            <a href="{% url 'base:planes' %}?receta={{ receta.id }}"
                                class="btn btn-primary btn-sm rounded-circle d-flex align-items-center justify-content-center"
                                style="width: 25px; height: 25px; background-color: var(--primary); border: none;">
                                <span class="material-symbols-outlined"
                                    style="font-size: 14px; color: white;">arrow_forward</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </main>

    <aside class="col-lg-4">
        <!-- SECCI√ìN DE RECOMENDACIONES IA PREMIUM -->
        <div class="card-custom p-4 mb-4 border-0 shadow-lg position-relative overflow-hidden"
            style="background: linear-gradient(135deg, #12140d 0%, #1e2615 100%);">
            <!-- Glass Background Decor -->
            <div class="position-absolute"
                style="top: -20px; right: -20px; width: 100px; height: 100px; background: var(--primary); filter: blur(60px); opacity: 0.3;">
            </div>

            <div class="d-flex align-items-center gap-3 mb-3 position-relative" style="z-index: 2;">
                <div class="d-flex align-items-center justify-content-center"
                    style="width: 48px; height: 48px; border-radius: 12px; background: rgba(133, 200, 26, 0.15);">
                    <span class="material-symbols-outlined text-primary fs-3">psychology</span>
                </div>
                <div>
                    <h4 class="fw-800 h6 mb-0 text-white" style="letter-spacing: 0.5px;">Coach IA nunut</h4>
                    <span class="text-xs-bold text-primary" style="font-size: 0.6rem; opacity: 0.8;">An√°lisis
                        Activo</span>
                </div>
            </div>

            <div id="ia-recommendation-container" class="position-relative mb-3" style="z-index: 2;">
                <p class="small text-white opacity-90 mb-0 ps-2 italic lh-base" id="ia-message"
                    style="font-size: 0.85rem; font-weight: 500; border-left: 2px solid var(--primary);">
                    {{ recomendacion_ia }}
                </p>
            </div>

            <div class="d-flex gap-2 mb-0" style="z-index: 2; position: relative;">
                <span
                    class="badge rounded-pill bg-primary bg-opacity-20 text-white x-small fw-bold border border-white border-opacity-10"
                    style="font-size: 0.6rem; padding: 4px 10px; letter-spacing: 0.5px;">#INTELIGENCIA-VITAL</span>
                <span
                    class="badge rounded-pill bg-primary bg-opacity-40 text-white x-small fw-bold border border-primary border-opacity-10"
                    style="font-size: 0.6rem; padding: 4px 10px; letter-spacing: 0.5px;">#NUNUT-ELITE</span>
            </div>
        </div>

        <style>
            @keyframes pulse-soft {
                0% {
                    transform: scale(0.95);
                    opacity: 0.2;
                }

                50% {
                    transform: scale(1.05);
                    opacity: 0.4;
                }

                100% {
                    transform: scale(0.95);
                    opacity: 0.2;
                }
            }

            .animate-pulse {
                animation: pulse-soft 2s infinite ease-in-out;
            }
        </style>

        <div class="card-custom p-4 mb-4 border-start border-4 border-info position-relative overflow-hidden"
            style="border-color: #3abff8 !important; background: linear-gradient(145deg, var(--bg-content), rgba(58, 191, 248, 0.05));">
            {% if es_invitado %}
            <div class="lock-overlay">
                <span class="material-symbols-outlined fs-2 text-info">lock</span>
            </div>
            <div class="blur-preview">
                {% endif %}
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex align-items-center gap-2">
                        <div class="bg-info bg-opacity-10 p-2 rounded-circle">
                            <span class="material-symbols-outlined text-info fs-3">water_drop</span>
                        </div>
                        <h4 class="fw-900 h5 mb-0">Hidrataci√≥n</h4>
                    </div>
                    <span class="badge bg-info bg-opacity-20 text-white rounded-pill text-xs-bold px-3 py-2"
                        id="water-percentage">
                        {{ registro_agua.porcentaje|default:"0" }} % Meta
                    </span>
                </div>

                <div class="d-flex align-items-center justify-content-center gap-4 mb-4">
                    <button class="btn btn-water rounded-circle d-flex align-items-center justify-content-center p-0"
                        onclick="updateWater(-1)">
                        <span class="material-symbols-outlined fs-5">remove</span>
                    </button>

                    <div class="d-flex flex-wrap justify-content-center gap-2" id="water-glasses-container"
                        style="max-width: 180px;">
                        <!-- JS generar√° los vasos -->
                    </div>

                    <button class="btn btn-water rounded-circle d-flex align-items-center justify-content-center p-0"
                        onclick="updateWater(1)">
                        <span class="material-symbols-outlined fs-5">add</span>
                    </button>
                </div>

                <div class="text-center">
                    <h4 class="h2 fw-900 mb-0">
                        <span id="water-liters">{{ registro_agua.litros|default:"0.0"|floatformat:1 }}</span>
                        <small class="text-muted h6">/ <span id="meta-liters-display">{{
                                registro_agua.meta_litros|default:"2.0" }}</span> Lts</small>
                    </h4>
                    <p class="text-xs-bold text-muted mb-0" id="water-status">
                        Vasos: <span id="current-vasos-display">{{ registro_agua.cantidad_vasos|default:"0" }}</span> /
                        <span id="meta-vasos-display">{{ registro_agua.meta_vasos|default:"8" }}</span>
                    </p>
                </div>
                {% if es_invitado %}
            </div>{% endif %}
        </div>

        <div class="card-custom p-4 mb-4 border-start border-4 border-success position-relative"
            style="border-color: var(--primary) !important;">
            {% if es_invitado %}
            <div class="lock-overlay">
                <span class="material-symbols-outlined fs-2 text-primary">lock</span>
            </div>
            <div class="blur-preview">
                {% endif %}
                <div class="d-flex align-items-center gap-2 mb-4">
                    <span class="material-symbols-outlined fs-2" style="color: var(--primary);">directions_walk</span>
                    <h4 class="fw-900 h5 mb-0">Pasos Diarios</h4>
                </div>
                <div class="d-flex align-items-center gap-4">
                    <div class="position-relative" style="width: 90px; height: 90px;">
                        <svg class="svg-chart w-100 h-100">
                            <circle cx="45" cy="45" r="40" fill="none" stroke="#eee" stroke-width="8"></circle>
                            <circle cx="45" cy="45" r="40" fill="none" stroke="#85c81a" stroke-width="8"
                                stroke-dasharray="251" stroke-dashoffset="62" stroke-linecap="round"></circle>
                        </svg>
                        <span class="position-absolute top-50 start-50 translate-middle fw-900">75%</span>
                    </div>
                    <div>
                        <h4 class="h2 fw-900 mb-0">7,542</h4>
                        <p class="small text-muted mb-1">Objetivo: 10,000</p>
                        <span class="small fw-bold" style="color: var(--primary);">‚Üë +12% vs ayer</span>
                    </div>
                </div>
                {% if es_invitado %}
            </div>{% endif %}
        </div>

        <div class="card-custom p-4 border-dashed position-relative"
            style="background: linear-gradient(145deg, var(--bg-light-elite), white); border-color: rgba(133, 200, 26, 0.2);">
            {% if es_invitado %}
            <div class="lock-overlay">
                <span class="material-symbols-outlined fs-2 text-primary">lock</span>
                <a href="{% url 'base:registro' %}" class="btn btn-sm btn-dark rounded-pill mt-2">Crear Cuenta</a>
            </div>
            <div class="blur-preview">
                {% endif %}
                <h4 class="fw-900 h5 mb-4 text-brand">An√°lisis Semanal</h4>
                <div class="d-flex justify-content-between mb-3 border-bottom pb-2"
                    style="border-color: rgba(0,0,0,0.05) !important;">
                    <span class="text-muted small fw-medium">Consumo promedio</span>
                    <span class="fw-bold">2,150 kcal</span>
                </div>
                <div class="d-flex justify-content-between mb-4 border-bottom pb-2"
                    style="border-color: rgba(0,0,0,0.05) !important;">
                    <span class="text-muted small fw-medium">Sue√±o promedio</span>
                    <span class="fw-bold">7h 45m</span>
                </div>
                <button class="btn btn-outline-success w-100 py-3 text-xs-bold rounded-4"
                    style="border-color: var(--primary-elite); color: var(--primary-dark-elite);">
                    Descargar Informe PDF
                </button>
                {% if es_invitado %}
            </div>{% endif %}
        </div>
        <script>
            function toggleFavorite(recetaId, btn) {
                const icon = btn.querySelector('.material-symbols-outlined');
                fetch(`/api/toggle_favorito/${recetaId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            if (data.is_favorite) {
                                btn.classList.add('active');
                                icon.classList.remove('text-muted');
                                icon.classList.add('text-primary');
                                showToast('A√±adido a favoritos', 'success');
                            } else {
                                btn.classList.remove('active');
                                icon.classList.remove('text-primary');
                                icon.classList.add('text-muted');
                                showToast('Eliminado de favoritos', 'info');
                            }
                        } else {
                            showToast('Debes iniciar sesi√≥n para guardar favoritos', 'warning');
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        showToast('Error al procesar favoritos', 'error');
                    });
            }
        </script>

        <script>
            // Usamos el objeto window para evitar errores de "already declared" con let/const
            window.currentWater = parseInt("{{ registro_agua.cantidad_vasos|default:0 }}");
            window.metaWater = parseInt("{{ registro_agua.meta_vasos|default:8 }}");

            // Envolvemos todo en una funci√≥n global para que no se duplique
            window.renderGlasses = function() {
                const container = document.getElementById('water-glasses-container');
                if (!container) return;

                container.innerHTML = '';
                for (let i = 1; i <= window.metaWater; i++) {
                    const glass = document.createElement('span');
                    glass.className = `material-symbols-outlined water-glass ${i <= window.currentWater ? 'active' : ''}`;
                    glass.innerText = 'local_drink';
                    container.appendChild(glass);
                }
            };

            window.updateWater = function(cambio) {
                {% if es_invitado %}
                showToast('Reg√≠strate para guardar tu hidrataci√≥n', 'info');
                return;
                {% endif %}

                const nuevoValor = Math.max(0, window.currentWater + cambio);
                if (nuevoValor === window.currentWater && cambio !== 0) return;

                fetch('/api/actualizar_agua/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cambio: cambio })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.currentWater = data.cantidad_vasos;
                        window.metaWater = data.meta_vasos;
                        
                        document.getElementById('water-liters').innerText = data.litros.toFixed(1);
                        document.getElementById('meta-liters-display').innerText = (data.meta_vasos * 0.25).toFixed(1);
                        document.getElementById('water-percentage').innerText = data.porcentaje + '% Meta';
                        document.getElementById('current-vasos-display').innerText = data.cantidad_vasos;
                        document.getElementById('meta-vasos-display').innerText = data.meta_vasos;
                        
                        window.renderGlasses();

                        if (cambio > 0) {
                            showToast('¬°Vaso registrado! üíß', 'success');
                        }
                    }
                })
                .catch(err => {
                    console.error(err);
                    showToast('Error al actualizar agua', 'error');
                });
            };

            // Ejecuci√≥n inicial segura
            if (document.readyState === 'complete') {
                window.renderGlasses();
            }
        </script>
    </aside>
</div>
{% endblock %}