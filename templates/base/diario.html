{% extends 'base.html' %}
{% load static %}

{% block title %}Resumen Diario | nunut{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet" />

<style>
    :root {
        --primary-color: #85c81a;
        --bg-light: #f7f8f6;
        --card-radius: 30px;
        --protein-color: #3b82f6;
        --carbs-color: #f97316;
        --fats-color: #eab308;
        --water-color: #0ea5e9;
        --fiber-color: #10b981;
    }

    /* Diario specific reset to override base.html body background if needed */
    #main-content {
        font-family: 'Manrope', sans-serif !important;
    }

    .fw-black {
        font-weight: 800;
    }

    .text-xs {
        font-size: 0.75rem;
    }

    /* Reemplazo de utilidades de Tailwind */
    .w-20 {
        width: 5rem;
    }

    .h-20 {
        height: 5rem;
    }

    .aspect-square {
        aspect-ratio: 1 / 1;
    }

    .meal-card {
        border-radius: var(--card-radius);
        border: none;
        background: white;
    }

    .btn-primary-custom {
        background-color: var(--primary-color);
        color: white;
        border-radius: 50px;
        font-weight: 800;
        padding: 12px 24px;
        border: none;
        width: 100%;
    }

    .btn-primary-custom:hover {
        background-color: #74b017;
        color: white;
    }

    .calendar-day.active {
        background-color: var(--primary-color);
        color: white !important;
        border-radius: 50%;
        font-weight: 800;
        box-shadow: 0 4px 12px rgba(133, 200, 26, 0.3);
    }

    .calorie-ring-container {
        position: relative;
        width: 180px;
        height: 180px;
        margin: 0 auto;
    }

    .calorie-ring svg {
        transform: rotate(-90deg);
    }

    .calorie-ring-bg {
        fill: none;
        stroke: #e2e8f0;
        stroke-width: 12;
    }

    .calorie-ring-progress {
        fill: none;
        stroke: var(--primary-color);
        stroke-width: 12;
        stroke-linecap: round;
        stroke-dasharray: 440;
        stroke-dashoffset: 198;
        transition: stroke-dashoffset 1s ease-out;
    }

    .calorie-ring-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .macro-card {
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 1.5rem;
        transition: all 0.3s ease;
    }

    .macro-card:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .micro-progress {
        height: 4px;
        border-radius: 2px;
        background-color: #f1f5f9;
        overflow: hidden;
    }

    /* Colores de fondo personalizados */
    .bg-blue-50 {
        background-color: #eff6ff;
    }

    .bg-orange-50 {
        background-color: #fff7ed;
    }

    .bg-yellow-50 {
        background-color: #fefce8;
    }

    .bg-emerald-50 {
        background-color: #ecfdf5;
    }

    .text-blue-500 {
        color: #3b82f6;
    }

    .text-orange-500 {
        color: #f97316;
    }

    .text-yellow-500 {
        color: #eab308;
    }

    .text-emerald-500 {
        color: #10b981;
    }
</style>
{% endblock %}

{% block container_class %}container py-5{% endblock %}

{% block content %}
<div id="diario-main-container" class="row g-4">
    <div class="col-lg-8">
        <!-- Calendario dinámico -->
        <section class="card meal-card p-4 shadow-sm mb-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <button class="btn btn-light rounded-circle p-2 d-flex align-items-center"
                    hx-get="{% url 'base:diario' %}?date={{ prev_week }}" hx-target="#diario-main-container"
                    hx-select="#diario-main-container" hx-push-url="true">
                    <span class="material-symbols-outlined">chevron_left</span>
                </button>
                <h2 class="h5 mb-0 fw-black">{{ mes_nombre|capfirst }}</h2>
                <button class="btn btn-light rounded-circle p-2 d-flex align-items-center"
                    hx-get="{% url 'base:diario' %}?date={{ next_week }}" hx-target="#diario-main-container"
                    hx-select="#diario-main-container" hx-push-url="true">
                    <span class="material-symbols-outlined">chevron_right</span>
                </button>
            </div>
            <div class="row text-center g-1">
                {% for dia in semana %}
                <div class="col">
                    <div class="text-xs fw-bold text-secondary mb-2">{{ dia.nombre }}</div>
                    <button
                        class="btn w-100 aspect-square d-flex align-items-center justify-content-center {% if dia.is_active %}calendar-day active{% else %}text-main{% endif %}"
                        hx-get="{% url 'base:diario' %}?date={{ dia.fecha_iso }}" hx-target="#diario-main-container"
                        hx-select="#diario-main-container" hx-push-url="true">
                        {{ dia.dia_num }}
                    </button>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- Listado de Comidas -->
        <section>
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="h4 mb-0 fw-black">Comidas del {{ current_date|date:"d M" }}</h2>
                <button class="btn btn-link text-decoration-none p-0 d-flex align-items-center gap-1"
                    style="color: var(--primary-color);">
                    <span class="material-symbols-outlined fs-5">add_circle</span>
                    <span class="fw-bold">Añadir Comida</span>
                </button>
            </div>

            <div class="d-flex flex-column gap-3">
                {% for comida in comidas %}
                <div class="meal-card p-3 shadow-sm d-flex align-items-center gap-3 border">
                    <div class="w-20 h-20 rounded-4 overflow-hidden flex-shrink-0">
                        <img alt="{{ comida.nombre }}" class="w-100 h-100 object-fit-cover"
                            src="{{ comida.imagen_url|default:'https://images.unsplash.com/photo-1490645935967-10de6ba17061?w=200&h=200&fit=crop' }}" />
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between">
                            <h3 class="h6 mb-1 fw-black">{{ comida.nombre }}</h3>
                            <span class="text-xs text-secondary fw-bold">{{ comida.hora|time:"H:i"|default:"--" }}</span>
                        </div>
                        <p class="text-xs text-secondary mb-0">
                            {{ comida.calorias }} kcal •
                            {{ comida.proteinas }}g Proteína •
                            {{ comida.carbos }}g Carbos
                        </p>
                    </div>
                    {% if comida.completada %}
                    <span class="material-symbols-outlined" style="color: var(--primary-color);">check_circle</span>
                    {% else %}
                    <span class="material-symbols-outlined text-muted">radio_button_unchecked</span>
                    {% endif %}
                </div>
                {% empty %}
                <div class="text-center py-5 opacity-50">
                    <span class="material-symbols-outlined fs-1">restaurant</span>
                    <p class="fw-bold mt-2">No hay comidas registradas para este día.</p>
                </div>
                {% endfor %}
            </div>
        </section>
    </div>

    <!-- Resumen lateral -->
    <div class="col-lg-4">
        <section class="card meal-card p-4 shadow mb-4 border-0">
            <h2 class="h5 fw-black mb-4 text-center">Resumen Diario</h2>
            <div class="calorie-ring-container mb-4">
                <div class="calorie-ring">
                    <svg height="180" width="180">
                        <circle class="calorie-ring-bg" cx="90" cy="90" r="70"></circle>
                        <circle class="calorie-ring-progress" cx="90" cy="90" r="70" stroke-opacity="0.9"
                            style="stroke-dashoffset: calc(440 - (440 * {{ progress.calorias|default:0 }}) / 100);">
                        </circle>
                    </svg>
                    <div class="calorie-ring-content">
                        <span class="d-block h2 fw-black mb-0">{{ consumo.calorias|default:0 }}</span>
                        <span class="text-xs text-secondary fw-bold text-uppercase">Consumidas</span>
                        <hr class="my-1 text-secondary opacity-25" />
                        <span class="text-sm fw-black" style="color: var(--primary-color);">
                            {% if progress.faltan_kcal > 0 %}Faltan {{ progress.faltan_kcal }}{% else %}Meta cumplida{% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <div class="d-flex flex-column gap-2 mb-4">
                <!-- Proteína -->
                <div class="macro-card p-3">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <div class="p-2 rounded-circle bg-blue-50 d-flex">
                                <span class="material-symbols-outlined text-blue-500 fs-5">fitness_center</span>
                            </div>
                            <span class="text-xs fw-bold text-secondary">Proteína</span>
                        </div>
                        <span class="text-sm fw-black">{{ consumo.proteinas|default:0 }}g / {{ plan.proteinas_g|default:0 }}g</span>
                    </div>
                    <div class="micro-progress">
                        <div class="h-100"
                            style="width: {{ progress.proteinas|default:0 }}%; background-color: var(--protein-color);">
                        </div>
                    </div>
                </div>

                <!-- Carbos -->
                <div class="macro-card p-3">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <div class="p-2 rounded-circle bg-orange-50 d-flex">
                                <span class="material-symbols-outlined text-orange-500 fs-5">energy_savings_leaf</span>
                            </div>
                            <span class="text-xs fw-bold text-secondary">Carbos</span>
                        </div>
                        <span class="text-sm fw-black">{{ consumo.carbos|default:0 }}g / {{ plan.carbohidratos_g|default:0 }}g</span>
                    </div>
                    <div class="micro-progress">
                        <div class="h-100"
                            style="width: {{ progress.carbos|default:0 }}%; background-color: var(--carbs-color);">
                        </div>
                    </div>
                </div>

                <!-- Grasas -->
                <div class="macro-card p-3">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <div class="p-2 rounded-circle bg-yellow-50 d-flex">
                                <span class="material-symbols-outlined text-yellow-500 fs-5">shutter_speed</span>
                            </div>
                            <span class="text-xs fw-bold text-secondary">Grasas</span>
                        </div>
                        <span class="text-sm fw-black">{{ consumo.grasas|default:0 }}g / {{ plan.grasas_g|default:0}}g</span>
                    </div>
                    <div class="micro-progress">
                        <div class="h-100"
                            style="width: {{ progress.grasas|default:0 }}%; background-color: var(--fats-color);">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botón de acción -->
            <div class="text-center mt-4 mb-4">
                <button id="add-log-btn"
                    class="btn btn-primary-custom d-inline-flex align-items-center justify-content-center gap-2 shadow-sm">
                    <span class="material-symbols-outlined">add_circle</span>
                    Añadir Registro
                </button>
            </div>

            <div class="row g-2">
                <div class="col-6">
                    <div class="bg-blue-50 p-3 rounded-4 text-center border border-info-subtle">
                        <span class="material-symbols-outlined text-info mb-1">water_drop</span>
                        <div class="text-xs text-secondary fw-bold">Agua</div>
                        <div class="fw-black text-sm text-primary">0 / 3L</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="bg-emerald-50 p-3 rounded-4 text-center border border-success-subtle">
                        <span class="material-symbols-outlined text-success mb-1">grain</span>
                        <div class="text-xs text-secondary fw-bold">Fibra</div>
                        <div class="fw-black text-sm text-success">0g / 30g</div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <section class="card meal-card p-4 shadow-sm border-0">
        <div class="mb-4">
            <h2 class="h5 fw-black mb-2">Crea tu Plan</h2>
            <p class="text-sm text-secondary">Ajusta tus objetivos para maximizar tu rendimiento físico.</p>
        </div>
        <button class="btn btn-primary-custom d-flex align-items-center justify-content-center gap-2">
            <span class="material-symbols-outlined">add_circle</span>
            Crear Dieta Personalizada
        </button>
    </section>
</div>
</div>

<script>
    document.getElementById('add-log-btn').addEventListener('click', function () {
        let count = parseInt(localStorage.getItem('diary_usage_count') || '0');

        if (count >= 3) {
            showToast('Has alcanzado el límite de 3 registros diarios.', 'warning');
            return;
        }

        count++;
        localStorage.setItem('diary_usage_count', count);
        showToast(`Registro #${count} añadido. Te quedan ${3 - count} usos gratis hoy.`, 'success');

        const logList = document.querySelector('.log-list');
        const newItem = document.createElement('div');
        newItem.className = 'log-item';
        newItem.innerHTML = `
            <div class="log-time">04:00 PM</div>
            <div class="log-icon bg-soft-green"><span class="material-symbols-outlined">restaurant</span></div>
            <div class="flex-grow-1">
                <h6 class="fw-black mb-0">Comida Extra #${count}</h6>
                <p class="small text-muted mb-0 fw-bold">Registro rápido</p>
            </div>
            <div class="text-end">
                <p class="fw-black mb-0">350</p>
                <p class="x-small text-muted mb-0 fw-bold">kcal</p>
            </div>
        `;
        logList.appendChild(newItem);
    });
</script>
{% endblock %}