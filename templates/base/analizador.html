{% extends base_template %}
{% load static %}

{% block title %}Analizador Nutricional - nunut{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
    rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
<style>
    /* Redesigned Minimalist Aesthetics */
    .analyzer-container {
        background: #f8fafc !important;
        /* Extremely subtle off-white for contrast */
        min-height: 100vh;
    }

    .analyzer-card {
        background: white;
        border-radius: 40px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.04);
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        font-family: 'Quicksand', sans-serif;
    }

    body.dark-mode .analyzer-container {
        background: var(--bg-page) !important;
    }

    .analyzer-title {
        font-weight: 900 !important;
        letter-spacing: -2px;
        color: #1a1a1a;
    }

    .mic-wrap {
        position: relative;
        width: 140px;
        height: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .mic-button-minimal {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        background: white;
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        color: #1a1a1a;
        cursor: pointer;
        z-index: 10;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .mic-button-minimal:hover {
        transform: scale(1.05);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
    }

    .mic-button-minimal.listening {
        background: white;
        color: #1a1a1a;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    }


    .recording-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(34, 197, 94, 0.1);
        color: #166534;
        padding: 6px 16px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 1px solid rgba(34, 197, 94, 0.2);
        margin-bottom: 1rem;
    }

    body.dark-mode .recording-badge {
        background: rgba(34, 197, 94, 0.2);
        color: #4ade80;
    }

    @keyframes pulse-green {
        0% {
            transform: scale(0.9);
            opacity: 1;
        }

        50% {
            transform: scale(1.2);
            opacity: 0.6;
        }

        100% {
            transform: scale(0.9);
            opacity: 1;
        }
    }

    @keyframes pulse-out {
        0% {
            transform: scale(0.8);
            opacity: 0.3;
        }

        100% {
            transform: scale(1.4);
            opacity: 0;
        }
    }

    .transcription-area {
        background: #f8fafc;
        border-radius: 24px;
        border: 1px solid rgba(0, 0, 0, 0.02);
        min-height: 100px;
        width: 100%;
        margin-top: 2rem;
    }

    .stats-card-minimal {
        background: #ffffff;
        border-radius: 20px;
        padding: 1.25rem;
        border: 1px solid rgba(0, 0, 0, 0.04);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.01);
        transition: all 0.3s ease;
    }

    .stats-card-minimal:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    }

    .macro-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }

    /* Dark Mode Improvements */
    body.dark-mode .analyzer-card {
        background: #111827;
        border-color: rgba(255, 255, 255, 0.05);
    }

    body.dark-mode .mic-button-minimal {
        background: #1f2937;
        color: white;
    }

    body.dark-mode .transcription-area {
        background: #1f2937;
    }

    body.dark-mode .stats-card-minimal {
        background: #1f2937;
    }

    /* Modal Glass */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .modal-overlay.show {
        display: flex;
        opacity: 1;
    }

    .modal-glass {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 32px;
        padding: 2.5rem;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        transform: scale(0.95);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-overlay.show .modal-glass {
        transform: scale(1);
    }

    /* Date Chips */
    .date-chip-glass {
        min-width: 100px;
        background: #f8fafc;
        border: 2px solid transparent;
        border-radius: 20px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }

    .date-chip-glass:hover {
        background: #f1f5f9;
        transform: translateY(-2px);
    }

    .date-chip-glass.selected {
        background: #dcfce7;
        border-color: var(--primary-lime);
        color: #166534;
    }

    body.dark-mode .modal-glass {
        background: #1f2937;
        border-color: rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .date-chip-glass {
        background: #374151;
        color: #e5e7eb;
    }

    body.dark-mode .date-chip-glass.selected {
        background: rgba(133, 200, 26, 0.2);
        color: var(--primary-lime);
        border-color: var(--primary-lime);
    }

    /* Mode Toggle Switch - Fluid Movement */
    .mode-toggle-wrapper {
        background: #f1f5f9;
        padding: 5px;
        border-radius: 100px;
        display: inline-flex;
        position: relative;
        gap: 0;
        margin-bottom: 2.5rem;
        z-index: 1;
        overflow: hidden;
    }

    .mode-btn {
        border: none;
        background: transparent;
        padding: 12px 30px;
        border-radius: 100px;
        font-weight: 700;
        font-size: 0.95rem;
        color: #64748b;
        transition: color 0.4s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
        z-index: 2;
        width: 140px;
        justify-content: center;
    }

    .mode-btn.active {
        color: #1a1a1a;
        background: transparent !important;
        box-shadow: none !important;
    }

    .toggle-pill {
        position: absolute;
        top: 5px;
        left: 5px;
        height: calc(100% - 10px);
        width: calc(50% - 5px);
        background: white;
        border-radius: 100px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        z-index: 0;
    }

    .mode-toggle-wrapper[data-mode="text"] .toggle-pill {
        transform: translateX(100%);
    }

    body.dark-mode .mode-toggle-wrapper {
        background: #1f2937;
    }

    body.dark-mode .toggle-pill {
        background: #374151;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    body.dark-mode .mode-btn.active {
        color: white;
    }
</style>
{% endblock %}

{% block container_class %}container analyzer-container{% endblock %}

{% block content %}
{% csrf_token %}

<!-- NEW MINIMALIST UI -->
<div class="row justify-content-center">
    <div class="col-12 col-xxl-10">

        <!-- Top bar with Error Alert Area -->
        <div id="errorAlert"
            class="alert alert-danger d-none rounded-4 border-0 shadow-sm mb-4 animate__animated animate__fadeIn">
            <div class="d-flex align-items-center gap-3">
                <span class="material-symbols-outlined">error</span>
                <div class="flex-grow-1">
                    <h6 class="mb-0 fw-bold">Algo salió mal</h6>
                    <small id="errorMsgText">Error detallado aquí</small>
                </div>
                <button type="button" class="btn-close"
                    onclick="this.parentElement.parentElement.classList.add('d-none')"></button>
            </div>
        </div>

        <div class="row g-4 scroll-mt-large">
            <!-- LEFT: INPUT & INTERACTION -->
            <div class="col-12 col-lg-6">
                <div class="analyzer-card p-5 h-100">
                    <div class="d-flex flex-column align-items-center text-center">
                        <h1 class="analyzer-title mb-1 display-6">Analiza tu plato</h1>
                        <p class="text-muted mb-4">Voz o texto, nuestra IA lo entiende todo.</p>

                        <!-- Toggle Switch -->
                        <div class="mode-toggle-wrapper" data-mode="voice">
                            <div class="toggle-pill"></div>
                            <button id="btnVoice" class="mode-btn active" onclick="switchMode('voice')">
                                <span class="material-symbols-outlined">mic</span> Voz
                            </button>
                            <button id="btnText" class="mode-btn" onclick="switchMode('text')">
                                <span class="material-symbols-outlined">edit_note</span> Texto
                            </button>
                        </div>

                        <!-- Voice Section -->
                        <div id="voice-container" class="w-100">
                            <div class="mic-wrap mb-4 mx-auto" id="micWrapper">
                                <button class="mic-button-minimal" id="micButton" onclick="toggleVoiceRecording()">
                                    <span class="material-symbols-outlined" style="font-size: 36px;">mic</span>
                                </button>
                            </div>

                            <div id="recordingIndicator" class="d-none">
                                <div class="recording-badge">
                                    <span
                                        style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%; display: inline-block; animation: pulse-green 1s infinite;"></span>
                                    Grabando
                                </div>
                            </div>

                            <h4 id="voiceStatus" class="fw-bold mb-2">Presiona para hablar</h4>
                            <p id="voiceHint" class="text-muted small px-4 mb-4" style="line-height: 1.4;">"He comido un
                                salmón a la plancha con espárragos"</p>

                            <div class="transcription-area p-4 text-start">
                                <p id="transcriptionText" class="mb-0 fw-medium lead" style="color: #334155;">
                                    <span class="opacity-25">Tu transcripción aparecerá aquí...</span>
                                </p>
                            </div>
                        </div>

                        <!-- Text Section -->
                        <div id="text-container" class="w-100 d-none">
                            <div class="p-2">
                                <textarea id="textInput" class="form-control rounded-5 border-0 bg-light p-4 fs-5"
                                    rows="6"
                                    placeholder="Ej: Plato de pasta con tomate y queso parmesano..."></textarea>
                                <p class="text-muted small mt-3">Escribe los detalles de tu comida para un análisis
                                    preciso.</p>
                            </div>
                        </div>

                        <div class="d-flex gap-3 w-100 mt-5">
                            <button id="analyzeMainBtn" class="btn btn-dark w-100 rounded-pill py-3 fw-bold shadow-sm"
                                onclick="analyzeFood()">
                                Analizar Ahora
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: RESULTS -->
            <div class="col-12 col-lg-6">
                <!-- Empty State -->
                <div id="emptyAnalysisState"
                    class="analyzer-card p-5 h-100 d-flex flex-column align-items-center justify-content-center text-center opacity-75">
                    <div class="mb-4 text-muted">
                        <span class="material-symbols-outlined" style="font-size: 80px; opacity: 0.1;">fastfood</span>
                    </div>
                    <h3 class="fw-bold">Sin datos aún</h3>
                    <p class="text-muted">Procesa una comida para ver el desglose nutricional profesional aquí.</p>
                </div>

                <!-- Result Content -->
                <div id="analysisResultContent" class="d-none h-100 flex-column gap-4">
                    <!-- Main Summary -->
                    <div class="analyzer-card p-4 p-md-5 overflow-hidden border-0 shadow-lg"
                        style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white;">
                        <div class="d-flex justify-content-between align-items-start mb-4">
                            <div>
                                <h2 id="totalCalories" class="display-3 fw-900 mb-0" style="letter-spacing: -2px;">0
                                </h2>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="text-white text-opacity-50 fw-bold fs-7 uppercase">kcal totales</span>
                                    <span
                                        class="badge bg-success bg-opacity-25 text-success border border-success border-opacity-25 py-1 px-3 rounded-pill fw-black x-small">ANALIZADO</span>
                                </div>
                            </div>
                            <button class="btn btn-success px-4 py-2 rounded-pill fw-bold shadow-sm"
                                onclick="showCalendarModal()">
                                <span class="material-symbols-outlined fs-5 align-middle me-1">calendar_today</span>
                                Guardar
                            </button>
                        </div>
                        <p id="dishDescription" class="text-white text-opacity-75 lead mb-0 fw-medium">Describe tu plato
                            para empezar.</p>
                    </div>

                    <!-- Macro Breakdown Minimalist -->
                    <div class="row g-2">
                        <div class="col-4">
                            <div class="stats-card-minimal text-center border-0 shadow-sm"
                                style="background: rgba(34, 197, 94, 0.05);">
                                <span class="text-success fs-8 fw-900 mb-1 d-block">PROT</span>
                                <h4 id="totalProtein" class="fw-black mb-0" style="color: #166534;">0g</h4>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stats-card-minimal text-center border-0 shadow-sm"
                                style="background: rgba(59, 130, 246, 0.05);">
                                <span class="text-primary fs-8 fw-900 mb-1 d-block">CARB</span>
                                <h4 id="totalCarbs" class="fw-black mb-0" style="color: #1e40af;">0g</h4>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stats-card-minimal text-center border-0 shadow-sm"
                                style="background: rgba(245, 158, 11, 0.05);">
                                <span class="text-warning fs-8 fw-900 mb-1 d-block">GRASA</span>
                                <h4 id="miniFatVal" class="fw-black mb-0" style="color: #92400e;">0g</h4>
                            </div>
                        </div>
                    </div>

                    <!-- Ingredients -->
                    <div class="analyzer-card p-4 flex-grow-1">
                        <h6 class="fw-black mb-3 px-2">DETALLE DE INGREDIENTES</h6>
                        <div id="ingredientsList" class="d-flex flex-column gap-2 overflow-auto"
                            style="max-height: 250px;">
                            <!-- Injected -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Calendar Modal Glass -->
<div class="modal-overlay" id="calendarModal">
    <div class="modal-glass">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold m-0 text-dark">¿Cuándo lo comiste?</h4>
            <button class="btn btn-sm btn-light rounded-circle shadow-sm" onclick="hideCalendarModal()">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <div class="d-flex gap-2 overflow-auto pb-3 mb-3" id="miniCalendarDays"
            style="scrollbar-width: none; -ms-overflow-style: none;">
            <!-- Days will be injected by JS -->
        </div>

        <button
            class="btn btn-dark w-100 rounded-pill py-3 fw-bold shadow-lg d-flex justify-content-center align-items-center gap-2"
            id="confirmAddBtn" onclick="confirmAddToCalendar()">
            <span class="material-symbols-outlined">check_circle</span>
            Confirmar y Añadir
        </button>
    </div>
</div>

<script>
    if (typeof window.analizadorIniciado === 'undefined') {
        window.analizadorIniciado = true;

        // --- Global Config & State ---
        var isRecording = isRecording || false;
        var mediaRecorder = mediaRecorder || null;
        var audioChunks = audioChunks || [];
        var currentAnalysis = currentAnalysis || null;
        var selectedDate = selectedDate || null;
        var audioContext = audioContext || null;
        var analyser = analyser || null;
        var animationId = animationId || null;
        var recognition = recognition || null;

        function initRecognition() {
            if (recognition) return;
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRec();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'es-ES';
                recognition.onresult = (e) => {
                    let fullText = '';
                    for (let i = 0; i < e.results.length; i++) fullText += e.results[i][0].transcript + ' ';
                    const el = document.getElementById('transcriptionText');
                    if (el) {
                        el.textContent = fullText;
                        el.classList.add('fw-bold', 'text-dark');
                    }
                    const analyzeBtn = document.getElementById('analyzeMainBtn');
                    if (analyzeBtn && fullText.trim().length > 5) analyzeBtn.classList.remove('d-none');
                };
            }
        }
        initRecognition();

        // --- Core Interaction Functions ---

        window.switchMode = function (mode) {
            const wrapper = document.querySelector('.mode-toggle-wrapper');
            if (wrapper) wrapper.setAttribute('data-mode', mode);

            const vContainer = document.getElementById('voice-container');
            const tContainer = document.getElementById('text-container');
            const btnV = document.getElementById('btnVoice');
            const btnT = document.getElementById('btnText');

            if (mode === 'voice') {
                if (vContainer) vContainer.classList.remove('d-none');
                if (tContainer) tContainer.classList.add('d-none');
                if (btnV) btnV.classList.add('active');
                if (btnT) btnT.classList.remove('active');
            } else {
                if (vContainer) vContainer.classList.add('d-none');
                if (tContainer) tContainer.classList.remove('d-none');
                if (btnV) btnV.classList.remove('active');
                if (btnT) btnT.classList.add('active');
            }
        };

        window.toggleVoiceRecording = async function () {
            if (isRecording) {
                stopVoiceRecording();
            } else {
                if (typeof showConfirmModal === 'function') {
                    showConfirmModal({
                        title: 'Activar Micrófono',
                        message: 'Usaremos la IA para transcribir lo que digas. ¿Deseas comenzar la grabación?',
                        icon: 'mic',
                        yesText: 'Empezar ahora',
                        onConfirm: () => {
                            startVoiceRecording();
                        }
                    });
                } else {
                    startVoiceRecording();
                }
            }
        };

        async function startVoiceRecording() {
            const micButton = document.getElementById('micButton');
            const micWrapper = document.getElementById('micWrapper');
            const voiceStatus = document.getElementById('voiceStatus');
            const voiceHint = document.getElementById('voiceHint');
            const listeningIndicator = document.getElementById('listeningIndicator');

            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error("HTTPS o navegador moderno requerido para grabar.");
                }

                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: { echoCancellation: true, noiseSuppression: true }
                });

                isRecording = true;
                if (micButton) micButton.classList.add('listening');
                if (micWrapper) micWrapper.classList.add('recording-active');
                if (voiceStatus) {
                    voiceStatus.textContent = 'Estamos escuchando...';
                }
                const recInd = document.getElementById('recordingIndicator');
                if (recInd) recInd.classList.remove('d-none');

                if (voiceHint) voiceHint.classList.add('opacity-50');
                if (navigator.vibrate) navigator.vibrate(50);

                // --- VOICE VISUALIZER ---
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    const source = audioContext.createMediaStreamSource(stream);
                    source.connect(analyser);
                    analyser.fftSize = 256;
                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);

                    let smoothedAverage = 0;
                    const updateVisuals = () => {
                        if (!isRecording) return;
                        analyser.getByteFrequencyData(dataArray);
                        let sum = 0;
                        for (let i = 0; i < bufferLength; i++) sum += dataArray[i];
                        const average = sum / bufferLength;

                        // Smoothed scaling logic
                        smoothedAverage += (average - smoothedAverage) * 0.15;
                        const scale = 1 + (smoothedAverage / 120);

                        if (micButton) micButton.style.transform = `scale(${scale})`;
                        animationId = requestAnimationFrame(updateVisuals);
                    };
                    updateVisuals();
                } catch (vizErr) {
                    console.warn("Visualizer failed:", vizErr);
                }

                if (recognition) {
                    try { recognition.start(); } catch (e) { }
                }

                const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/ogg';
                mediaRecorder = new MediaRecorder(stream, { mimeType });
                audioChunks = [];

                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    await sendAudioToServer(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();

            } catch (err) {
                console.error("Grabación fallida:", err);
                isRecording = false;
                if (micButton) micButton.classList.remove('listening');
                if (micWrapper) micWrapper.classList.remove('recording-active');
                if (voiceStatus) voiceStatus.textContent = 'Error';
                if (typeof showToast === 'function') showToast(err.message, 'error');
            }
        }

        function stopVoiceRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                if (recognition) try { recognition.stop(); } catch (e) { }
                isRecording = false;
                if (animationId) cancelAnimationFrame(animationId);
                if (audioContext) audioContext.close();

                const micButton = document.getElementById('micButton');
                const micWrapper = document.getElementById('micWrapper');
                if (micButton) {
                    micButton.classList.remove('listening');
                    micButton.style.transform = '';
                }
                if (micWrapper) micWrapper.classList.remove('recording-active');
                const recInd = document.getElementById('recordingIndicator');
                if (recInd) recInd.classList.add('d-none');

                const voiceStatus = document.getElementById('voiceStatus');
                if (voiceStatus) voiceStatus.textContent = 'Procesando...';
            }
        }

        async function sendAudioToServer(blob) {
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrfToken = csrfInput ? csrfInput.value : '';
            const formData = new FormData();
            formData.append('audio_file', blob, 'recording.webm');

            try {
                const response = await fetch('/api/transcribir_audio/', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken },
                    body: formData
                });

                const data = await response.json().catch(() => ({ success: false, error: "Respuesta no válida del servidor" }));

                if (response.ok && data.success) {
                    const el = document.getElementById('transcriptionText');
                    if (el && data.text) {
                        el.textContent = data.text;
                        el.classList.add('fw-bold', 'text-dark');
                    }
                    const voiceStatus = document.getElementById('voiceStatus');
                    if (voiceStatus) voiceStatus.textContent = '¡Listo!';

                    const analyzeBtn = document.getElementById('analyzeMainBtn');
                    if (analyzeBtn) analyzeBtn.classList.remove('d-none');

                    if (data.analisis) currentAnalysis = data.analisis;
                } else {
                    // Manejo específico de cuotas / límites
                    if (data.error_type === 'QUOTA_EXCEEDED') {
                        showError('⏳ ' + data.error);
                        const voiceStatus = document.getElementById('voiceStatus');
                        if (voiceStatus) voiceStatus.textContent = 'Límite alcanzado';
                        return;
                    }

                    if (!data.text) {
                        throw new Error(data.error || "Error desconocido");
                    } else {
                        const el = document.getElementById('transcriptionText');
                        if (el) el.textContent = data.text;
                        console.warn("Error secundario silenciado:", data.error);
                    }
                }
            } catch (error) {
                console.error("Transcription error:", error);
                const el = document.getElementById('transcriptionText');
                if (!el || !el.textContent || el.textContent.includes('aparecerá aquí')) {
                    showError('❌ Error al transcribir: ' + error.message);
                }
            }
        }

        window.analyzeFood = async function () {
            const textContainer = document.getElementById('text-container');
            let description = "";

            if (textContainer && !textContainer.classList.contains('d-none')) {
                const input = document.getElementById('textInput');
                description = input ? input.value : "";
            } else {
                const el = document.getElementById('transcriptionText');
                description = el ? el.textContent : "";
                description = description.replace('Tu transcripción aparecerá aquí...', '').trim();
            }

            await performAnalysis(description);
        };

        async function performAnalysis(description) {
            if (!description) {
                showError('Por favor describe tu comida primero.');
                return;
            }

            const errorAlert = document.getElementById('errorAlert');
            if (errorAlert) errorAlert.classList.add('d-none');
            if (typeof showToast === 'function') showToast('Analizando tu plato...', 'info');

            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrfToken = csrfInput ? csrfInput.value : '';

            try {
                const response = await fetch('/api/analizar_comida_ia/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ descripcion: description })
                });

                const data = await response.json().catch(() => ({ success: false, error: "Error de formato en el servidor" }));

                if (data.success) {
                    currentAnalysis = data.analisis;
                    displayAnalysis(data.analisis);
                    if (typeof showToast === 'function') showToast('¡Análisis completado!', 'success');
                } else {
                    if (data.error_type === 'QUOTA_EXCEEDED') {
                        showError('⏳ ' + data.error);
                    } else {
                        showError(data.error || 'No pudimos procesar la información.');
                    }
                }
            } catch (error) {
                console.error('Analysis error:', error);
                showError('Error de red o servidor.');
            }
        }

        function showError(msg) {
            const alert = document.getElementById('errorAlert');
            const text = document.getElementById('errorMsgText');
            if (alert && text) {
                text.textContent = msg;
                alert.classList.remove('d-none');
                alert.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            if (typeof showToast === 'function') showToast(msg, 'error');
        }

        function displayAnalysis(analysis) {
            const emptyState = document.getElementById('emptyAnalysisState');
            const resultContent = document.getElementById('analysisResultContent');
            if (emptyState) emptyState.classList.add('d-none');
            if (resultContent) {
                resultContent.classList.remove('d-none');
                resultContent.classList.add('d-flex');
            }

            const updateText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            updateText('totalCalories', analysis.calorias || 0);
            updateText('totalProtein', (analysis.proteinas || 0) + 'g');
            updateText('totalCarbs', (analysis.carbohidratos || 0) + 'g');
            updateText('miniFatVal', (analysis.grasas || 0) + 'g');
            updateText('dishDescription', analysis.descripcion || '');

            const ingredientsList = document.getElementById('ingredientsList');
            if (ingredientsList) {
                if (analysis.ingredientes && analysis.ingredientes.length > 0) {
                    ingredientsList.innerHTML = analysis.ingredientes.map(ing => `
                    <div class="d-flex align-items-center gap-3 p-3 rounded-4 bg-light border border-light mb-2">
                        <div class="bg-white p-2 rounded-circle shadow-sm">
                            <span class="material-symbols-outlined text-muted fs-5">nutrition</span>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-0 fw-bold text-dark">${ing.nombre || ing}</h6>
                            <small class="text-muted fw-bold">${ing.cantidad || ''}</small>
                        </div>
                        <span class="material-symbols-outlined text-success">check_circle</span>
                    </div>
                `).join('');
                } else {
                    ingredientsList.innerHTML = '<p class="text-muted small px-3">No se detectaron ingredientes específicos.</p>';
                }
            }
        }

        window.showCalendarModal = function () {
            if (!currentAnalysis) {
                if (typeof showToast === 'function') showToast('Primero analiza una comida', 'warning');
                return;
            }
            const modal = document.getElementById('calendarModal');
            if (modal) modal.classList.add('show');
            renderMiniCalendar();
        };

        window.hideCalendarModal = function () {
            const modal = document.getElementById('calendarModal');
            if (modal) modal.classList.remove('show');
            selectedDate = null;
        };

        function renderMiniCalendar() {
            const container = document.getElementById('miniCalendarDays');
            if (!container) return;
            container.innerHTML = '';
            const days = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            const today = new Date();
            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(today.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = i === 0;
                const chip = document.createElement('div');
                chip.className = 'date-chip-glass flex-shrink-0';
                chip.dataset.date = dateStr;
                chip.onclick = function () {
                    document.querySelectorAll('.date-chip-glass').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedDate = dateStr;
                };
                chip.innerHTML = `
                <small class="d-block text-muted mb-1" style="font-size: 0.75rem;">${isToday ? 'Hoy' : days[date.getDay()]}</small>
                <span class="day-number fw-bold fs-4">${date.getDate()}</span>
            `;
                container.appendChild(chip);
            }
        }

        window.confirmAddToCalendar = async function () {
            if (!selectedDate) {
                if (typeof showToast === 'function') showToast('Selecciona una fecha', 'warning');
                return;
            }
            const btn = document.getElementById('confirmAddBtn');
            const originalText = btn ? btn.innerHTML : "";
            if (btn) {
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';
                btn.disabled = true;
            }

            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrfToken = csrfInput ? csrfInput.value : '';

            try {
                const response = await fetch('/api/guardar_comida/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fecha: selectedDate,
                        nombre: currentAnalysis.titulo || 'Comida Analizada',
                        calorias: currentAnalysis.calorias || 0,
                        proteinas: currentAnalysis.proteinas || 0,
                        carbos: currentAnalysis.carbohidratos || 0,
                        grasas: currentAnalysis.grasas || 0,
                        hora: new Date().toTimeString().split(' ')[0]
                    })
                });
                const data = await response.json();
                if (data.success) {
                    if (typeof showToast === 'function') showToast('¡Comida añadida!', 'success');
                    hideCalendarModal();
                    location.reload();
                } else {
                    showError('Error: ' + data.error);
                }
            } catch (error) {
                showError('Error de servidor.');
            } finally {
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        };

        // --- Tab & Window Initialization ---

        document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(pill => {
            pill.addEventListener('shown.bs.tab', (e) => {
                const tabId = e.target.getAttribute('data-bs-target').replace('#', '');
                const url = new URL(window.location);
                url.searchParams.set('tab', tabId);
                window.history.replaceState({}, '', url);
            });
        });

        const params = new URLSearchParams(window.location.search);
        const tab = params.get('tab');
        if (tab) {
            const triggerEl = document.querySelector(`button[data-bs-target="#${tab}"]`);
            if (triggerEl) {
                if (typeof bootstrap !== 'undefined' && bootstrap.Tab) {
                    (new bootstrap.Tab(triggerEl)).show();
                } else triggerEl.click();
            }
        }
    } // Fin comprobación analizadorIniciado
</script>
{% endblock %}