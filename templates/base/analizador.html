{% extends base_template %}
{% load static %}

{% block title %}Analizador Nutricional - nunut{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
    rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
{% endblock %}


{% block container_class %}container analyzer-container{% endblock %}

{% block content %}
{% csrf_token %}

<!-- NEW MINIMALIST UI -->
<style>
    /* Redesigned Neutral Elegant Minimalist Aesthetics */
    :root {
        --bg-page: #ffffff;
        --bg-card: #ffffff;
        --text-main: #18181b;
        --text-muted: #71717a;
        --border-light: #e4e4e7;
        --primary-elegant: #27272a;

        --accent-subtle: #f4f4f5;
    }

    .analyzer-container {
        background: #fafafa !important;
        /* Neutral 50 */
        min-height: 100vh;
        color: var(--text-main);
    }

    .analyzer-card {
        background: var(--bg-card);
        border-radius: 24px;
        border: 1px solid var(--border-light);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        transition: all 0.3s ease;
        font-family: 'Quicksand', sans-serif;
    }

    body.dark-mode .analyzer-container {
        background: #09090b !important;

    }

    .analyzer-title {
        font-weight: 800 !important;
        letter-spacing: -1.5px;
        color: var(--text-main);
    }

    .mic-wrap {
        position: relative;
        width: 120px;
        height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .mic-button-minimal {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: white;
        border: 1px solid var(--border-light);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        color: var(--text-main);
        cursor: pointer;
        z-index: 10;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .mic-button-minimal:hover {
        transform: scale(1.02);
        border-color: #d4d4d8;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .mic-button-minimal.listening {
        background: #fafafa;
        border-color: #22c55e;
        /* Green for recording state */
        color: #22c55e;
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
    }

    .recording-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(0, 0, 0, 0.03);
        color: #22c55e;
        padding: 6px 14px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 1rem;
    }

    body.dark-mode .recording-badge {
        background: rgba(255, 255, 255, 0.05);
        color: #4ade80;
    }

    @keyframes pulse-green {
        0% {
            transform: scale(0.95);
            opacity: 1;
        }

        50% {
            transform: scale(1.05);
            opacity: 0.7;
        }

        100% {
            transform: scale(0.95);
            opacity: 1;
        }
    }

    .transcription-area {
        background: #fafafa;
        border-radius: 16px;
        border: 1px solid transparent;
        min-height: 100px;
        width: 100%;
        margin-top: 2rem;
        transition: background 0.2s;
    }

    .transcription-area:hover {
        background: #f4f4f5;
    }

    .stats-card-minimal {
        background: #ffffff;
        border-radius: 20px;
        padding: 1.25rem;
        border: 1px solid var(--border-light);
        box-shadow: none;
        transition: all 0.2s ease;
    }

    .stats-card-minimal:hover {
        border-color: #d4d4d8;
        transform: translateY(-2px);
    }

    .macro-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }

    /* Dark Mode Improvements */
    body.dark-mode {
        --bg-page: #09090b;
        --bg-card: #18181b;
        --text-main: #f4f4f5;
        --text-muted: #a1a1aa;
        --border-light: #27272a;
        --primary-elegant: #fafafa;
        --accent-subtle: #27272a;
    }

    body.dark-mode .analyzer-card {
        background: var(--bg-card);
        border-color: var(--border-light);
    }

    body.dark-mode .mic-button-minimal {
        background: #27272a;
        border-color: #3f3f46;
        color: #e4e4e7;
    }

    body.dark-mode .transcription-area {
        background: #27272a;
    }

    body.dark-mode .stats-card-minimal {
        background: #18181b;
        border-color: #27272a;
    }

    body.dark-mode .stats-value {
        color: #f4f4f5;
    }

    body.dark-mode .analyzer-title,
    body.dark-mode .text-dark,
    body.dark-mode h1,
    body.dark-mode h2,
    body.dark-mode h3,
    body.dark-mode h4,
    body.dark-mode h5,
    body.dark-mode h6,
    body.dark-mode .fw-bold.text-dark {
        color: #f4f4f5 !important;
    }

    body.dark-mode .text-muted {
        color: #a1a1aa !important;
    }

    body.dark-mode .bg-white {
        background-color: #18181b !important;
        color: #f4f4f5;
    }

    body.dark-mode .form-control {
        background-color: #18181b;
        border-color: #27272a;
        color: #f4f4f5;
    }

    body.dark-mode .form-control:focus {
        background-color: #18181b;
        border-color: #22c55e;
        color: #f4f4f5;
    }

    /* Modal Glass - Cleaner */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        /* Darker backdrop */
        backdrop-filter: blur(4px);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .modal-overlay.show {
        display: flex;
        opacity: 1;
    }

    .modal-glass {
        background: #ffffff;
        border: 1px solid var(--border-light);
        border-radius: 24px;
        padding: 2rem;
        width: 90%;
        max-width: 480px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        transform: scale(0.98);
        transition: transform 0.2s ease;
    }

    .modal-overlay.show .modal-glass {
        transform: scale(1);
    }

    /* Date Chips - Minimal */
    .date-chip-glass {
        min-width: 90px;
        background: transparent;
        border: 1px solid var(--border-light);
        border-radius: 16px;
        padding: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }

    .date-chip-glass:hover {
        background: #f4f4f5;
        border-color: #d4d4d8;
    }

    .date-chip-glass.selected {
        background: #18181b;
        border-color: #18181b;
        color: white;
    }

    .date-chip-glass.selected small,
    .date-chip-glass.selected span {
        color: white !important;
    }

    body.dark-mode .modal-glass {
        background: #18181b;
        border-color: #3f3f46;
    }

    body.dark-mode .date-chip-glass {
        border-color: #3f3f46;
        color: #e4e4e7;
    }

    body.dark-mode .date-chip-glass:hover {
        background: #27272a;
    }

    body.dark-mode .date-chip-glass.selected {
        background: #fafafa;
        border-color: #fafafa;
        color: #18181b;
    }

    body.dark-mode .date-chip-glass.selected * {
        color: #18181b !important;
    }

    /* Mode Toggle Switch - Minimal pill */
    .mode-toggle-wrapper {
        background: #f4f4f5;
        padding: 4px;
        border-radius: 100px;
        display: inline-flex;
        position: relative;
        gap: 0;
        margin-bottom: 2.5rem;
        z-index: 1;
        overflow: hidden;
        border: 1px solid transparent;
    }

    .mode-btn {
        border: none;
        background: transparent;
        padding: 10px 24px;
        border-radius: 100px;
        font-weight: 600;
        font-size: 0.9rem;
        color: #71717a;
        transition: color 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        position: relative;
        z-index: 2;
        width: 130px;
        justify-content: center;
    }

    .mode-btn.active {
        color: #18181b !important;
    }

    .toggle-pill {
        position: absolute;
        top: 4px;
        left: 4px;
        height: calc(100% - 8px);
        width: calc(50% - 4px);
        background: white;
        border-radius: 100px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        z-index: 0;
    }

    .mode-toggle-wrapper[data-mode="text"] .toggle-pill {
        transform: translateX(100%);
    }

    body.dark-mode .mode-toggle-wrapper {
        background: #27272a;
    }

    body.dark-mode .toggle-pill {
        background: #3f3f46;
        box-shadow: none;
    }

    body.dark-mode .mode-btn.active {
        color: white !important;
    }

    /* Button Styles - Elegant Dark */
    .btn-nunut {
        background: #18181b;

        color: white;
        border: none;
        transition: all 0.2s ease;
    }

    .btn-nunut:hover {
        background: #27272a;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        color: white;
    }

    .btn-nunut:active {
        transform: scale(0.98);
    }

    body.dark-mode .btn-nunut {
        background: #fafafa;
        color: #18181b;
    }

    body.dark-mode .btn-nunut:hover {
        background: #f4f4f5;
    }

    /* Analysis Section Clean Up */
    .stats-label {
        font-size: 0.7rem;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        color: #a1a1aa;
        margin-bottom: 0.5rem;
        display: block;
    }

    .stats-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #18181b;
    }

    /* VIBE UI ADDITIONS */
    .circular-chart {
        display: block;
        margin: 0 auto;
        max-width: 100%;
        max-height: 250px;
    }

    .circle-bg {
        fill: none;
        stroke: #f3f4f6;
        stroke-width: 2.5;
    }

    .circle {
        fill: none;
        stroke-width: 2.5;
        stroke-linecap: round;
        /* Stroke color set via JS */
    }

    .hover-scale {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .hover-scale:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1) !important;
    }

    .custom-scroll::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scroll::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scroll::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 20px;
    }

    .ls-1 {
        letter-spacing: 1px;
    }

    .ls-2 {
        letter-spacing: 2px;
    }

    /* Dark Mode Vibe Overrides */
    body.dark-mode .circle-bg {
        stroke: #27272a;
    }

    body.dark-mode .text-dark {
        color: #f4f4f5 !important;
    }

    body.dark-mode .bg-white {
        background: #18181b !important;
    }

    body.dark-mode .bg-light {
        background: #27272a !important;
    }

    body.dark-mode .border {
        border-color: #3f3f46 !important;
    }

    body.dark-mode #transcriptionText {
        color: #e4e4e7 !important;
    }

    /* TOAST NOTIFICATIONS */
    #toast-container {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        pointer-events: none;
        width: 90%;
        max-width: 400px;
    }

    .custom-toast {
        background: white;
        color: var(--text-main);
        padding: 1rem 1.25rem;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 1rem;
        animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        pointer-events: auto;
        border: 1px solid var(--border-light);
    }

    body.dark-mode .custom-toast {
        background: #18181b;
        border-color: #3f3f46;
        color: #f4f4f5;
    }

    @keyframes slideUpFade {
        from {
            transform: translateY(20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>
<!-- NEW MINIMALIST UI -->
<div class="row justify-content-center">
    <div class="col-12 col-xxl-10">

        <!-- Top bar with Error Alert Area -->
        <div id="errorAlert"
            class="alert alert-danger d-none rounded-4 border-0 shadow-sm mb-4 animate__animated animate__fadeIn">
            <div class="d-flex align-items-center gap-3">
                <span class="material-symbols-outlined">error</span>
                <div class="flex-grow-1">
                    <h6 class="mb-0 fw-bold">Algo salió mal</h6>
                    <small id="errorMsgText">Error detallado aquí</small>
                </div>
                <button type="button" class="btn-close"
                    onclick="this.parentElement.parentElement.classList.add('d-none')"></button>
            </div>
        </div>

        <div class="row g-4 pt-4">
            <!-- LEFT: INPUT & INTERACTION -->
            <div class="col-12 col-lg-6">
                <div class="analyzer-card p-5 h-100">
                    <div class="d-flex flex-column align-items-center text-center">
                        <h1 class="analyzer-title mb-1 display-6" style="color: var(--text-main);">Analiza tu plato </h1>
                        <p class="text-muted mb-4">Voz o texto, nuestra IA lo entiende todo.</p>

                        <!-- Toggle Switch -->
                        <div class="mode-toggle-wrapper" data-mode="voice">
                            <div class="toggle-pill"></div>
                            <button id="btnVoice" class="mode-btn active" onclick="switchMode('voice')">
                                <span class="material-symbols-outlined">mic</span> Voz
                            </button>
                            <button id="btnText" class="mode-btn" onclick="switchMode('text')">
                                <span class="material-symbols-outlined">edit_note</span> Texto
                            </button>
                        </div>

                        <!-- Voice Section -->
                        <div id="voice-container" class="w-100">
                            <div class="mic-wrap mb-4 mx-auto" id="micWrapper">
                                <button class="mic-button-minimal" id="micButton" onclick="toggleVoiceRecording()">
                                    <span class="material-symbols-outlined" style="font-size: 36px;">mic</span>
                                </button>
                            </div>

                            <div id="recordingIndicator" class="d-none">
                                <div class="recording-badge">
                                    <span
                                        style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%; display: inline-block; animation: pulse-green 1s infinite;"></span>
                                    Grabando
                                </div>
                            </div>

                            <h4 id="voiceStatus" class="fw-bold mb-2 text-dark">Presiona para hablar</h4>
                            <div class="alert alert-light border-0 bg-transparent text-muted small px-3 mb-4 mx-auto"
                                style="max-width: 400px; line-height: 1.5;">
                                <i class="material-symbols-outlined align-bottom fs-6 me-1 text-warning">lightbulb</i>
                                <strong>Tip:</strong> Mientras más detalles des (cantidades, marcas, o tipo de
                                cocción), más preciso será el análisis.
                                <br><em class="opacity-75">"200g de salmón a la plancha" es mejor que "Salmón"</em>
                            </div>

                            <div class="transcription-area p-4 text-start">
                                <p id="transcriptionText" class="mb-0 fw-medium lead" style="color: var(--text-main);">
                                    <span class="opacity-25">Tu transcripción aparecerá aquí...</span>
                                </p>
                            </div>
                        </div>

                        <!-- Text Section -->
                        <div id="text-container" class="w-100 d-none">
                            <div class="p-2">
                                <textarea id="textInput"
                                    class="form-control rounded-4 border-light bg-white p-4 fs-5 shadow-sm" rows="5"
                                    placeholder="Ej: Plato de pasta con tomate y queso parmesano..."></textarea>

                                <div class="d-flex align-items-start gap-2 mt-3 text-muted small">
                                    <i class="material-symbols-outlined fs-6 mt-1 text-warning">lightbulb</i>
                                    <span><strong>Tip:</strong> Indica cantidades (tazas, gramos, cucharadas) para
                                        un resultado exacto. I.A. estima lo que no digas.</span>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-3 w-100 mt-5">
                            <button id="analyzeMainBtn" class="btn btn-nunut w-100 rounded-pill py-3 fw-bold shadow-lg"
                                onclick="analyzeFood()">
                                <span class="material-symbols-outlined align-middle me-2">auto_awesome</span>
                                Analizar Ahora
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: RESULTS -->
            <div class="col-12 col-lg-6">
                <!-- Empty State -->
                <div id="emptyAnalysisState"
                    class="analyzer-card p-5 h-100 d-flex flex-column align-items-center justify-content-center text-center opacity-75">
                    <div class="mb-4 text-muted">
                        <span class="material-symbols-outlined" style="font-size: 80px; opacity: 0.1;">fastfood</span>
                    </div>
                    <h3 class="fw-bold text-dark">Sin datos aún</h3>
                    <p class="text-muted">Procesa una comida para ver el desglose nutricional, micronutrientes y
                        calificación de salud aquí.</p>
                </div>

                <!-- Result Content -->
                <div id="analysisResultContent" class="d-none h-100 flex-column gap-3">

                    <!-- 1. Header & Score -->
                    <div class="analyzer-card p-4 border shadow-sm">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1 pe-3">
                                <h2 id="totalCalories" class="display-4 fw-bold mb-0 text-dark"
                                    style="letter-spacing: -2px;">0</h2>
                                <span class="text-uppercase fw-bold text-muted small ls-1">Kcal Totales</span>
                            </div>
                            <!-- Health Score Badge -->
                            <div class="text-center p-3 rounded-4 bg-light">
                                <span class="d-block fw-bold small text-muted text-uppercase mb-1">Score</span>
                                <div id="healthScoreBadge"
                                    class="d-flex align-items-center justify-content-center bg-dark text-white rounded-circle"
                                    style="width: 50px; height: 50px; font-weight: 800;">
                                    <span id="healthScoreVal">--</span>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h4 id="dishTitle" class="fw-bold text-dark mb-2">Plato Detectado</h4>
                            <p id="dishDescription" class="text-muted mb-3"
                                style="font-size: 0.95rem; line-height: 1.6;">...</p>

                            <div id="verdictBadge"
                                class="d-inline-block px-3 py-1 rounded-pill bg-light text-dark fw-bold small border">
                                --
                            </div>
                        </div>

                        <div class="mt-3 pt-3 border-top">
                            <div
                                class="d-flex align-items-center gap-2 text-dark bg-warning bg-opacity-10 p-3 rounded-3">
                                <span class="material-symbols-outlined text-warning">tips_and_updates</span>
                                <small class="fw-bold" id="improvementTip">...</small>
                            </div>
                        </div>

                        <button class="btn btn-dark w-100 mt-3 rounded-pill fw-bold py-2" onclick="showCalendarModal()">
                            <span class="material-symbols-outlined align-middle fs-5 me-1">calendar_today</span>
                            Guardar en Diario
                        </button>
                    </div>

                    <!-- 2. Macros Grid -->
                    <div class="row g-2">
                        <div class="col-3">
                            <div class="stats-card-minimal text-center py-3 px-1">
                                <span class="stats-label" style="font-size: 0.65rem;">PROTEÍNA</span>
                                <h5 id="totalProtein" class="fw-bold text-dark mb-0">0g</h5>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="stats-card-minimal text-center py-3 px-1">
                                <span class="stats-label" style="font-size: 0.65rem;">CARBOS</span>
                                <h5 id="totalCarbs" class="fw-bold text-dark mb-0">0g</h5>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="stats-card-minimal text-center py-3 px-1">
                                <span class="stats-label" style="font-size: 0.65rem;">GRASAS</span>
                                <h5 id="miniFatVal" class="fw-bold text-dark mb-0">0g</h5>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="stats-card-minimal text-center py-3 px-1">
                                <span class="stats-label" style="font-size: 0.65rem;">FIBRA</span>
                                <h5 id="totalFiber" class="fw-bold text-dark mb-0">0g</h5>
                            </div>
                        </div>
                    </div>

                    <!-- 3. DETAILED MICROS & INGREDIENTS TABS -->
                    <div class="analyzer-card p-4 flex-grow-1">
                        <ul class="nav nav-pills nav-fill mb-3 p-1 bg-light rounded-pill" id="detailsTab" role="tablist"
                            style="max-width: 100%;">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active rounded-pill fw-bold py-2 small text-dark" id="ing-tab"
                                    data-bs-toggle="pill" data-bs-target="#ing-content" type="button"
                                    role="tab">Ingredientes</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link rounded-pill fw-bold py-2 small text-dark" id="micro-tab"
                                    data-bs-toggle="pill" data-bs-target="#micro-content" type="button"
                                    role="tab">Micronutrientes</button>
                            </li>
                        </ul>

                        <div class="tab-content" id="detailsTabContent">
                            <div class="tab-pane fade show active" id="ing-content" role="tabpanel">
                                <div id="ingredientsList" class="d-flex flex-column gap-2 overflow-auto custom-scroll"
                                    style="max-height: 200px;">
                                    <!-- Injected -->
                                </div>
                            </div>
                            <div class="tab-pane fade" id="micro-content" role="tabpanel">
                                <div id="microsList" class="row g-2">
                                    <!-- Injected -->
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Analysis Display Logic
    // window.displayAnalysis is defined here, but main initialization happens below.

    window.displayAnalysis = function (analysis) {
        const emptyState = document.getElementById('emptyAnalysisState');
        const resultContent = document.getElementById('analysisResultContent');
        if (emptyState) emptyState.classList.add('d-none');
        if (resultContent) {
            resultContent.classList.remove('d-none');
            resultContent.classList.add('d-flex');
        }

        const updateText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };

        // Header
        // Header
        updateText('totalCalories', analysis.calorias || 0);
        updateText('dishTitle', analysis.titulo || 'Plato Analizado');
        updateText('dishDescription', analysis.descripcion || 'Sin descripción disponible.');
        updateText('healthScoreVal', analysis.score_saludable || '-');
        updateText('verdictBadge', analysis.veredicto_corto ? `<span class="material-symbols-outlined fs-6">verified</span> ${analysis.veredicto_corto}` : 'Análisis Completo');
        updateText('improvementTip', analysis.consejo_mejora || 'Mantén una dieta balanceada.');

        // Vibe animation for Score Ring
        const scorePath = document.getElementById('scoreCirclePath');
        if (scorePath && analysis.score_saludable) {
            // Reset stroke
            scorePath.style.strokeDasharray = "0, 100";
            setTimeout(() => {
                const score = parseInt(analysis.score_saludable);
                scorePath.style.transition = "stroke-dasharray 1.5s ease-out";
                scorePath.style.strokeDasharray = `${score}, 100`;

                // Color based on score
                if (score >= 80) scorePath.style.stroke = "#10b981"; // Emerald
                else if (score >= 50) scorePath.style.stroke = "#f59e0b"; // Amber
                else scorePath.style.stroke = "#ef4444"; // Red
            }, 100);
        }

        // Macros icons injection is automatic via CSS borders now, just values
        updateText('totalProtein', (analysis.proteinas || 0) + 'g');
        updateText('totalCarbs', (analysis.carbohidratos || 0) + 'g');
        updateText('miniFatVal', (analysis.grasas || 0) + 'g');
        updateText('totalFiber', (analysis.fibra || 0) + 'g');

        // Ingredients
        const ingredientsList = document.getElementById('ingredientsList');
        if (ingredientsList) {
            if (analysis.ingredientes && analysis.ingredientes.length > 0) {
                ingredientsList.innerHTML = analysis.ingredientes.map(ing => `
                    <div class="d-flex align-items-center gap-3 p-3 rounded-4 border border-light mb-1 bg-white">
                        <div class="flex-grow-1">
                            <h6 class="mb-0 fw-bold text-dark fs-6">${ing.nombre || ing}</h6>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">${ing.cantidad || ''}</small>
                                ${ing.calorias_aprox ? `<small class="text-muted fw-bold">${ing.calorias_aprox} kcal</small>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                ingredientsList.innerHTML = '<p class="text-muted small px-3">No se detectaron ingredientes específicos.</p>';
            }
        }

        // Micros
        const microsList = document.getElementById('microsList');
        if (microsList && analysis.micronutrientes) {
            const m = analysis.micronutrientes;
            // Lista de micros a mostrar si existen
            const items = [
                { label: 'Vit. A', val: m.vitamina_a_iu, unit: 'IU' },
                { label: 'Vit. C', val: m.vitamina_c_mg, unit: 'mg' },
                { label: 'Calcio', val: m.calcio_mg, unit: 'mg' },
                { label: 'Hierro', val: m.hierro_mg, unit: 'mg' },
                { label: 'Potasio', val: m.potasio_mg, unit: 'mg' },
                { label: 'Sodio', val: analysis.sodio_mg, unit: 'mg' },
                { label: 'Azúcar', val: analysis.azucar, unit: 'g' },
            ];

            microsList.innerHTML = items.map(item => {
                if (!item.val) return '';
                return `
                        <div class="col-6 col-md-4">
                            <div class="p-2 border rounded-3 text-center bg-light">
                                <small class="d-block text-muted text-uppercase" style="font-size: 0.65rem;">${item.label}</small>
                                <span class="fw-bold text-dark">${item.val}${item.unit}</span>
                            </div>
                        </div>
                     `;
            }).join('');

            if (microsList.innerHTML === '') microsList.innerHTML = '<p class="text-muted small text-center w-100">Sin datos significativos de micronutrientes.</p>';
        }
    };
</script>

<!-- Consumption Modal Glass -->
<div class="modal-overlay" id="consumptionModal">
    <div class="modal-glass text-center">
        <div class="mb-4">
            <span class="material-symbols-outlined text-success" style="font-size: 64px;">check_circle</span>
            <h3 class="fw-bold mt-2 text-dark">¿Registrar consumo?</h3>
            <p class="text-muted">Se añadirán <strong id="modalCalVal">0</strong> kcal a tu progreso de hoy.</p>
        </div>

        <div class="d-flex flex-column gap-3">
            <button
                class="btn btn-nunut w-100 rounded-pill py-3 fw-bold shadow-lg d-flex justify-content-center align-items-center gap-2"
                id="btnConfirmToday" onclick="registerMealNow()">
                <span class="material-symbols-outlined">today</span>
                Sí, lo comí hoy
            </button>

            <button class="btn btn-light w-100 rounded-pill py-3 fw-bold text-muted border"
                onclick="showDatePickerState()">
                Fue otro día...
            </button>

            <button class="btn btn-link text-muted text-decoration-none mt-2" onclick="hideConsumptionModal()">
                Cancelar
            </button>
        </div>

        <!-- Date Picker State (Hidden by default) -->
        <div id="datePickerState" class="d-none mt-4 pt-4 border-top">
            <h5 class="fw-bold text-dark mb-3">Elige la fecha</h5>
            <div class="d-flex gap-2 overflow-auto pb-3 mb-3" id="miniCalendarDays"
                style="scrollbar-width: none; -ms-overflow-style: none;">
                <!-- Injected via JS -->
            </div>
            <button class="btn btn-dark w-100 rounded-pill py-2 fw-bold" onclick="registerMealCustomDate()">
                Guardar en fecha seleccionada
            </button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<script>
    if (typeof window.analizadorIniciado === 'undefined') {
        window.analizadorIniciado = true;

        // --- Global Config & State ---
        window.isRecording = window.isRecording || false;
        window.mediaRecorder = window.mediaRecorder || null;
        window.audioChunks = window.audioChunks || [];
        window.currentAnalysis = window.currentAnalysis || null;
        window.selectedDate = window.selectedDate || new Date().toISOString().split('T')[0];
        window.audioContext = window.audioContext || null;
        window.analyser = window.analyser || null;
        window.animationId = window.animationId || null;
        window.recognition = window.recognition || null;

        window.initRecognition = function () {
            if (window.recognition) return;
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
                window.recognition = new SpeechRec();
                window.recognition.continuous = true;
                window.recognition.interimResults = true;
                window.recognition.lang = 'es-ES';
                window.recognition.onresult = (e) => {
                    let fullText = '';
                    for (let i = 0; i < e.results.length; i++) fullText += e.results[i][0].transcript + ' ';
                    const el = document.getElementById('transcriptionText');
                    if (el) {
                        el.textContent = fullText;
                        el.classList.add('fw-bold', 'text-dark');
                    }
                    const analyzeBtn = document.getElementById('analyzeMainBtn');
                    if (analyzeBtn && fullText.trim().length > 5) analyzeBtn.classList.remove('d-none');
                };
            }
        };
        window.initRecognition();

        // --- Core Interaction Functions ---
        window.switchMode = function (mode) {
            const wrapper = document.querySelector('.mode-toggle-wrapper');
            if (wrapper) wrapper.setAttribute('data-mode', mode);

            const vContainer = document.getElementById('voice-container');
            const tContainer = document.getElementById('text-container');
            const btnV = document.getElementById('btnVoice');
            const btnT = document.getElementById('btnText');

            if (mode === 'voice') {
                if (vContainer) vContainer.classList.remove('d-none');
                if (tContainer) tContainer.classList.add('d-none');
                if (btnV) btnV.classList.add('active');
                if (btnT) btnT.classList.remove('active');
            } else {
                if (vContainer) vContainer.classList.add('d-none');
                if (tContainer) tContainer.classList.remove('d-none');
                if (btnV) btnV.classList.remove('active');
                if (btnT) btnT.classList.add('active');
            }
        };

        window.toggleVoiceRecording = async function () {
            if (window.isRecording) {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        };

        async function startVoiceRecording() {
            const micButton = document.getElementById('micButton');
            const micWrapper = document.getElementById('micWrapper');
            const voiceStatus = document.getElementById('voiceStatus');
            const listeningIndicator = document.getElementById('listeningIndicator');

            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error("HTTPS requerido para grabar.");
                }

                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: { echoCancellation: true, noiseSuppression: true }
                });

                window.isRecording = true;
                if (micButton) micButton.classList.add('listening');
                if (micWrapper) micWrapper.classList.add('recording-active');
                if (voiceStatus) voiceStatus.textContent = 'Estamos escuchando...';

                const recInd = document.getElementById('recordingIndicator');
                if (recInd) recInd.classList.remove('d-none');

                if (navigator.vibrate) navigator.vibrate(50);

                // --- VISUALIZER ---
                try {
                    window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    window.analyser = window.audioContext.createAnalyser();
                    const source = window.audioContext.createMediaStreamSource(stream);
                    source.connect(window.analyser);
                    window.analyser.fftSize = 256;
                    const bufferLength = window.analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);

                    let smoothedAverage = 0;
                    const updateVisuals = () => {
                        if (!window.isRecording) return;
                        window.analyser.getByteFrequencyData(dataArray);
                        let sum = 0;
                        for (let i = 0; i < bufferLength; i++) sum += dataArray[i];
                        const average = sum / bufferLength;
                        smoothedAverage += (average - smoothedAverage) * 0.15;
                        const scale = 1 + (smoothedAverage / 120);

                        if (micButton) micButton.style.transform = `scale(${scale})`;
                        window.animationId = requestAnimationFrame(updateVisuals);
                    };
                    updateVisuals();
                } catch (vizErr) {
                    console.warn("Visualizer failed:", vizErr);
                }

                if (window.recognition) {
                    try { window.recognition.start(); } catch (e) { }
                }

                const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/ogg';
                window.mediaRecorder = new MediaRecorder(stream, { mimeType });
                window.audioChunks = [];

                window.mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) window.audioChunks.push(e.data); };
                window.mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(window.audioChunks, { type: mimeType });
                    await sendAudioToServer(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                window.mediaRecorder.start();

            } catch (err) {
                console.error("Grabación fallida:", err);
                window.isRecording = false;
                if (micButton) micButton.classList.remove('listening');
                if (micWrapper) micWrapper.classList.remove('recording-active');
                if (voiceStatus) voiceStatus.textContent = 'Error';
                if (typeof showToast === 'function') showToast(err.message, 'error');
            }
        }

        function stopVoiceRecording() {
            if (window.mediaRecorder && window.mediaRecorder.state !== 'inactive') {
                window.mediaRecorder.stop();
                if (window.recognition) try { window.recognition.stop(); } catch (e) { }
                window.isRecording = false;
                if (window.animationId) cancelAnimationFrame(window.animationId);
                if (window.audioContext) window.audioContext.close();

                const micButton = document.getElementById('micButton');
                const micWrapper = document.getElementById('micWrapper');
                if (micButton) {
                    micButton.classList.remove('listening');
                    micButton.style.transform = '';
                }
                if (micWrapper) micWrapper.classList.remove('recording-active');

                const recInd = document.getElementById('recordingIndicator');
                if (recInd) recInd.classList.add('d-none');

                const voiceStatus = document.getElementById('voiceStatus');
                if (voiceStatus) voiceStatus.textContent = 'Procesando...';
            }
        }

        async function sendAudioToServer(blob) {
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrfToken = csrfInput ? csrfInput.value : '';
            const formData = new FormData();
            formData.append('audio_file', blob, 'recording.webm');

            console.log('Fetching URL:', '/api/transcribir_audio/');

            // Feedback inmediato
            const el = document.getElementById('transcriptionText');
            if (el) {
                el.textContent = "Transcribiendo audio...";
                el.style.opacity = "0.7";
            }

            try {
                const response = await fetch('/api/transcribir_audio/', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken },
                    body: formData
                });

                const data = await response.json().catch(() => ({ success: false, error: "Respuesta inválida" }));

                if (response.ok && data.success) {
                    const el = document.getElementById('transcriptionText');
                    if (el && data.text) {
                        el.textContent = data.text;
                        el.classList.add('fw-bold', 'text-dark');
                    }
                    const voiceStatus = document.getElementById('voiceStatus');
                    if (voiceStatus) voiceStatus.textContent = '¡Listo!';

                    const analyzeBtn = document.getElementById('analyzeMainBtn');
                    if (analyzeBtn) analyzeBtn.classList.remove('d-none');

                    if (data.analisis) window.currentAnalysis = data.analisis;
                } else {
                    if (data.error_type === 'QUOTA_EXCEEDED') {
                        if (typeof showError === 'function') showError('⏳ ' + data.error);
                    } else {
                        const el = document.getElementById('transcriptionText');
                        if (el && data.text) el.textContent = data.text;
                    }
                }
            } catch (error) {
                console.error("Transcription error:", error);
                if (typeof showError === 'function') showError('❌ Error al transcribir');
            }
        }

        window.analyzeFood = async function () {
            const textContainer = document.getElementById('text-container');
            let description = "";

            if (textContainer && !textContainer.classList.contains('d-none')) {
                const input = document.getElementById('textInput');
                description = input ? input.value : "";
            } else {
                const el = document.getElementById('transcriptionText');
                description = el ? el.textContent : "";
                description = description.replace('Tu transcripción aparecerá aquí...', '').trim();
            }
            await performAnalysis(description);
        };

        async function performAnalysis(description) {
            if (!description) {
                if (typeof showError === 'function') showError('Por favor describe tu comida primero.');
                return;
            }
            if (typeof showToast === 'function') showToast('Analizando tu plato...', 'info');

            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrfToken = csrfInput ? csrfInput.value : '';

            try {
                const response = await fetch('/api/analizar_comida_ia/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ descripcion: description })
                });

                const data = await response.json().catch(() => ({ success: false, error: "Error de formato" }));

                if (data.success) {
                    window.currentAnalysis = data.analisis;
                    if (typeof displayAnalysis === 'function') displayAnalysis(data.analisis);
                    if (typeof showToast === 'function') showToast('¡Análisis completado!', 'success');
                } else {
                    if (typeof showError === 'function') showError(data.error || 'Error al procesar');
                }
            } catch (error) {
                if (typeof showError === 'function') showError('Error de red o servidor.');
            }
        }

        // --- NEW CONSUMPTION LOGIC ---
        window.confirmConsumption = function () {
            if (!window.currentAnalysis) return;
            const valEl = document.getElementById('modalCalVal');
            if (valEl) valEl.textContent = window.currentAnalysis.calorias || 0;

            const modal = document.getElementById('consumptionModal');
            if (modal) modal.classList.add('show');

            const dp = document.getElementById('datePickerState');
            if (dp) dp.classList.add('d-none');

            window.selectedDate = new Date().toISOString().split('T')[0];
        };

        window.hideConsumptionModal = function () {
            const modal = document.getElementById('consumptionModal');
            if (modal) modal.classList.remove('show');
        };

        window.showDatePickerState = function () {
            const dp = document.getElementById('datePickerState');
            if (dp) dp.classList.remove('d-none');
            renderMiniCalendar();
        };

        window.registerMealNow = function () {
            window.selectedDate = new Date().toISOString().split('T')[0];
            executeRegister();
        };

        window.registerMealCustomDate = function () {
            if (!window.selectedDate) {
                if (typeof showToast === 'function') showToast('Selecciona una fecha', 'warning');
                return;
            }
            executeRegister();
        };

        async function executeRegister() {
            if (!window.currentAnalysis) return;
            if (typeof showToast === 'function') showToast('Guardando consumo...', 'info');

            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrfToken = csrfInput ? csrfInput.value : '';

            try {
                const response = await fetch('/api/guardar_comida/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fecha: window.selectedDate,
                        nombre: window.currentAnalysis.titulo || 'Comida Analizada',
                        calorias: window.currentAnalysis.calorias || 0,
                        proteinas: window.currentAnalysis.proteinas || 0,
                        carbos: window.currentAnalysis.carbohidratos || 0,
                        grasas: window.currentAnalysis.grasas || 0,
                        hora: new Date().toTimeString().split(' ')[0]
                    })
                });
                const data = await response.json();
                if (data.success) {
                    if (typeof showToast === 'function') showToast('¡Registrado!', 'success');
                    hideConsumptionModal();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    if (typeof showError === 'function') showError('Error: ' + data.error);
                }
            } catch (error) {
                if (typeof showError === 'function') showError('Error de servidor.');
            }
        }

        // --- Render Helpers ---
        window.renderMiniCalendar = function () {
            const container = document.getElementById('miniCalendarDays');
            if (!container) return;
            container.innerHTML = '';
            const days = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            const today = new Date();

            for (let i = -6; i <= 0; i++) {
                const date = new Date();
                date.setDate(today.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = i === 0;

                const chip = document.createElement('div');
                chip.className = `date-chip-glass flex-shrink-0 ${isToday ? 'selected' : ''}`;
                if (isToday) window.selectedDate = dateStr;

                chip.dataset.date = dateStr;
                chip.onclick = function () {
                    document.querySelectorAll('.date-chip-glass').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    window.selectedDate = dateStr;
                };
                chip.innerHTML = `
                    <small class="d-block text-muted mb-1" style="font-size: 0.75rem;">${isToday ? 'Hoy' : days[date.getDay()]}</small>
                    <span class="day-number fw-bold fs-4">${date.getDate()}</span>
                `;
                container.appendChild(chip);
            }
            setTimeout(() => container.scrollLeft = container.scrollWidth, 100);
        };

        // --- Basic UI ---
        // --- Basic UI ---
        window.showError = function (msg) {
            const alert = document.getElementById('errorAlert');
            const text = document.getElementById('errorMsgText');
            if (alert && text) {
                text.textContent = msg;
                alert.classList.remove('d-none');
                // alert.scrollIntoView({ behavior: 'smooth', block: 'center' }); // Optional
            }
            if (typeof showToast === 'function') showToast(msg, 'error');
        };

        window.showToast = function (msg, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `custom-toast`;

            let icon = 'info';
            let color = 'text-primary';

            if (type === 'success') { icon = 'check_circle'; color = 'text-success'; }
            if (type === 'error') { icon = 'error'; color = 'text-danger'; }
            if (type === 'warning') { icon = 'warning'; color = 'text-warning'; }

            toast.innerHTML = `
                <span class="material-symbols-outlined ${color}">${icon}</span>
                <span class="fw-bold small flex-grow-1">${msg}</span>
            `;

            container.appendChild(toast);

            // Auto remove
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(10px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

    } // End Init Check

    // --- RE-INIT LOGIC FOR HTMX SWAPS ---
    window.isRecording = false;

    // Restore UI state
    const micBtn = document.getElementById('micButton');
    if (micBtn) {
        micBtn.classList.remove('listening');
        micBtn.style.transform = '';
    }
    const recInd = document.getElementById('recordingIndicator');
    if (recInd) recInd.classList.add('d-none');

    // Re-bind recognition
    if (window.initRecognition) window.initRecognition();

    // Re-bind Bootstrap Tabs
    document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(pill => {
        pill.addEventListener('shown.bs.tab', (e) => {
            // Optional analytics hook
        });
    });

</script>
{% endblock %}