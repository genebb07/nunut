{% extends base_template %}
{% load static %}

{% block title %}Analizador Nutricional - nunut{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
    rel="stylesheet">
<style>
    :root {
        --primary-lime: #85c81a;
        --primary-dark: #65a30d;
    }

    /* Glass Effect Utilities */
    .glass-panel {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
    }

    .nav-capsule-glass {
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(8px);
    }

    .nav-capsule-glass .nav-link {
        color: #64748b;
        transition: all 0.3s ease;
    }

    .nav-capsule-glass .nav-link:hover {
        background: rgba(0, 0, 0, 0.02);
        color: #334155;
    }

    .nav-capsule-glass .nav-link.active {
        background: white;
        color: var(--primary-lime);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    /* Mic Button */
    .mic-button-glass {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ffffff, #f0fdf4);
        border: 1px solid rgba(133, 200, 26, 0.1);
        color: var(--primary-lime);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        z-index: 10;
    }

    .mic-button-glass:hover {
        transform: scale(1.1);
        box-shadow: 0 10px 40px rgba(133, 200, 26, 0.2);
        color: var(--primary-dark);
    }

    .mic-button-glass.listening {
        background: var(--primary-lime) !important;
        background-image: none !important;
        color: white !important;
        border-color: var(--primary-lime) !important;
        box-shadow: 0 10px 30px rgba(133, 200, 26, 0.4);
        transform: scale(1.15);
    }

    .mic-icon {
        font-size: 40px;
        transition: transform 0.3s ease;
    }

    .mic-button-glass.listening .mic-icon {
        animation: pulse-icon 1s infinite alternate;
    }

    @keyframes pulse-icon {
        from {
            transform: scale(1);
        }

        to {
            transform: scale(1.2);
        }
    }

    /* Pulse Rings */
    .ring-pulse {
        position: absolute;
        border-radius: 50%;
        border: 2px solid var(--primary-lime);
        opacity: 0;
        transform: scale(0.5);
    }

    .mic-button-glass.listening~.position-absolute .ring-pulse {
        animation: ripple 2s infinite cubic-bezier(0, 0.2, 0.8, 1);
    }

    @keyframes ripple {
        0% {
            transform: scale(0.3);
            opacity: 0.5;
            border-width: 4px;
        }

        100% {
            transform: scale(1.2);
            opacity: 0;
            border-width: 0px;
        }
    }

    .transcription-glass {
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(0, 0, 0, 0.03);
        transition: all 0.3s ease;
    }

    /* Custom Scrollbar for Ingredients */
    #ingredientsList::-webkit-scrollbar {
        width: 6px;
    }

    #ingredientsList::-webkit-scrollbar-track {
        background: transparent;
    }

    #ingredientsList::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
    }

    body.dark-mode .desktop-header {
        background: rgba(20, 20, 20, 0.8) !important;
    }

    body.dark-mode h1,
    body.dark-mode h2,
    body.dark-mode h3,
    body.dark-mode h4,
    body.dark-mode h5,
    body.dark-mode p,
    body.dark-mode span,
    body.dark-mode div {
        color: #e5e7eb !important;
    }

    body.dark-mode .text-muted {
        color: #9ca3af !important;
    }

    body.dark-mode .card {
        background: #1f2937 !important;
        border-color: rgba(255, 255, 255, 0.05);
    }

    body.dark-mode .transcription-glass {
        background: rgba(0, 0, 0, 0.3);
        border-color: rgba(255, 255, 255, 0.05);
    }

    body.dark-mode .nav-capsule-glass {
        background: rgba(0, 0, 0, 0.3);
        border-color: rgba(255, 255, 255, 0.05) !important;
    }

    body.dark-mode .mic-button-glass {
        background: linear-gradient(135deg, #374151, #1f2937);
        border-color: rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .nav-link.active {
        background: #374151 !important;
        color: var(--primary-lime) !important;
    }

    /* Modal Glass */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .modal-overlay.show {
        display: flex;
        opacity: 1;
    }

    .modal-glass {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 32px;
        padding: 2.5rem;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        transform: scale(0.95);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-overlay.show .modal-glass {
        transform: scale(1);
    }

    /* Date Chips */
    .date-chip-glass {
        min-width: 100px;
        background: #f8fafc;
        border: 2px solid transparent;
        border-radius: 20px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }

    .date-chip-glass:hover {
        background: #f1f5f9;
        transform: translateY(-2px);
    }

    .date-chip-glass.selected {
        background: #dcfce7;
        border-color: var(--primary-lime);
        color: #166534;
    }

    body.dark-mode .modal-glass {
        background: #1f2937;
        border-color: rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .date-chip-glass {
        background: #374151;
        color: #e5e7eb;
    }

    body.dark-mode .date-chip-glass.selected {
        background: rgba(133, 200, 26, 0.2);
        color: var(--primary-lime);
        border-color: var(--primary-lime);
    }
</style>
{% endblock %}

{% block container_class %}container-fluid analyzer-container py-4{% endblock %}

{% block content %}

<!-- Header with Glassmorphism -->
<div class="desktop-header d-flex justify-content-between align-items-center mb-5 p-4 rounded-4 shadow-sm"
    style="background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);">
    <div>
        <h1 class="h2 fw-bolder mb-1 text-dark" style="letter-spacing: -0.5px;">Analizador IA</h1>
        <p class="text-muted mb-0 fw-medium">Escanea o describe tus comidas para un análisis nutricional preciso.</p>
    </div>
    <div class="d-flex align-items-center gap-3">
        <span class="badge rounded-pill bg-light text-dark border px-3 py-2 fw-bold d-flex align-items-center gap-2">
            <span class="material-symbols-outlined text-success" style="font-size: 18px;">database</span>
            Base Local + Gemini 1.5
        </span>
    </div>
</div>

<div class="row g-4">
    <!-- Input Section (Left) -->
    <div class="col-12 col-xl-7">
        <div class="card border-0 shadow-lg rounded-5 overflow-hidden position-relative h-100"
            style="background: linear-gradient(145deg, #ffffff, #f5f7fa);">

            <!-- Tab Navigation Capsules -->
            <div class="d-flex justify-content-center pt-4 pb-2">
                <ul class="nav nav-pills nav-capsule-glass p-1 rounded-pill bg-light border" role="tablist">
                    <li class="nav-item m-1" role="presentation">
                        <button class="nav-link active rounded-pill px-4 fw-bold d-flex align-items-center gap-2"
                            data-bs-toggle="pill" data-bs-target="#voice-tab" type="button" role="tab">
                            <span class="material-symbols-outlined">mic</span> Voz
                        </button>
                    </li>
                    <li class="nav-item m-1" role="presentation">
                        <button class="nav-link rounded-pill px-4 fw-bold d-flex align-items-center gap-2"
                            data-bs-toggle="pill" data-bs-target="#text-tab" type="button" role="tab">
                            <span class="material-symbols-outlined">keyboard</span> Texto
                        </button>
                    </li>
                </ul>
            </div>

            <div class="tab-content h-100 d-flex flex-column">
                <!-- Voice Tab -->
                <div class="tab-pane fade show active p-4 flex-grow-1 d-flex flex-column align-items-center justify-content-center text-center position-relative"
                    id="voice-tab" role="tabpanel">

                    <!-- Pulse Rings Background -->
                    <div class="position-absolute top-50 start-50 translate-middle w-100 h-100 d-flex align-items-center justify-content-center"
                        style="z-index: 0; pointer-events: none; opacity: 0.5;">
                        <div class="ring-pulse" style="width: 300px; height: 300px;"></div>
                        <div class="ring-pulse" style="width: 450px; height: 450px; animation-delay: 0.5s;"></div>
                    </div>

                    <div class="position-relative z-1 mb-4">
                        <button class="mic-button-glass d-flex align-items-center justify-content-center shadow-lg"
                            id="micButton" onclick="toggleVoiceRecording()">
                            <span class="material-symbols-outlined mic-icon">mic</span>
                        </button>
                    </div>

                    <h2 class="fw-bolder mb-2 text-dark" id="voiceStatus" style="letter-spacing: -0.5px;">Toca para
                        grabar</h2>
                    <p class="text-muted fw-medium mb-4" id="voiceHint" style="max-width: 400px;">
                        "He comido 150g de pollo a la plancha con 200g de arroz blanco y aguacate..."
                    </p>

                    <!-- Live Transcription Box -->
                    <div class="transcription-glass w-100 p-4 rounded-4 text-start mb-3 position-relative overflow-hidden"
                        style="min-height: 120px; max-width: 550px;">
                        <div id="listeningIndicator"
                            class="position-absolute top-0 end-0 m-3 px-2 py-1 rounded-pill bg-success bg-opacity-10 text-success fw-bold d-flex align-items-center gap-2"
                            style="font-size: 0.7rem; display: none !important;">
                            <div class="spinner-grow spinner-grow-sm" role="status"></div> GRABANDO
                        </div>
                        <p id="transcriptionText" class="mb-0 fw-medium text-dark h5"
                            style="line-height: 1.6; color: #4b5563;">
                            <span class="text-muted opacity-50">Tu transcripción aparecerá aquí...</span>
                        </p>
                    </div>

                    <div class="d-flex gap-2 w-100 justify-content-center" style="max-width: 550px;">
                        <button
                            class="btn btn-dark rounded-pill py-3 px-5 flex-grow-1 fw-bold shadow-lg d-none align-items-center justify-content-center gap-2"
                            id="analyzeVoiceBtn" onclick="analyzeFood()">
                            <span class="material-symbols-outlined">auto_awesome</span> ANALIZAR
                        </button>
                    </div>
                </div>

                <!-- Text Tab -->
                <div class="tab-pane fade p-5 h-100" id="text-tab" role="tabpanel">
                    <h3 class="fw-bolder mb-3 text-dark">Escribe tu comida</h3>
                    <div class="position-relative">
                        <textarea
                            class="form-control form-control-lg border-0 bg-light rounded-4 p-4 shadow-inner text-input-modern"
                            id="textInput" placeholder="Ej: 2 huevos revueltos con jamón y una tostada integral..."
                            style="min-height: 250px; resize: none;"></textarea>
                        <button
                            class="btn btn-dark position-absolute bottom-0 end-0 m-3 rounded-pill px-4 py-2 fw-bold shadow-sm d-flex align-items-center gap-2"
                            onclick="analyzeFood()">
                            Analizar <span class="material-symbols-outlined"
                                style="font-size: 18px;">arrow_forward</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Output Section (Right) -->
    <div class="col-12 col-xl-5">
        <!-- Empty State -->
        <div id="emptyAnalysisState"
            class="card border-0 shadow-sm rounded-5 h-100 d-flex align-items-center justify-content-center p-5 text-center bg-white">
            <div class="mb-4 bg-light rounded-circle p-4 d-inline-flex">
                <span class="material-symbols-outlined text-muted" style="font-size: 48px;">restaurant_menu</span>
            </div>
            <h4 class="fw-bold text-dark mb-2">Esperando comida</h4>
            <p class="text-muted text-balance">Usa el micrófono o escribe para obtener un desglose nutricional detallado
                al instante.</p>
        </div>

        <!-- Result Content (Hidden by default) -->
        <div id="analysisResultContent" class="d-none h-100 d-flex flex-column gap-3">

            <!-- Main Macros Card -->
            <div class="card border-0 shadow-lg rounded-5 overflow-hidden text-white position-relative"
                style="background: linear-gradient(135deg, #111827 0%, #1f2937 100%);">
                <div class="position-absolute top-0 end-0 p-3 opacity-25">
                    <span class="material-symbols-outlined"
                        style="font-size: 120px; transform: rotate(-15deg) translate(20px, -20px);">bolt</span>
                </div>
                <div class="card-body p-4 position-relative z-1">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span
                            class="badge bg-white bg-opacity-10 backdrop-blur border border-white border-opacity-10 text-white px-3 py-2 rounded-pill">
                            Total Energético
                        </span>
                        <button class="btn btn-success rounded-pill px-3 py-1 fw-bold fs-7 shadow-lg border-0"
                            onclick="showCalendarModal()">
                            <i class="fas fa-plus me-1"></i> Guardar
                        </button>
                    </div>
                    <div class="d-flex align-items-baseline gap-2 mb-4">
                        <h2 class="display-3 fw-bolder mb-0" id="totalCalories">0</h2>
                        <span class="h4 text-white text-opacity-75">kcal</span>
                    </div>

                    <!-- Mini Macro Bars -->
                    <div class="d-flex gap-2 mt-auto">
                        <div class="flex-grow-1 p-2 rounded-3 bg-white bg-opacity-10 backdrop-blur">
                            <span class="d-block text-white text-opacity-50 fs-7 fw-bold mb-1">PROT</span>
                            <span class="fw-bolder fs-5" id="miniProtVal">0g</span>
                        </div>
                        <div class="flex-grow-1 p-2 rounded-3 bg-white bg-opacity-10 backdrop-blur">
                            <span class="d-block text-white text-opacity-50 fs-7 fw-bold mb-1">CARB</span>
                            <span class="fw-bolder fs-5" id="miniCarbVal">0g</span>
                        </div>
                        <div class="flex-grow-1 p-2 rounded-3 bg-white bg-opacity-10 backdrop-blur">
                            <span class="d-block text-white text-opacity-50 fs-7 fw-bold mb-1">GRAS</span>
                            <span class="fw-bolder fs-5" id="miniFatVal">0g</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Stats Grid -->
            <div class="row g-3">
                <div class="col-6">
                    <div class="card border-0 shadow-sm rounded-4 p-3 h-100" style="background-color: #ecfdf5;">
                        <span class="fw-bold text-success mb-2 d-block fs-7">PROTEÍNA</span>
                        <h3 class="fw-bolder text-dark mb-1" id="totalProtein">0g</h3>
                        <div class="progress" style="height: 6px; background: rgba(16, 185, 129, 0.2);">
                            <div class="progress-bar bg-success" id="proteinBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card border-0 shadow-sm rounded-4 p-3 h-100" style="background-color: #eff6ff;">
                        <span class="fw-bold text-primary mb-2 d-block fs-7">CARBOHIDRATOS</span>
                        <h3 class="fw-bolder text-dark mb-1" id="totalCarbs">0g</h3>
                        <div class="progress" style="height: 6px; background: rgba(59, 130, 246, 0.2);">
                            <div class="progress-bar bg-primary" id="carbsBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ingredients List -->
            <div class="card border-0 shadow-sm rounded-4 p-4 flex-grow-1">
                <h5 class="fw-bold mb-3 d-flex align-items-center gap-2">
                    <span class="material-symbols-outlined text-muted">restaurant</span>
                    Ingredientes
                </h5>
                <div class="d-flex flex-column gap-2 overflow-auto" id="ingredientsList" style="max-height: 200px;">
                    <!-- JS injected -->
                </div>
            </div>

        </div>
    </div>
</div>


<!-- Calendar Modal Glass -->
<div class="modal-overlay" id="calendarModal">
    <div class="modal-glass">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold m-0 text-dark">¿Cuándo lo comiste?</h4>
            <button class="btn btn-sm btn-light rounded-circle shadow-sm" onclick="hideCalendarModal()">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <div class="d-flex gap-2 overflow-auto pb-3 mb-3" id="miniCalendarDays"
            style="scrollbar-width: none; -ms-overflow-style: none;">
            <!-- Days will be injected by JS -->
        </div>

        <button
            class="btn btn-dark w-100 rounded-pill py-3 fw-bold shadow-lg d-flex justify-content-center align-items-center gap-2"
            id="confirmAddBtn" onclick="confirmAddToCalendar()">
            <span class="material-symbols-outlined">check_circle</span>
            Confirmar y Añadir
        </button>
    </div>
</div>

<script>
    // Global variables
    let isRecording = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let currentAnalysis = null;
    let selectedDate = null;

    // Tab Persistence
    document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(pill => {
        pill.addEventListener('shown.bs.tab', (e) => {
            const tabId = e.target.getAttribute('data-bs-target').replace('#', '');
            const url = new URL(window.location);
            url.searchParams.set('tab', tabId);
            window.history.replaceState({}, '', url);
        });
    });

    window.addEventListener('load', () => {
        const params = new URLSearchParams(window.location.search);
        const tab = params.get('tab');
        if (tab) {
            const triggerEl = document.querySelector(`button[data-bs-target="#${tab}"]`);
            if (triggerEl) {
                if (typeof bootstrap !== 'undefined' && bootstrap.Tab) {
                    const tabTrigger = new bootstrap.Tab(triggerEl);
                    tabTrigger.show();
                } else {
                    triggerEl.click();
                }
            }
        }
    });

    // Live Transcription (UX Feedback)
    let recognition = null;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRec();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'es-ES';

        recognition.onresult = (e) => {
            let fullText = '';
            for (let i = 0; i < e.results.length; i++) {
                fullText += e.results[i][0].transcript + ' ';
            }
            const el = document.getElementById('transcriptionText');
            if (el) {
                el.textContent = fullText;
                el.classList.add('fw-bold', 'text-dark');
            }
        };

        recognition.onerror = (e) => {
            console.warn("Speech recognition error:", e.error);
        };
    }

    async function toggleVoiceRecording() {
        if (isRecording) {
            stopVoiceRecording();
        } else {
            // "Confirm bonito" antes de pedir permiso real
            showConfirmModal({
                title: 'Activar Micrófono',
                message: 'Usaremos la IA para transcribir lo que digas. ¿Deseas comenzar la grabación?',
                icon: 'mic',
                yesText: 'Empezar ahora',
                onConfirm: () => {
                    startVoiceRecording();
                }
            });
        }
    }

    // Voice Visualizer Variables
    let audioContext = null;
    let analyser = null;
    let animationId = null;

    async function startVoiceRecording() {
        const micButton = document.getElementById('micButton');
        const voiceStatus = document.getElementById('voiceStatus');
        const voiceHint = document.getElementById('voiceHint');
        const listeningIndicator = document.getElementById('listeningIndicator');

        try {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error("HTTPS o navegador moderno requerido para grabar.");
            }

            const stream = await navigator.mediaDevices.getUserMedia({
                audio: { echoCancellation: true, noiseSuppression: true }
            });

            isRecording = true;
            micButton.classList.add('listening');
            voiceStatus.textContent = 'Grabando...';
            voiceHint.textContent = 'Habla ahora, te escucho con IA.';
            listeningIndicator.style.setProperty('display', 'flex', 'important');
            if (navigator.vibrate) navigator.vibrate(50);

            // --- VOICE VISUALIZER SYNC ---
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function updateVisuals() {
                if (!isRecording) return;
                analyser.getByteFrequencyData(dataArray);

                let sum = 0;
                for (let i = 0; i < bufferLength; i++) {
                    sum += dataArray[i];
                }
                const average = sum / bufferLength;
                const scale = 1 + (average / 150); // Sensibilidad ajustable

                micButton.style.transform = `scale(${Math.max(1.15, scale)})`;

                // Actualizar anillos de pulso
                document.querySelectorAll('.ring-pulse').forEach((ring, index) => {
                    const ringScale = scale * (1 + (index * 0.2));
                    ring.style.transform = `scale(${ringScale})`;
                    ring.style.opacity = (average / 255) + (0.2 / (index + 1));
                });

                animationId = requestAnimationFrame(updateVisuals);
            }
            updateVisuals();
            // -----------------------------

            // Start Live Text Feedback (Optional UX)
            if (recognition) {
                try {
                    recognition.start();
                } catch (e) {
                    console.warn("Speech recognition network skip:", e);
                    const el = document.getElementById('transcriptionText');
                    if (el) el.textContent = "Dictado en vivo no disponible (red), el análisis de alta calidad se verá al finalizar...";
                }
            }

            // MediaRecorder for high quality audio
            const types = ['audio/webm;codecs=opus', 'audio/webm', 'audio/mp4', 'audio/wav'];
            const supportedType = types.find(type => MediaRecorder.isTypeSupported(type));

            mediaRecorder = new MediaRecorder(stream, supportedType ? { mimeType: supportedType } : {});
            audioChunks = [];

            mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: supportedType || 'audio/webm' });
                await sendAudioToServer(audioBlob);
                stream.getTracks().forEach(track => track.stop());
            };

            mediaRecorder.start();

        } catch (err) {
            console.error("Grabación fallida:", err);
            isRecording = false;
            micButton.classList.remove('listening');
            voiceStatus.textContent = 'Error de micro';
            showToast(err.message, 'error');
        }
    }

    function stopVoiceRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            if (recognition) try { recognition.stop(); } catch (e) { }
            isRecording = false;

            // Detener visualizador
            if (animationId) cancelAnimationFrame(animationId);
            if (audioContext) audioContext.close();

            const micButton = document.getElementById('micButton');
            micButton.classList.remove('listening');
            micButton.style.transform = ''; // Reset scale

            document.getElementById('voiceStatus').textContent = 'Procesando...';
            document.getElementById('listeningIndicator').style.setProperty('display', 'none', 'important');
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function sendAudioToServer(blob) {
        const formData = new FormData();
        formData.append('audio_file', blob, 'recording.webm');
        try {
            const response = await fetch('/api/transcribir_audio/', {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('csrftoken') },
                body: formData
            });
            const data = await response.json();
            if (data.success && data.text) {
                const el = document.getElementById('transcriptionText');
                el.textContent = data.text;
                el.classList.add('fw-bold', 'text-dark');
                document.getElementById('voiceStatus').textContent = '¡Listo!';
                document.getElementById('analyzeVoiceBtn').classList.replace('d-none', 'd-flex');
            } else if (data.success && !data.text) {
                showToast('No se detectó voz clara.', 'warning');
                resetVoiceUI();
            } else { throw new Error(data.error); }
        } catch (error) {
            console.error("Server transcription error:", error);
            showToast('Error de servidor: ' + error.message, 'error');
            resetVoiceUI();
        }
    }

    function resetVoiceUI() {
        document.getElementById('voiceStatus').textContent = 'Toca para grabar';
        document.getElementById('voiceHint').textContent = '"He comido un poke..."';
    }

    // Analyze Food
    async function analyzeFood() {
        // Get description from active tab
        const activeTab = document.querySelector('.tab-pane.active');
        let description = '';

        if (activeTab.id === 'voice-tab') {
            description = document.getElementById('transcriptionText').textContent;
        } else {
            description = document.getElementById('textInput').value;
        }

        description = description.replace('Tu transcripción aparecerá aquí...', '').trim();

        if (!description) {
            showToast('Por favor describe tu comida primero', 'warning');
            return;
        }

        // Show loading state implies hiding empty state? 
        // Let's use a toast for specific "Analyzing" status or overlay.
        showToast('Analizando comida...', 'info');

        try {
            const response = await fetch('/api/analizar_comida_ia/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ descripcion: description })
            });

            const data = await response.json();

            if (data.success) {
                currentAnalysis = data.analisis;
                displayAnalysis(data.analisis);
                showToast('¡Análisis completado!', 'success');
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (error) {
            console.error('Error analyzing food:', error);
            showToast('Error al analizar la comida', 'error');
        }
    }

    function displayAnalysis(analysis) {
        // Switch views
        const emptyState = document.getElementById('emptyAnalysisState');
        const resultContent = document.getElementById('analysisResultContent');
        if (emptyState) emptyState.classList.add('d-none');
        if (resultContent) {
            resultContent.classList.remove('d-none');
            resultContent.classList.add('d-flex');
        }

        // Update summary cards
        const updateText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
        updateText('totalCalories', analysis.calorias || 0);
        updateText('totalProtein', (analysis.proteinas || 0) + 'g');
        updateText('totalCarbs', (analysis.carbohidratos || 0) + 'g');
        updateText('miniProtVal', (analysis.proteinas || 0) + 'g');
        updateText('miniCarbVal', (analysis.carbohidratos || 0) + 'g');
        updateText('miniFatVal', (analysis.grasas || 0) + 'g');

        // Calculate percentages
        const proteinGoal = Number("{{ plan.proteinas_g|default:150 }}");
        const carbsGoal = Number("{{ plan.carbohidratos_g|default:200 }}");
        const proteinPercent = Math.min(Math.round((analysis.proteinas / proteinGoal) * 100), 100);
        const carbsPercent = Math.min(Math.round((analysis.carbohidratos / carbsGoal) * 100), 100);

        const pBar = document.getElementById('proteinBar');
        const cBar = document.getElementById('carbsBar');
        if (pBar) pBar.style.width = proteinPercent + '%';
        if (cBar) cBar.style.width = carbsPercent + '%';

        // Ingredients logic
        const ingredientsList = document.getElementById('ingredientsList');
        if (ingredientsList) {
            if (analysis.ingredientes && analysis.ingredientes.length > 0) {
                ingredientsList.innerHTML = analysis.ingredientes.map(ing => `
                    <div class="d-flex align-items-center gap-3 p-3 rounded-4 bg-light border border-light">
                        <div class="bg-white p-2 rounded-circle shadow-sm">
                            <span class="material-symbols-outlined text-muted fs-5">nutrition</span>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-0 fw-bold text-dark">${ing.nombre || ing}</h6>
                            <small class="text-muted fw-bold">${ing.cantidad || ''}</small>
                        </div>
                        <span class="material-symbols-outlined text-success">check_circle</span>
                    </div>
                `).join('');
            } else {
                ingredientsList.innerHTML = '<p class="text-muted small">No se detectaron ingredientes específicos.</p>';
            }
        }
    }

    // Calendar Modal Functions
    function showCalendarModal() {
        if (!currentAnalysis) {
            showToast('Primero analiza una comida', 'warning');
            return;
        }

        document.getElementById('calendarModal').classList.add('show');
        renderMiniCalendar();
    }

    function hideCalendarModal() {
        document.getElementById('calendarModal').classList.remove('show');
        selectedDate = null;
    }

    function renderMiniCalendar() {
        const container = document.getElementById('miniCalendarDays');
        container.innerHTML = '';

        const days = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
        const today = new Date();

        for (let i = 0; i < 7; i++) {
            const date = new Date();
            date.setDate(today.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];
            const isToday = i === 0;

            const chip = document.createElement('div');
            chip.className = 'date-chip-glass flex-shrink-0';
            chip.dataset.date = dateStr;
            chip.onclick = function () {
                document.querySelectorAll('.date-chip-glass').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedDate = dateStr;
            };

            chip.innerHTML = `
            <small class="d-block text-muted mb-1" style="font-size: 0.75rem;">${isToday ? 'Hoy' : days[date.getDay()]}</small>
            <span class="day-number fw-bold fs-4">${date.getDate()}</span>
        `;

            container.appendChild(chip);
        }
    }

    async function confirmAddToCalendar() {
        if (!selectedDate) {
            showToast('Selecciona una fecha', 'warning');
            return;
        }

        if (!currentAnalysis) {
            showToast('No hay análisis para guardar', 'error');
            return;
        }

        const btn = document.getElementById('confirmAddBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';
        btn.disabled = true;

        try {
            // Create a meal entry from the analysis
            const response = await fetch('/api/guardar_comida/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    fecha: selectedDate,
                    nombre: currentAnalysis.titulo || 'Comida Analizada',
                    calorias: currentAnalysis.calorias || 0,
                    proteinas: currentAnalysis.proteinas || 0,
                    carbos: currentAnalysis.carbohidratos || 0,
                    grasas: currentAnalysis.grasas || 0,
                    hora: new Date().toTimeString().split(' ')[0]
                })
            });

            const data = await response.json();

            if (data.success) {
                showToast('¡Comida añadida al calendario!', 'success');
                hideCalendarModal();

                // Reset form
                document.getElementById('transcriptionText').textContent = 'Tu transcripción aparecerá aquí...';
                document.getElementById('textInput').value = '';

                // Hide results and show empty state
                document.getElementById('analysisResultContent').classList.add('d-none');
                document.getElementById('analysisResultContent').classList.remove('d-flex');
                document.getElementById('emptyAnalysisState').classList.remove('d-none');

                document.getElementById('analyzeVoiceBtn').classList.add('d-none');
                document.getElementById('analyzeVoiceBtn').classList.remove('d-flex');

                currentAnalysis = null;
            } else {
                showToast('Error al guardar: ' + data.error, 'error');
            }
        } catch (error) {
            console.error('Error saving meal:', error);
            showToast('Error al guardar la comida', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
</script>
{% endblock %}