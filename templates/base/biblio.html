{% extends base_template %}
{% load static %}

{% block title %}Biblioteca de Salud | nunut{% endblock %}

{% block content %}
<style>
    .text-primary-nunut {
        color: var(--primary) !important;
    }

    /* UTILITIES & BRANDING */
    .small-caps {
        font-variant: all-small-caps;
        letter-spacing: 0.12em;
    }

    /* HERO SECTION */
    .parallax-hero {
        background-position: center;
        background-repeat: no-repeat;
        background-size: cover;
        position: relative;
        border-radius: 2.5rem;
        overflow: hidden;
        height: 60vh;
        min-height: 500px;
        color: white;
        background-color: #222;
        display: flex;
        align-items: flex-end;
        margin-bottom: 3rem;
        box-shadow: var(--card-shadow);
        transition: background-image 0.5s ease-in-out;
    }

    .parallax-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(to bottom, rgba(0, 0, 0, 0.1) 0%, rgba(0, 0, 0, 0.4) 50%, rgba(0, 0, 0, 0.85) 100%);
        z-index: 1;
    }

    .hero-content {
        padding: 4rem;
        width: 100%;
        max-width: 900px;
        z-index: 2;
    }

    /* CARDS */
    .card-article {
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 1.5rem;
        background: var(--bg-content);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
        height: 100%;
        transition: var(--transition-fluid);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .card-article:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
    }

    /* (reverted custom hover styles) */

    .dark-mode .card-article {
        border-color: rgba(255, 255, 255, 0.05);
    }

    .img-container {
        height: 180px;
        position: relative;
        background: #e0e0e0;
        overflow: hidden;
    }

    .img-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.6s ease;
    }

    .card-article:hover .img-container img {
        transform: scale(1.1);
    }

    /* FILTER CHIPS */
    .filter-chip {
        padding: 8px 18px;
        border-radius: 50px;
        background: var(--bg-content);
        color: var(--text-muted);
        border: 1px solid rgba(0, 0, 0, 0.08);
        font-weight: 700;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
    }

    .filter-chip.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        box-shadow: 0 5px 15px var(--primary-glow);
    }

    .dark-mode .filter-chip {
        border-color: rgba(255, 255, 255, 0.05);
    }

    .btn-brand {
        background-color: var(--primary);
        color: white;
        border-radius: 50px;
        padding: 0.75rem 2rem;
        font-weight: 800;
        border: none;
        transition: all 0.3s;
    }

    .btn-brand:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px var(--primary-glow);
        color: white;
    }

    /* Specific style for 'Ver más artículos' button inside load-more container */
    #load-more-container .btn-brand {
        background: var(--primary);
        color: #fff;
        border: none;
        box-shadow: 0 8px 24px rgba(16, 185, 129, 0.18);
        transition: transform 0.3s ease, box-shadow 0.3s ease, color 0.2s ease, filter 0.2s ease;
    }

    /* Darken slightly on hover to indicate press state */
    #load-more-container .btn-brand:hover {
        transform: translateY(-6px) scale(1.02);
        box-shadow: 0 14px 40px rgba(16, 185, 129, 0.22);
        filter: brightness(0.88);
        color: #fff;
    }

    /* Apply same primary background + darken effect to the 'Abrir Guía Maestra' button */
    #guide-container .btn-brand {
        background: var(--primary);
        color: #fff;
        border: none;
        box-shadow: 0 8px 24px rgba(16, 185, 129, 0.14);
        transition: transform 0.28s ease, box-shadow 0.28s ease, filter 0.2s ease;
    }

    #guide-container .btn-brand:hover {
        transform: translateY(-4px) scale(1.01);
        box-shadow: 0 12px 32px rgba(16, 185, 129, 0.18);
        filter: brightness(0.86);
        color: #fff;
    }

    /* Make icons inside .btn-brand white (inherit current color) */
    .btn-brand .material-symbols-outlined {
        color: currentColor;
        transition: transform 0.2s ease, color 0.15s ease;
    }

    /* Article title turns primary green on hover */
    .card-article:hover .article-title,
    .card-article:focus-within .article-title {
        color: var(--primary);
    }

    /* Saved button state */
    .btn-save-inline.saved {
        background: var(--primary);
        color: white;
        box-shadow: 0 6px 18px rgba(16, 185, 129, 0.18);
    }

    .btn-save-inline.saved .material-symbols-outlined {
        font-variation-settings: 'FILL' 1;
        color: white !important;
    }

    /* Fix for "Ver Todo" link hover */
    a[href="#section-explore"]:hover {
        color: var(--primary-dark) !important;
        text-decoration: underline !important;
    }

    .btn-save-inline {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        color: var(--text-secondary);
    }

    .btn-save-inline:hover {
        transform: scale(1.1);
        background: white;
        color: var(--primary);
    }

    .badge-cat {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.65rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        z-index: 5;
    }

    .card-body-api {
        padding: 1rem;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .article-title {
        font-size: 0.95rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        line-height: 1.3;
    }

    .article-desc {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 1rem;
        line-height: 1.5;
        flex-grow: 1;
    }

    .article-meta {
        font-size: 0.7rem;
        color: var(--text-muted);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .img-container {
        height: 150px;
        /* Reduced height */
    }

    /* Responsive text truncation for smaller screens */
    @media (max-width: 768px) {
        .article-title {
            font-size: 0.85rem;
            line-clamp: 2;
            -webkit-line-clamp: 2;
        }

        .article-desc {
            font-size: 0.7rem;
            line-clamp: 2;
            -webkit-line-clamp: 2;
            max-height: 2.8em;
        }

        .img-container {
            height: 120px;
        }
    }

    .dark-mode .bg-light {
        background-color: rgba(255, 255, 255, 0.05) !important;
        border-color: rgba(255, 255, 255, 0.1) !important;
        color: #e2e8f0 !important;
    }

    .dark-mode .text-dark {
        color: #f1f5f9 !important;
    }

    /* --- NUNUT MASTER GUIDE MODAL --- */
    .modal-overlay-elite {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(12px);
        z-index: 9999;
        display: none;
        opacity: 0;
        transition: opacity 0.4s ease;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .modal-overlay-elite.active {
        display: flex;
        opacity: 1;
    }

    .modal-card-elite {
        background: var(--bg-content);
        width: 100%;
        max-width: 700px;
        border-radius: 1.5rem;
        box-shadow: 0 40px 80px -20px rgba(0, 0, 0, 0.3);
        transform: scale(0.95) translateY(20px);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: 1px solid rgba(0, 0, 0, 0.05);
        overflow: hidden;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
    }

    @media (max-width: 768px) {
        .modal-card-elite {
            max-width: 95%;
            max-height: 90vh;
            border-radius: 1.25rem;
        }
    }

    .modal-overlay-elite.active .modal-card-elite {
        transform: scale(1) translateY(0);
    }

    .dark-mode .modal-card-elite {
        background: #151710;
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 40px 80px -20px rgba(0, 0, 0, 0.6);
    }

    .modal-body-elite {
        overflow-y: auto;
        padding: 0;
    }

    @media (max-width: 768px) {
        .modal-body-elite {
            font-size: 0.9rem;
        }
    }

    .btn-close-elite {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(4px);
        border: none;
        border-radius: 50%;
        width: 42px;
        height: 42px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        z-index: 20;
        color: white;
    }

    .btn-close-elite:hover {
        background: rgba(255, 255, 255, 0.4);
        transform: rotate(90deg);
    }

    /* Updated Hero Button */
    .btn-hero {
        background: linear-gradient(135deg, var(--primary) 0%, #a3e635 100%);
        color: #1a1a1a;
        font-weight: 800;
        border: none;
        box-shadow: 0 4px 20px rgba(163, 230, 53, 0.4);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .btn-hero:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 10px 30px rgba(163, 230, 53, 0.5);
        color: #000;
        background: linear-gradient(135deg, #a3e635 0%, var(--primary) 100%);
    }

    /* Updated Brand Button Hover */
    .btn-brand:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 12px 30px -5px var(--primary-glow);
    }

    .btn-brand:hover .material-symbols-outlined {
        transform: translateY(3px);
        transition: transform 0.3s;
    }
</style>

<!-- 1. DYNAMIC HERO SECTION -->
<div class="parallax-hero" id="hero-section">
    <div class="hero-content" id="hero-content">
        <span class="skeleton d-inline-block mb-3" style="width: 150px; height: 30px; border-radius: 50px;"></span>
        <div class="skeleton mb-3" style="width: 90%; height: 80px;"></div>
        <div class="skeleton mb-4" style="width: 70%; height: 40px;"></div>
        <div class="skeleton" style="width: 200px; height: 50px; border-radius: 50px;"></div>
    </div>
</div>

<!-- 2. ÚLTIMAS NOVEDADES (TOP 4) -->
<div class="section-header mt-5 d-flex justify-content-between align-items-center">
    <div>
        <h3 class="section-title">Últimas Novedades</h3>
        <p class="text-muted small mb-0">Lo más reciente en ciencia y bienestar.</p>
    </div>
    <a href="#section-explore" class="fw-bolder text-decoration-none"
        style="color: var(--primary); font-weight: 800;">Ver Todo</a>
</div>

<div id="grid-destacados" class="row g-4 mb-4">
    {% for i in "1234" %}
    <div class="col-6 col-md-4 col-lg-3">
        <div class="card-article">
            <div class="img-container skeleton"></div>
            <div class="card-body-api">
                <div class="skeleton" style="height:60px;"></div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- 3. DYNAMIC GUIDE SECTION -->
<div id="guide-container" class="my-5">
    <!-- Will be populated by JS -->
    <div class="detailed-guide-card">
        <div class="d-flex align-items-center gap-3 mb-4">
            <div class="skeleton" style="width: 60px; height: 60px; border-radius: 50%;"></div>
            <div class="w-75">
                <div class="skeleton mb-2" style="width: 40%; height: 20px;"></div>
                <div class="skeleton" style="width: 80%; height: 30px;"></div>
            </div>
        </div>
        <div class="skeleton w-100" style="height: 100px;"></div>
    </div>
</div>

<!-- 4. BIBLIOTECA DE SALUD (EXPLORE) -->
<div class="section-header" id="section-explore">
    <div class="w-100 d-flex justify-content-between align-items-end">
        <div>
            <h3 class="section-title">Biblioteca de Salud</h3>
            <p class="text-muted small mb-0">Nutrición, tips y ciencia para tu cuerpo.</p>
        </div>
    </div>
</div>

<!-- SEARCH & FILTER -->
<div class="d-flex flex-column flex-md-row gap-3 mb-4 w-100">

    <div class="search-wrapper flex-shrink-0" style="width: 100%; max-width: 280px;">
        <span class="material-symbols-outlined search-icon" style="font-size: 1.2rem;">search</span>
        <input type="text" id="searchInput" class="form-control rounded-pill py-2 ps-5 bg-white border-0 shadow-sm"
            style="font-size: 0.9rem;" placeholder="Buscar temas..." onkeyup="handleSearch(this.value)">
    </div>

    <div class="filter-scroll flex-grow-1 d-flex align-items-center ps-0 pb-0 overflow-auto"
        style="gap: 8px; white-space: nowrap;">
        <div class="filter-chip active" onclick="setFilter(this, 'all')">Todos</div>
        <div class="filter-chip" onclick="setFilter(this, 'nutricion')">Nutrición</div>
        <div class="filter-chip" onclick="setFilter(this, 'tips')">Tips & Salud</div>
        <div class="filter-chip" onclick="setFilter(this, 'ciencia')">Ciencia</div>
    </div>
</div>


<div id="grid-explorar" class="row g-4 mb-4">
    {% for i in "12345678" %}
    <div class="col-6 col-md-4 col-lg-3">
        <div class="card-article">
            <div class="img-container skeleton"></div>
            <div class="card-body-api">
                <div class="skeleton" style="height:60px;"></div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- PAGINATION BUTTON -->
<div class="d-flex justify-content-center mb-5" id="load-more-container">
    <button class="btn btn-brand rounded-pill px-5 py-3 fw-bold d-flex align-items-center gap-2 shadow-sm"
        onclick="showMoreArticles()">
        Ver más artículos
        <span class="material-symbols-outlined">expand_more</span>
    </button>
</div>

<!-- 5. MÁS PARA TI (FUNCIONAL) -->
<div class="py-4 mt-2 border-top">
    <div class="section-header">
        <div>
            <h3 class="section-title">Más para ti</h3>
            <p class="text-muted small mb-0">Herramientas interactivas.</p>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-12 col-md-6">
            <a href="{% url 'base:progreso' %}"
                class="card p-3 flex-row align-items-center gap-3 border-0 shadow-sm h-100 interactive-card text-decoration-none"
                style="background: var(--bg-content);">
                <div class="rounded-4 bg-light d-flex align-items-center justify-content-center flex-shrink-0"
                    style="width: 70px; height: 70px;">
                    <span class="material-symbols-outlined text-primary-nunut fs-2">psychology</span>
                </div>
                <div>
                    <span class="fw-bold x-small text-uppercase text-primary-nunut mb-1 d-block">IA Coach</span>
                    <h6 class="fw-black mb-0">Análisis Inteligente</h6>
                    <p class="x-small text-muted mb-0">Revisar mi progreso con IA.</p>
                </div>
            </a>
        </div>
        <div class="col-12 col-md-6">
            <a href="{% url 'base:planes' %}"
                class="card p-3 flex-row align-items-center gap-3 border-0 shadow-sm h-100 interactive-card text-decoration-none"
                style="background: var(--bg-content);">
                <div class="rounded-4 bg-light d-flex align-items-center justify-content-center flex-shrink-0"
                    style="width: 70px; height: 70px;">
                    <span class="material-symbols-outlined text-primary-nunut fs-2">restaurant_menu</span>
                </div>
                <div>
                    <span class="fw-bold x-small text-primary-nunut mb-1 d-block">Planes</span>
                    <h6 class="fw-black mb-0">Buscar Recetas</h6>
                    <p class="x-small text-muted mb-0">Encuentra comidas para tu plan.</p>
                </div>
            </a>
        </div>
        <div class="col-12 col-md-6">
            <a href="https://www.youtube.com/results?search_query=rutina+hiit+15+min" target="_blank"
                class="card p-3 flex-row align-items-center gap-3 border-0 shadow-sm h-100 interactive-card text-decoration-none"
                style="background: var(--bg-content);">
                <div class="rounded-4 bg-light d-flex align-items-center justify-content-center flex-shrink-0"
                    style="width: 70px; height: 70px;">
                    <span class="material-symbols-outlined text-primary-nunut fs-2">local_fire_department</span>
                </div>
                <div>
                    <span class="fw-bold x-small text-primary-nunut mb-1 d-block">Exterior</span>
                    <h6 class="fw-black mb-0">Reto HIIT</h6>
                    <p class="x-small text-muted mb-0">Videos de rutinas rápidas.</p>
                </div>
            </a>
        </div>
        <div class="col-12 col-md-6">
            <a href="#" onclick="showToast('Próximamente', 'info'); return false;"
                class="card p-3 flex-row align-items-center gap-3 border-0 shadow-sm h-100 interactive-card text-decoration-none"
                style="background: var(--bg-content);">
                <div class="rounded-4 bg-light d-flex align-items-center justify-content-center flex-shrink-0"
                    style="width: 70px; height: 70px;">
                    <span class="material-symbols-outlined text-primary-nunut fs-2">forum</span>
                </div>
                <div>
                    <span class="fw-bold x-small text-primary-nunut mb-1 d-block">Comunidad</span>
                    <h6 class="fw-black mb-0">Foro Salud</h6>
                    <p class="x-small text-muted mb-0">Comparte con otros usuarios.</p>
                </div>
            </a>
        </div>
    </div>
</div>
<!-- SAVED ARTICLES SECTION -->
<div id="saved-articles-section" class="py-4 mt-4 border-top">
    <div class="section-header d-flex justify-content-between align-items-center">
        <div>
            <h3 class="section-title">Artículos Guardados</h3>
            <p class="text-muted small mb-0">Tus artículos guardados para leer después.</p>
        </div>
        <div>
            <button class="btn btn-sm btn-link text-muted"
                onclick="(function(e){e.preventDefault(); localStorage.setItem('nunut_saved', '[]'); renderSavedSection(); })(event)">Limpiar</button>
        </div>
    </div>

    <div id="saved-grid" class="row g-3 mt-3">
        <div class="col-12 text-muted small">Cargando guardados...</div>
    </div>
</div>

<!-- NUNUT MASTER GUIDE MODAL -->
<div class="modal-overlay-elite" id="masterGuideModal" onclick="closeMasterGuideModal(event)">
    <div class="modal-card-elite" onclick="event.stopPropagation()">
        <button class="btn-close-elite" onclick="closeMasterGuideModal()">
            <span class="material-symbols-outlined">close</span>
        </button>

        <!-- Header Image/Banner -->
        <div class="position-relative" style="height: 160px;">
            <div class="position-absolute inset-0 w-100 h-100"
                style="background: url('https://images.unsplash.com/photo-1677442136019-21780ecad995?q=80&w=1200') center/cover;">
            </div>
            <div class="position-absolute top-0 start-0 w-100 h-100"
                style="background: linear-gradient(to top, #111 5%, transparent 100%);"></div>

            <div class="position-absolute bottom-0 start-0 p-3 w-100">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <span class="badge bg-primary text-black fw-bold px-2 py-1 rounded-pill shadow-lg"
                        style="font-size: 0.7rem;">
                        <span class="material-symbols-outlined align-middle me-1"
                            style="font-size: 14px;">auto_awesome</span>
                        IA Powered
                    </span>
                    <span
                        class="badge bg-dark bg-opacity-50 text-white backdrop-blur px-2 py-1 rounded-pill border border-white border-opacity-25"
                        style="font-size: 0.7rem;">
                        Versión 2.0
                    </span>
                </div>
                <h2 class="h3 fw-black text-white mb-0" style="text-shadow: 0 4px 20px rgba(0,0,0,0.5);">Guía
                    Maestra nunut</h2>
            </div>
        </div>

        <div class="modal-body-elite p-3 p-md-4">
            <h5 class="fw-bold text-muted mb-3 d-flex align-items-center gap-2">
                <span class="material-symbols-outlined text-primary">analytics</span>
                Análisis en Tiempo Real
            </h5>

            <!-- Cards Grid inside Modal -->
            <div class="row g-3">
                <div class="col-md-6">
                    <div
                        class="p-3 rounded-4 bg-light h-100 border border-opacity-10 position-relative overflow-hidden group-hover-effect">
                        <div class="position-absolute top-0 end-0 p-2 opacity-10">
                            <span class="material-symbols-outlined fs-2">fingerprint</span>
                        </div>
                        <h6 class="fw-black mb-2">Biometría Adaptativa</h6>
                        <p class="text-muted small mb-2">Tu plan de {{ informe.plan.calorias_dia|default:"2000" }} kcal
                            se ajusta automáticamente según tu actividad diaria detectada.</p>
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: 75%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div
                        class="p-3 rounded-4 bg-light h-100 border border-opacity-10 position-relative overflow-hidden">
                        <div class="position-absolute top-0 end-0 p-2 opacity-10">
                            <span class="material-symbols-outlined fs-2">bedtime</span>
                        </div>
                        <h6 class="fw-black mb-2">Ciclo de Descanso</h6>
                        <p class="text-muted small mb-2">Detectamos una oportunidad de mejora en tu recuperación
                            post-entreno. Prioriza dormir antes de las 11 PM.</p>
                        <div class="d-flex gap-2">
                            <span class="badge bg-dark text-white rounded-pill"
                                style="font-size: 0.7rem;">Melatonina</span>
                            <span class="badge bg-dark text-white rounded-pill"
                                style="font-size: 0.7rem;">Recuperación</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-3 p-3 rounded-4 position-relative overflow-hidden"
                style="background: linear-gradient(135deg, rgba(133, 200, 26, 0.1) 0%, rgba(133, 200, 26, 0.05) 100%); border: 1px solid rgba(133, 200, 26, 0.2);">
                <div class="d-flex gap-2">
                    <div class="flex-shrink-0 bg-white p-2 rounded-circle shadow-sm" style="height: fit-content;">
                        <span class="material-symbols-outlined text-primary fs-5">lightbulb</span>
                    </div>
                    <div>
                        <h6 class="fw-bold text-dark mb-1">Insight del Día</h6>
                        <p class="mb-0 text-muted small">"Estudios recientes sugieren que consumir proteínas en el
                            desayuno
                            reduce los antojos nocturnos en un 40%. Hoy te sugerimos: <strong>Huevos con
                                Espinaca</strong>."</p>
                    </div>
                </div>
            </div>

            <div class="mt-3 text-center">
                <p class="small text-muted fst-italic mb-0">Información generada por nuestros algoritmos de salud.</p>
            </div>
        </div>

        <div class="p-3 border-top d-flex justify-content-end gap-3 bg-light">
            <button class="btn btn-link text-muted fw-bold text-decoration-none px-4"
                onclick="closeMasterGuideModal()">Cerrar</button>
            <button class="btn btn-brand rounded-pill px-5 shadow-sm" onclick="closeMasterGuideModal()">
                Entendido
            </button>
        </div>
    </div>
</div>

<script>
    (function () {
        // --- SCOPED STATE VARIABLES ---
        const API_KEY = "4936c3f3a0fe483c84f6a7996512cb9b";
        let allArticles = [];
        let displayedArticles = [];
        let initialCount = window.innerWidth < 768 ? 6 : 8;
        let currentLimit = initialCount;
        let currentFilter = 'all';
        let currentSearch = '';

        const MOCK_DB = [
            { title: "Guía Maestro nunut (IA)", description: "Entiende cómo nuestra inteligencia avanzada utiliza tu biometría, racha y gustos para optimizar tu salud en tiempo real.", category: "Ciencia", urlToImage: "https://images.unsplash.com/photo-1677442136019-21780ecad995?q=80&w=500", url: "#", type: "guide" },
            { title: "El Poder del Magnesio", description: "Descubre por qué este mineral es esencial para tu recuperación muscular y sueño profundo.", category: "Nutrición", urlToImage: "https://images.unsplash.com/photo-1550547660-d9450f859349?q=80&w=500", url: "https://www.healthline.com/nutrition/magnesium-benefits", type: "article" },
            { title: "Ayuno Intermitente: Guía Completa", description: "Guía basada en evidencia sobre los beneficios y contraindicaciones del ayuno 16/8.", category: "Ciencia", urlToImage: "https://images.unsplash.com/photo-1549488497-64906a2374c0?q=80&w=500", url: "https://www.youtube.com/watch?v=LLVf3d0rqqY", type: "guide" },
            { title: "Sueño y Pérdida de Grasa", description: "Dormir menos de 6 horas puede reducir tu capacidad de quemar grasa en un 55%.", category: "Tips", urlToImage: "https://images.unsplash.com/photo-1520206183501-b80df61043c2?q=80&w=500", url: "https://www.sleepfoundation.org/physical-health/weight-loss-and-sleep", type: "fact" },
            { title: "Proteína Vegetal Completa", description: "Top 5 fuentes de proteína completa para dietas basadas en plantas.", category: "Nutrición", urlToImage: "https://images.unsplash.com/photo-1512621776951-a57141f2eefd?q=80&w=500", url: "https://www.youtube.com/watch?v=hJNF2_dCWkg", type: "article" },
            { title: "Mito del Colesterol en Huevos", description: "Nuevos estudios revelan que el huevo no es el enemigo. Entiende el HDL vs LDL.", category: "Ciencia", urlToImage: "https://images.unsplash.com/photo-1506808823611-6b8a8b0c4456?q=80&w=500", url: "https://www.health.harvard.edu/heart-health/are-eggs-risky-for-heart-health", type: "article" },
            { title: "Hidratación Celular Real", description: "Beber agua no es suficiente. Necesitas electrolitos para una hidratación celular real.", category: "Tips", urlToImage: "https://images.unsplash.com/photo-1548839140-29a749e1cf4d?q=80&w=500", url: "https://www.youtube.com/watch?v=j5K3EJhMNFQ", type: "fact" },
            { title: "Guía de Suplementos Esenciales", description: "Creatina, Whey, Omega-3: ¿Cuáles valen realmente la pena según la ciencia?", category: "Ciencia", urlToImage: "https://images.unsplash.com/photo-1584308666744-24d5c474f2ae?q=80&w=500", url: "https://examine.com/guides/supplement-guides/", type: "guide" },
            { title: "Rutina HIIT para Principiantes", description: "15 minutos de entrenamiento de alta intensidad para quemar grasa rápidamente.", category: "Tips", urlToImage: "https://images.unsplash.com/photo-1517836357463-d25dfeac3438?q=80&w=500", url: "https://www.youtube.com/watch?v=ml6cT4AZdqI", type: "article" },
            { title: "Dieta Mediterránea y Longevidad", description: "Cómo la dieta mediterránea puede añadir años de vida saludable.", category: "Nutrición", urlToImage: "https://images.unsplash.com/photo-1498837167922-ddd27525d352?q=80&w=500", url: "https://www.mayoclinic.org/healthy-lifestyle/nutrition-and-healthy-eating/in-depth/mediterranean-diet/art-20047801", type: "article" },
            { title: "Yoga para la Flexibilidad", description: "Rutina de yoga de 20 minutos para mejorar tu flexibilidad y reducir el estrés.", category: "Tips", urlToImage: "https://images.unsplash.com/photo-1544367567-0f2fcb009e0b?q=80&w=500", url: "https://www.youtube.com/watch?v=v7AYKMP6rOE", type: "article" },
            { title: "Macros para Ganar Músculo", description: "Cálculo preciso de proteínas, carbohidratos y grasas para hipertrofia muscular.", category: "Nutrición", urlToImage: "https://images.unsplash.com/photo-1532384748853-8f54a8f476e2?q=80&w=500", url: "https://www.bodybuilding.com/content/macronutrient-calculator.html", type: "guide" },
            { title: "Beneficios del Omega-3", description: "Por qué los ácidos grasos omega-3 son cruciales para tu salud cerebral y cardiovascular.", category: "Ciencia", urlToImage: "https://images.unsplash.com/photo-1559827260-dc66d52bef19?q=80&w=500", url: "https://ods.od.nih.gov/factsheets/Omega3FattyAcids-Consumer/", type: "article" }
        ];

        // --- INTERNAL FUNCTIONS ---

        async function fetchData() {
            const query = '(nutricion ciencia) OR (salud metabolica) OR (biologia cuerpo) OR (consejos salud) OR (superalimentos beneficos)';
            const url = `https://newsapi.org/v2/everything?q=${encodeURIComponent(query)}&language=es&sortBy=relevancy&pageSize=50&apiKey=${API_KEY}`;
            // Use corsproxy only if needed, or direct if valid
            const finalUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;

            try {
                const res = await fetch(finalUrl);
                const data = await res.json();

                let apiNews = [];
                if (data.status === "ok") {
                    apiNews = data.articles.filter(a => {
                        const t = (a.title + " " + a.description).toLowerCase();
                        return a.urlToImage && !t.includes('política') && !t.includes('muerte');
                    }).map(a => {
                        let c = 'Nutrición';
                        const t = (a.title + a.description).toLowerCase();
                        if (t.includes('estudio') || t.includes('científico')) c = 'Ciencia';
                        else if (t.includes('tip') || t.includes('consejo')) c = 'Tips';
                        return { ...a, category: c, type: 'article' };
                    });
                }
                allArticles = [...MOCK_DB, ...apiNews];
                // Remove duplicates
                allArticles = allArticles.filter((v, i, a) => a.findIndex(t => (t.title === v.title)) === i);
                renderPage();
            } catch (e) {
                console.warn("API failed, using Mock", e);
                allArticles = MOCK_DB;
                renderPage();
            }
        }

        function renderPage() {
            // Find content for Hero and Guide
            const heroArt = allArticles.find(a => a.description && a.description.length > 50) || allArticles[0];
            renderHero(heroArt);

            const guideArt = allArticles.find(a => a.type === 'guide' || a.title.includes('Guía')) || MOCK_DB[1];
            renderGuide(guideArt);

            let remaining = allArticles.filter(a => a !== heroArt && a !== guideArt);
            const topNews = remaining.slice(0, 4);
            renderGrid('grid-destacados', topNews);

            remaining = remaining.slice(4);
            displayedArticles = remaining;

            applyFilters();
            renderSavedSection();
        }

        function renderHero(art) {
            const hero = document.getElementById('hero-section');
            const content = document.getElementById('hero-content');
            if (!hero || !content) return;

            hero.style.backgroundImage = `url('${art.urlToImage}')`;
            content.innerHTML = `
                <span class="badge mb-3 small-caps px-4 py-2 border-0 shadow-sm" style="background: var(--primary); color: white; border-radius: 50px;">
                    <i class="fas fa-star me-2"></i>Destacado
                </span>
                <h1 class="display-4 fw-black mb-3 text-white line-clamp-2" style="text-shadow: 0 5px 30px rgba(0,0,0,0.8);">${art.title}</h1>
                <p class="opacity-90 mb-4 lead text-white line-clamp-2" style="max-width: 700px; text-shadow: 0 2px 10px rgba(0,0,0,0.8);">${art.description}</p>
                <a href="${art.url}" target="_blank" class="btn btn-hero rounded-pill px-5 py-3 d-inline-flex align-items-center gap-2">
                    <span>Leer Artículo Completo</span>
                    <span class="material-symbols-outlined">arrow_forward</span>
                </a>
            `;
        }

        function renderGuide(art) {
            const container = document.getElementById('guide-container');
            if (!container) return;

            container.innerHTML = `
                <div class="detailed-guide-card fade-in-article">
                    <div class="row align-items-center">
                        <div class="col-lg-7 position-relative" style="z-index:1;">
                            <span class="badge bg-success-subtle text-success border border-success border-opacity-25 px-3 py-2 rounded-pill fw-bold mb-3 small-caps">Guía Recomendada por IA</span>
                            <h2 class="fw-black mb-3">${art.title}</h2>
                            <p class="text-muted mb-4 fs-5 line-clamp-3">${art.description}</p>
                            <button onclick="openMasterGuideModal()" class="btn btn-brand rounded-pill px-4 py-3 fw-bold shadow-lg d-inline-flex align-items-center gap-2 border-0">
                                <span class="material-symbols-outlined filled">auto_awesome</span>
                                Abrir Guía Maestra
                            </button>
                        </div>
                        <div class="col-lg-5 d-none d-lg-block">
                            <div class="rounded-5 overflow-hidden shadow-lg position-relative" style="height: 250px; transform: rotate(2deg);">
                                <img src="${art.urlToImage}" class="w-100 h-100 object-fit-cover">
                                <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(to right, rgba(0,0,0,0.4), transparent);"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderGrid(id, articles) {
            const grid = document.getElementById(id);
            if (!grid) return;
            grid.innerHTML = '';
            articles.forEach(a => grid.appendChild(createCard(a)));
        }

        function applyFilters() {
            const grid = document.getElementById('grid-explorar');
            if (!grid) return;
            grid.innerHTML = '';

            let filtered = displayedArticles;

            // 1. Text Search
            if (currentSearch.length > 0) {
                filtered = filtered.filter(a => (a.title + a.description).toLowerCase().includes(currentSearch));
            }

            // 2. Category Filter
            if (currentFilter !== 'all') {
                filtered = filtered.filter(a => {
                    const catNorm = a.category.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    const filterNorm = currentFilter.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    return catNorm.includes(filterNorm);
                });
            }

            // 3. Pagination
            let toShow = filtered.slice(0, currentLimit);

            if (toShow.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center text-muted py-5">No se encontraron artículos con estos criterios.</div>';
                const btn = document.getElementById('load-more-container');
                if (btn) btn.classList.add('d-none');
                return;
            }

            toShow.forEach(a => grid.appendChild(createCard(a)));

            const btn = document.getElementById('load-more-container');
            if (btn) {
                if (filtered.length > currentLimit) {
                    btn.classList.remove('d-none');
                } else {
                    btn.classList.add('d-none');
                }
            }
        }

        function createCard(art) {
            const col = document.createElement('div');
            col.className = 'col-6 col-md-4 col-lg-3';

            // Check saved state from localStorage
            let savedList = [];
            try { savedList = JSON.parse(localStorage.getItem('nunut_saved') || '[]'); } catch (e) { savedList = []; }
            const isSaved = savedList.some(s => s.url === art.url);

            const safeTitle = (art.title || '').replace(/"/g, '&quot;').replace(/\`/g, '\\`');

            col.innerHTML = `
                <div class="card-article h-100">
                    <div class="img-container">
                        <span class="badge-cat">${art.category}</span>
                        <button class="btn-save-inline ${isSaved ? 'saved' : ''}" 
                            data-title="${safeTitle}" data-url="${art.url}" data-img="${art.urlToImage}" data-category="${art.category}" 
                            onclick="event.preventDefault(); toggleSave(this)">
                            <span class="material-symbols-outlined fs-6">bookmark</span>
                        </button>
                        <img src="${art.urlToImage}" alt="Img">
                    </div>
                    <div class="card-body-api">
                        <h3 class="article-title line-clamp-2">${art.title}</h3>
                        <p class="article-desc line-clamp-3">${art.description || ''}</p>
                        <div class="article-meta">
                             <span class="material-symbols-outlined fs-6" style="font-size: 14px !important;">schedule</span>
                             ${Math.floor(Math.random() * 8) + 3} min
                        </div>
                        <a href="${art.url}" target="_blank" class="stretched-link"></a>
                    </div>
                </div>
            `;
            return col;
        }

        // --- GLOBAL FUNCTIONS (Exposed for Inline Handlers) ---

        window.showMoreArticles = function () {
            currentLimit += 4;
            applyFilters();
        };

        window.handleSearch = function (val) {
            currentSearch = val.toLowerCase().trim();
            currentLimit = initialCount; // Reset pagination on search
            applyFilters();
        };

        window.setFilter = function (el, filter) {
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            currentFilter = filter;
            initialCount = window.innerWidth < 768 ? 6 : 8; // Refresh count based on responsive
            currentLimit = initialCount; // Reset pagination on cat switch
            applyFilters();
        };

        window.toggleSave = function (btn) {
            try {
                const item = {
                    title: btn.dataset.title || btn.getAttribute('data-title') || '',
                    url: btn.dataset.url || btn.getAttribute('data-url') || '',
                    img: btn.dataset.img || btn.getAttribute('data-img') || '',
                    category: btn.dataset.category || btn.getAttribute('data-category') || ''
                };

                let saved = [];
                try { saved = JSON.parse(localStorage.getItem('nunut_saved') || '[]'); } catch (e) { saved = []; }

                const idx = saved.findIndex(s => s.url === item.url);
                if (idx > -1) {
                    // remove
                    saved.splice(idx, 1);
                    btn.classList.remove('saved');
                } else {
                    // add to start
                    saved.unshift(item);
                    btn.classList.add('saved');
                }

                localStorage.setItem('nunut_saved', JSON.stringify(saved));
                renderSavedSection();
            } catch (e) {
                console.warn('save failed', e);
            }
        };

        function renderSavedSection() {
            const container = document.getElementById('saved-articles-section');
            const grid = document.getElementById('saved-grid');
            if (!container || !grid) return;
            let saved = [];
            try { saved = JSON.parse(localStorage.getItem('nunut_saved') || '[]'); } catch (e) { saved = []; }
            grid.innerHTML = '';
            if (!saved || saved.length === 0) {
                grid.innerHTML = '<div class="col-12 text-muted small">No tienes artículos guardados.</div>';
                return;
            }
            saved.forEach(s => grid.appendChild(renderSavedCard(s)));
        }

        function renderSavedCard(s) {
            const col = document.createElement('div');
            col.className = 'col-12 col-md-6 col-lg-4';
            col.innerHTML = `
                <div class="card p-2 d-flex flex-row gap-3 align-items-center" style="background: var(--bg-content);">
                    <img src="${s.img}" style="width:84px;height:64px;object-fit:cover;border-radius:8px;" />
                    <div class="flex-grow-1">
                        <a href="${s.url}" target="_blank" class="fw-bold text-decoration-none" style="color:var(--text-dark);">${s.title}</a>
                        <div class="small text-muted">${s.category}</div>
                    </div>
                    <div class="text-end">
                        <button class="btn btn-link text-danger small" onclick="(function(e){e.preventDefault(); removeSaved('${encodeURIComponent(s.url)}');})(event)">Eliminar</button>
                    </div>
                </div>
            `;
            return col;
        }

        window.removeSaved = function (encUrl) {
            const url = decodeURIComponent(encUrl);
            let saved = [];
            try { saved = JSON.parse(localStorage.getItem('nunut_saved') || '[]'); } catch (e) { saved = []; }
            const idx = saved.findIndex(s => s.url === url);
            if (idx > -1) saved.splice(idx, 1);
            localStorage.setItem('nunut_saved', JSON.stringify(saved));
            // update buttons in grid
            document.querySelectorAll('.btn-save-inline').forEach(b => { if ((b.dataset && b.dataset.url) === url) b.classList.remove('saved'); });
            renderSavedSection();
        };

        window.openMasterGuideModal = function () {
            const modal = document.getElementById('masterGuideModal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent page scroll
            }
        };

        window.closeMasterGuideModal = function (e) {
            // Optional: check if click target is overlay or close button
            const modal = document.getElementById('masterGuideModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        };

        // --- EXPORT TO WINDOW (Fix for inline event handlers) ---
        window.handleSearch = function (val) {
            currentSearch = val.toLowerCase();
            applyFilters();
        };

        window.setFilter = function (el, filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            applyFilters();
        };

        window.showMoreArticles = function () {
            currentLimit += 4;
            applyFilters();
        };

        // --- INITIALIZATION ---
        fetchData();

    })();
</script>
{% endblock %}