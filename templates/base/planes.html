{% extends base_template %}
{% load static %}

{% block title %}Explorador de Recetas | nunut{% endblock %}

{% block content %}
<!-- Google Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&amp;display=swap"
    rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
    rel="stylesheet" />

<!-- Custom CSS (Bootstrap overrides to match the premium design) -->
<style>
    :root {
        --primary-color: #85c81a;
        --primary-dark: #74b016;
        --bg-light: #f7f8f6;
        --heart-active: #ff4d4d;
        --macro-protein: #e3f2fd;
        --macro-protein-text: #1976d2;
        --macro-carbs: #fff3e0;
        --macro-carbs-text: #f57c00;
        --macro-fats: #fffde7;
        --macro-fats-text: #fbc02d;
    }

    body {
        font-family: 'Manrope', sans-serif;
        background-color: var(--bg-light);
    }

    /* Container centering fix */
    .main-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Card Hover Effects */
    .recipe-card-container {
        transition: all 0.3s ease-in-out;
        border: none;
        border-radius: 16px;
        background: white;
        overflow: hidden;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .recipe-card-container:hover .recipe-img {
        transform: scale(1.1);
    }

    /* Favorite Button */
    .favorite-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 36px;
        height: 36px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(4px);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 10;
        border: none;
        transition: all 0.3s;
    }

    .favorite-btn:active {
        transform: scale(0.9);
    }

    .favorite-btn .material-symbols-outlined {
        color: #9ca3af;
        font-size: 20px;
        transition: color 0.3s;
        font-variation-settings: 'FILL' 0;
    }

    .favorite-btn.active .material-symbols-outlined {
        color: var(--heart-active);
        font-variation-settings: 'FILL' 1;
    }

    /* Tabs */
    .nav-tabs-custom {
        display: flex;
        gap: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 1.5rem;
        overflow-x: auto;
        white-space: nowrap;
    }

    .nav-tabs-custom button,
    .nav-tabs-custom a {
        background: none;
        border: none;
        padding: 0.75rem 0.25rem;
        color: #6b7280;
        font-weight: 700;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
        text-decoration: none;
    }

    .nav-tabs-custom button.active,
    .nav-tabs-custom a.active {
        color: #000;
        border-bottom-color: var(--primary-color);
    }

    /* Macros & Badges */
    .macro-pill {
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* FAB */
    .fab-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 56px;
        height: 56px;
        background-color: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, background-color 0.2s;
        z-index: 50;
        text-decoration: none;
    }

    .fab-btn:hover {
        background-color: var(--primary-dark);
        transform: scale(1.1);
        color: white;
    }

    /* Scrollbar Hide */
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }

    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* Modals & Overlays */
    .recipe-creator-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.98);
        z-index: 2000;
        display: none;
        overflow-y: auto;
    }

    .recipe-creator-overlay.show {
        display: block;
    }

    /* Recipe Detail Popup (Modal) */
    .recipe-Detail-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2000;
        display: none;
        pointer-events: none;
        align-items: center;
        justify-content: center;
    }

    .recipe-Detail-overlay.show {
        display: flex;
        pointer-events: auto;
    }

    /* Modal Content Panel */
    .recipe-detail-panel {
        position: relative;
        width: 95%;
        max-width: 600px;
        height: 70vh;
        background: var(--bg-light);
        border-radius: 24px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        transform: scale(0.9);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        overflow: hidden;
        /* Header and Footer will be absolute/sticky */
        z-index: 2;
        display: flex;
        flex-direction: column;
    }

    .recipe-Detail-overlay.show .recipe-detail-panel {
        transform: scale(1);
        opacity: 1;
    }

    .recipe-detail-content {
        flex-grow: 1;
        overflow-y: auto;
        padding-bottom: 100px;
        /* Space for fixed bottom action */
    }

    /* Date Selector Mini Calendar */
    .date-selector-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top-left-radius: 24px;
        border-top-right-radius: 24px;
        box-shadow: 0 -10px 25px rgba(0, 0, 0, 0.1);
        transform: translateY(100%);
        transition: transform 0.3s ease-out;
        z-index: 10;
        padding: 1.5rem;
        max-height: 60vh;
        overflow-y: auto;
    }

    .date-selector-overlay.show {
        transform: translateY(0);
    }

    .date-chip {
        padding: 12px;
        border: 2px solid #f3f4f6;
        border-radius: 16px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        flex: 1;
        min-width: 90px;
        position: relative;
        background: white;
    }

    .date-chip:hover {
        border-color: var(--primary-color);
        background: #f7fee7;
        transform: translateY(-2px);
    }

    .date-chip.selected {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(132, 199, 26, 0.3);
    }

    .date-chip small {
        display: block;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        opacity: 0.8;
        margin-bottom: 4px;
    }

    .date-chip .day-number {
        display: block;
        font-size: 20px;
        font-weight: 800;
        margin-bottom: 6px;
    }

    .date-chip .cal-info {
        font-size: 9px;
        font-weight: 600;
        opacity: 0.9;
        line-height: 1.3;
    }

    .date-chip.selected .cal-info {
        opacity: 1;
    }

    .cal-progress-mini {
        height: 3px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 3px;
        margin-top: 6px;
        overflow: hidden;
    }

    .date-chip.selected .cal-progress-mini {
        background: rgba(255, 255, 255, 0.3);
    }

    .cal-progress-fill {
        height: 100%;
        background: var(--primary-color);
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    .date-chip.selected .cal-progress-fill {
        background: white;
    }

    .preview-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ff6b6b;
        color: white;
        font-size: 10px;
        font-weight: 800;
        padding: 2px 6px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
    }

    @media (max-width: 600px) {
        .recipe-detail-panel {
            height: 90vh;
            width: 100%;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            position: fixed;
            bottom: 0;
            transform: translateY(100%);
        }

        .recipe-Detail-overlay.show .recipe-detail-panel {
            transform: translateY(0);
        }
    }

    .recipe-creator-container {
        max-width: 800px;
        margin: 2rem auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05);
        border: 1px solid #eee;
    }

    .btn-primary-custom {
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 999px;
        padding: 8px 16px;
        font-weight: 700;
        font-size: 0.875rem;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .btn-primary-custom:hover {
        background-color: var(--primary-dark);
        color: white;
    }

    .btn-primary-custom:disabled {
        background-color: #d1d5db;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .btn-filter {
        background: white;
        border: 1px solid #f3f4f6;
        color: #4b5563;
        border-radius: 999px;
        padding: 6px 16px;
        font-size: 0.875rem;
        font-weight: 700;
        white-space: nowrap;
        transition: all 0.2s;
    }

    .btn-filter:hover {
        background-color: #f9fafb;
    }

    .btn-filter.active {
        background-color: #111827;
        color: white;
        border-color: #111827;
    }

    /* Utilities */
    .object-cover {
        object-fit: cover;
    }

    .transition-transform {
        transition: transform 0.5s;
    }

    /* Calendar Grid */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 15px;
    }

    /* (removed fixed-height wrapper to allow grid to expand vertically) */

    @media (max-width: 991px) {
        .calendar-grid {
            grid-template-columns: 1fr;
        }
    }

    .calendar-day-card {
        background: white;
        border-radius: 16px;
        padding: 1.25rem;
        border: 1px solid #f3f4f6;
        min-height: 200px;
        display: flex;
        flex-direction: column;
    }

    .calendar-day-card.today {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 1px var(--primary-color);
    }

    /* Detail view styles (from provided design) */
    :root {
        --bg-dark: #1b2111;
        --text-dark: #161b0e;
        --text-light: #f7f8f6;
        --border-color: #eef3e8;
    }

    .sticky-nav {
        position: sticky;
        top: 0;
        z-index: 1050;
        background-color: rgba(247, 248, 246, 0.8);
        backdrop-filter: blur(10px);
    }

    .btn-round-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: white;
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .hero-image-detail {
        width: 100%;
        min-height: 350px;
        background-size: cover;
        background-position: center;
        border-radius: 1.25rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .stat-badge {
        background-color: rgba(132, 199, 26, 0.2);
        color: var(--text-dark);
        padding: 6px 16px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .custom-card {
        background-color: white;
        border-radius: 1rem;
        border: 1px solid var(--border-color);
        padding: 1.25rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .step-number {
        width: 32px;
        height: 32px;
        background-color: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        flex-shrink: 0;
    }

    .bottom-action-container {
        position: fixed;
        bottom: 72px;
        left: 0;
        right: 0;
        padding: 1rem;
        background: linear-gradient(to top, var(--bg-light), rgba(247, 248, 246, 0.95), transparent);
        z-index: 1040;
    }

    /* Bottom action inside offcanvas */
    .recipe-detail-panel .bottom-action-container {
        position: absolute;
        bottom: 72px;
        left: 0;
        right: 0;
    }

    .btn-add {
        background-color: var(--primary-color);
        color: white;
        font-weight: 700;
        padding: 1rem;
        border-radius: 1rem;
        border: none;
        width: 100%;
        box-shadow: 0 10px 15px -3px rgba(132, 199, 26, 0.25);
        transition: transform 0.2s;
    }

    .ios-bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 72px;
        background-color: white;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-around;
        align-items: center;
        z-index: 1050;
    }

    /* Bottom nav inside offcanvas */
    .recipe-detail-panel .ios-bottom-nav {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
    }

    .nav-item-custom {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: #9ca3af;
        font-size: 10px;
        font-weight: 600;
        text-decoration: none;
    }

    .nav-item-custom.active {
        color: var(--primary-color);
    }
</style>

<div class="main-container pb-5">

    <!-- HEADER -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
        <div>
            <h1 class="fw-bolder m-0 text-dark" style="font-size: 1.75rem;">
                {% if vista_activa == 'calendario' %}Mi Calendario{% else %}Explorador de Recetas{% endif %}
            </h1>
            <p class="text-muted fw-bold m-0 mt-1" style="font-size: 0.9rem;">Planifica, crea y disfruta tus comidas.
            </p>
        </div>

        {% if vista_activa != 'calendario' %}
        <div class="position-relative w-100" style="max-width: 500px;">
            <span class="material-symbols-outlined position-absolute"
                style="left: 15px; top: 50%; transform: translateY(-50%); color: var(--primary-color);">search</span>
            <input type="text" name="q" value="{{ request.GET.q|default:'' }}"
                class="form-control border-0 shadow-sm ps-5 py-3 rounded-4 fw-bold"
                style="padding-left: 3rem !important; background: white;" placeholder="Buscar por plato, ingrediente..."
                autocomplete="off">
        </div>
        {% endif %}
    </div>

    <!-- TABS -->
    <nav class="nav-tabs-custom" id="recipe-tabs">
        {% if vista_activa != 'calendario' %}
        <button class="nav-link active" data-tab="explorar" onclick="switchTab('explorar')">Explorar</button>
        <button class="nav-link" data-tab="mis-recetas" onclick="switchTab('mis-recetas')">Mis Recetas</button>
        <button class="nav-link" data-tab="favoritos" onclick="switchTab('favoritos')">Favoritos</button>
        {% else %}
        <a href="?view=recetario" class="nav-link">Explorar</a>
        {% endif %}
        <a href="?view=calendario"
            class="nav-link {% if vista_activa == 'calendario' %}active{% endif %}">Calendario</a>
    </nav>

    <!-- VIEWS CONTAINER -->
    <!-- RECETARIO VIEW -->
    <div id="recetario-view" class="{% if vista_activa == 'calendario' %}d-none{% endif %}">

        <!-- FILTERS -->
        <div class="d-flex align-items-center gap-2 overflow-auto pb-3 scrollbar-hide mb-4">
            <!-- Create Plan AI -->
            <button onclick="generateAutoPlan()" class="btn-primary-custom">
                <span class="material-symbols-outlined" style="font-size: 18px;">auto_awesome</span> Plan IA
            </button>

            <!-- Standard -->
            <button onclick="window.location.href='?'"
                class="btn-filter {% if not request.GET.q %}active{% endif %}">Todo</button>

            <button onclick="window.location.href='?q=tendencia'"
                class="btn-filter {% if request.GET.q == 'tendencia' %}active{% endif %}">游댠 Tendencia</button>

            <!-- Dynamic Chips -->
            <button onclick="setFilter('KETO', this)" class="btn-filter filter-chip">游볨 Keto</button>
            <button onclick="setFilter('VEGA', this)" class="btn-filter filter-chip">游 Vegana</button>
            <button onclick="setFilter('PROT', this)" class="btn-filter filter-chip">游꼥 Proteica</button>
        </div>

        <!-- AI PLAN SECTION (HIDDEN) -->
        <div id="dailyPlanSection"
            class="d-none mb-5 p-4 bg-white rounded-4 shadow-sm border border-success-subtle position-relative">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold m-0 d-flex align-items-center gap-2 text-dark">
                    <span class="material-symbols-outlined text-success">auto_awesome</span> Plan Sugerido
                </h4>
                <button onclick="closeAiPlan()" class="btn btn-sm btn-link text-muted p-0"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div id="dailyPlanContent"></div>
            <div class="d-flex justify-content-end mt-4 pt-3 border-top">
                <button onclick="addAllToCalendar()" class="btn-primary-custom">A침adir Todo al Calendario</button>
            </div>
        </div>

        <!-- RECIPE GRID -->
        <div class="row row-cols-2 row-cols-lg-4 g-3 g-md-4" id="recipe-grid">
            {% for receta in recetas %}
            <div class="col filter-item" data-category="{{ receta.categoria|lower }}"
                data-type="{{ receta.tipo_dieta }}" data-prot="{{ receta.proteinas }}"
                data-userrecipe="{% if user.is_authenticated and user.perfil and receta.perfil_creador == user.perfil %}true{% else %}false{% endif %}"
                data-favorite="{% if user.is_authenticated and receta.id in favoritas_ids %}true{% else %}false{% endif %}"
                data-title="{{ receta.titulo|lower }}">

                <div class="recipe-card-container shadow-sm group" style="cursor: pointer;"
                    onclick="openRecipeDetail(this)" data-id="{{ receta.id }}" data-title="{{ receta.titulo|escape }}"
                    data-kcal="{{ receta.calorias|default:0 }}" data-time="{{ receta.tiempo|escape }}"
                    data-rating="{{ receta.rating|default:0 }}"
                    data-img="{% if receta.imagen_url %}{{ receta.imagen_url|escape }}{% else %}https://images.unsplash.com/photo-1495521821757-a1efb6729352?w=500&h=300&fit=crop{% endif %}"
                    data-desc="{{ receta.descripcion|striptags|escape }}" data-prot-val="{{ receta.proteinas }}"
                    data-carbs-val="{{ receta.carbos }}" data-fats-val="{{ receta.grasas }}">

                    <div class="position-relative overflow-hidden" style="aspect-ratio: 4/3;">
                        <button class="favorite-btn {% if receta.id in favoritas_ids %}active{% endif %}"
                            onclick="event.stopPropagation(); toggleFavorite({{ receta.id }}, this)">
                            <span class="material-symbols-outlined">favorite</span>
                        </button>
                        <img src="{% if receta.imagen_url %}{{ receta.imagen_url }}{% else %}https://images.unsplash.com/photo-1495521821757-a1efb6729352?w=500&h=300&fit=crop{% endif %}"
                            class="recipe-img w-100 h-100 object-cover" alt="{{ receta.titulo }}">

                        <span class="position-absolute bottom-0 start-0 m-2 px-2 py-1 text-white fw-bold rounded small"
                            style="background: rgba(0,0,0,0.6); font-size: 0.65rem; backdrop-filter: blur(4px);">
                            {{ receta.tipo_dieta }}
                        </span>
                    </div>

                    <div class="p-3 d-flex flex-column flex-grow-1">
                        <h6 class="fw-bold text-dark text-truncate mb-2">{{ receta.titulo }}</h6>

                        <div class="d-flex flex-wrap gap-1 mb-3">
                            <span class="macro-pill"
                                style="background: var(--macro-protein); color: var(--macro-protein-text);">P: {{  receta.proteinas }}g</span>
                            <span class="macro-pill"
                                style="background: var(--macro-carbs); color: var(--macro-carbs-text);">C: {{ receta.carbos }}g</span>
                            <span class="macro-pill"
                                style="background: var(--macro-fats); color: var(--macro-fats-text);">G: {{ receta.grasas }}g</span>
                        </div>

                        <div
                            class="mt-auto d-flex justify-content-between align-items-center pt-2 border-top border-light">
                            <div class="d-flex align-items-center gap-1 text-muted small">
                                <span class="material-symbols-outlined" style="font-size: 14px;">schedule</span>
                                <span class="fw-bold" style="font-size: 0.7rem;">{{ receta.tiempo }}</span>
                            </div>
                            <div class="d-flex align-items-center gap-1 text-dark small">
                                <span class="material-symbols-outlined"
                                    style="font-size: 14px;">local_fire_department</span>
                                <span class="fw-bold" style="font-size: 0.7rem;">{{ receta.calorias }} Kcal</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center py-5">
                <span class="material-symbols-outlined text-secondary" style="font-size: 3rem;">search_off</span>
                <p class="text-muted fw-bold mt-2">No se encontraron recetas</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- CALENDAR VIEW -->
    <div id="calendar-week-container" class="{% if vista_activa != 'calendario' %}d-none{% endif %}">
        <div class="calendar-grid">
            {% for dia in semana_calendario %}
            <div class="calendar-day-card {% if dia.is_today %}today{% endif %}">
                <div class="text-center border-bottom pb-2 mb-3">
                    <small class="fw-bold text-success text-uppercase">{{ dia.nombre }}</small>
                    <div class="h3 fw-bolder m-0 text-dark">{{ dia.dia_num }}</div>
                </div>

                <div class="d-flex flex-column gap-2 flex-grow-1">
                    {% for comida in dia.comidas %}
                    <div class="bg-light p-2 rounded position-relative group border border-transparent">
                        <div class="fw-bold text-dark text-truncate pe-3" style="font-size: 0.85rem;">{{ comida.nombre }}</div>
                        <small class="text-muted fw-bold" style="font-size: 0.7rem;">{{ comida.calorias }} kcal</small>
                        <button type="button" onclick="removeFromCalendar({{ comida.id }}, this)"
                            class="btn btn-sm text-danger p-0 position-absolute top-0 end-0 me-1 mt-1"
                            style="line-height:0;">
                            <span class="material-symbols-outlined" style="font-size: 16px;">close</span>
                        </button>
                    </div>
                    {% endfor %}
                </div>

                <button onclick="openAddMealModal('{{ dia.fecha|date:'Y-m-d' }}')"
                    class="btn btn-outline-light w-100 mt-3 border-dashed text-muted fw-bold d-flex justify-content-center align-items-center gap-1"
                    style="border: 2px dashed #e5e7eb; font-size: 0.75rem;">
                    <span class="material-symbols-outlined" style="font-size: 16px;">add</span> A칌ADIR
                </button>
            </div>
            {% endfor %}
        </div>
    </div>

</div>

<!-- OVERSLAYS -->

<!-- Recipe Detail popup -->
<div id="recipe-detail-view" class="recipe-Detail-overlay" onclick="handleBackdropClick(event)">
    <!-- Backdrop oscuro (ahora fuera del panel para cubrir todo) -->
    <div class="recipe-detail-backdrop"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1;"></div>

    <!-- Panel Modal -->
    <div class="recipe-detail-panel">
        <nav class="sticky-nav">
            <div class="container-fluid d-flex align-items-center justify-content-between p-3">
                <button class="btn-round-icon" onclick="closeRecipeDetail()">
                    <span class="material-symbols-outlined">close</span>
                </button>
                <h2 class="h6 mb-0 fw-bold flex-grow-1 text-center">Detalle de Comida</h2>
                <div style="width: 40px;" class="d-flex justify-content-end">
                    <button class="btn-round-icon">
                        <span class="material-symbols-outlined">share</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Scrollable Content wrapper -->
        <div class="recipe-detail-content">
            <div class="container-fluid px-3">
                <div id="detailHeroImg" class="hero-image-detail mt-1 mb-4" style="background-image: url('');"></div>

                <div class="mb-4">
                    <h1 id="detailTitle" class="fw-bolder mb-3" style="font-size: 1.875rem; line-height: 1.2;">T칤tulo
                    </h1>
                    <div class="d-flex flex-wrap gap-2">
                        <div class="stat-badge">
                            <span class="material-symbols-outlined"
                                style="color: var(--primary-color); font-size: 20px;">local_fire_department</span>
                            <span id="detailKcal">0 kcal</span>
                        </div>
                        <div class="stat-badge">
                            <span class="material-symbols-outlined"
                                style="color: var(--primary-color); font-size: 20px;">schedule</span>
                            <span id="detailTime">0 min</span>
                        </div>
                        <div class="stat-badge">
                            <span class="material-symbols-outlined"
                                style="color: var(--primary-color); font-size: 20px;">star</span>
                            <span id="detailRating">0</span>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h2 class="h5 fw-bold mb-3">Macros Detallados</h2>
                    <div class="custom-card">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2 fw-bold small">
                                <span>Prote칤nas</span>
                                <span id="detailProtPercent">0g</span>
                            </div>
                            <div class="progress">
                                <div id="detailProtBar" class="progress-bar bg-primary-custom" role="progressbar"
                                    style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2 fw-bold small">
                                <span>Carbohidratos</span>
                                <span id="detailCarbsPercent">0g</span>
                            </div>
                            <div class="progress">
                                <div id="detailCarbsBar" class="progress-bar" role="progressbar"
                                    style="width: 0%; background-color: #fb923c;"></div>
                            </div>
                        </div>
                        <div>
                            <div class="d-flex justify-content-between mb-2 fw-bold small">
                                <span>Grasas</span>
                                <span id="detailFatsPercent">0g</span>
                            </div>
                            <div class="progress">
                                <div id="detailFatsBar" class="progress-bar" role="progressbar"
                                    style="width: 0%; background-color: #60a5fa;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2 class="h5 fw-bold mb-0">Ingredientes</h2>
                        <span class="fw-bold small" style="color: var(--primary-color);">1 raci칩n</span>
                    </div>
                    <div id="detailIngredients" class="d-flex flex-column gap-2"></div>
                </div>

                <div class="mb-5" style="padding-bottom: 50px;">
                    <h2 class="h5 fw-bold mb-4">Preparaci칩n</h2>
                    <div id="detailSteps" class="d-flex flex-column gap-4 text-secondary small"
                        style="line-height:1.8;">
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-action-container"
            style="position: absolute; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #eee; padding: 1rem; z-index: 5;">
            <button id="showDateSelectorBtn" class="btn-add" onclick="showDateSelector()">A침adir a mi plan</button>
        </div>

        <!-- Date Selector Mini Calendar Overlay -->
        <div id="dateSelector" class="date-selector-overlay">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold m-0">쮺u치ndo quieres comerlo?</h5>
                <button class="btn btn-sm btn-light rounded-circle" onclick="hideDateSelector()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="d-flex gap-2 overflow-auto pb-2 scrollbar-hide" id="miniCalendarDays">
                <!-- Days will be injected by JS -->
            </div>

            <button id="finalAddBtn" class="btn-primary-custom w-100 justify-content-center py-3 mt-3 shadow-sm"
                style="font-size: 1rem; border-radius: 16px;">
                Confirmar y A침adir
            </button>
        </div>
    </div>
</div>

<!-- Add Meal Modal (Bootstrap Style Overlay) -->
<div id="add-meal-view" class="recipe-creator-overlay">
    <div class="recipe-creator-container p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <button onclick="closeAddMeal()" class="btn btn-sm fw-bold text-muted d-flex align-items-center gap-1">
                <span class="material-symbols-outlined">arrow_back</span> Volver
            </button>
            <h5 class="fw-bold m-0">A침adir Comida</h5>
        </div>

        <input type="text" id="recipeSearchModal" onkeyup="filterModalRecipes()"
            class="form-control bg-light border-0 py-3 px-4 rounded-4 mb-4 fw-bold" placeholder="Buscar receta...">

        <div class="row row-cols-2 row-cols-md-3 g-3" style="max-height: 60vh; overflow-y: auto;">
            {% for receta in recetas %}
            <div class="col modal-recipe-item" data-title="{{ receta.titulo|lower }}">
                <div class="p-2 border rounded-3 d-flex align-items-center gap-2" style="cursor: pointer;"
                    onclick="confirmAddRecipe({{ receta.id }}, '{{ receta.titulo|escapejs }}')">

                    <img src="{% if receta.imagen_url %}{{ receta.imagen_url }}{% else %}https://images.unsplash.com/photo-1495521821757-a1efb6729352?w=100&h=100&fit=crop{% endif %}"
                        class="rounded" style="width: 40px; height: 40px; object-fit: cover;">
                    <div class="text-truncate">
                        <div class="fw-bold small text-truncate">{{ receta.titulo }}</div>
                        <div class="text-muted" style="font-size: 10px;">{{ receta.calorias }} kcal</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Creator FAB -->
<a href="javascript:void(0)" class="fab-btn" id="openCreator"
    onclick="document.getElementById('recipeOverlay').classList.add('show')">
    <span class="material-symbols-outlined" style="font-size: 32px;">add</span>
</a>

<!-- Creator Overlay -->
<div class="recipe-creator-overlay" id="recipeOverlay">
    <div class="recipe-creator-container">
        <form id="recipeCreatorForm" hx-post="{% url 'base:crear_receta' %}" hx-swap="none"
            hx-on::after-request="if(event.detail.successful) { location.reload(); }">
            {% csrf_token %}
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                <span class="material-symbols-outlined cursor-pointer"
                    onclick="document.getElementById('recipeOverlay').classList.remove('show')">arrow_back</span>
                <h5 class="fw-bold m-0">Nueva Receta</h5>
                <div style="width: 24px;"></div>
            </div>
            <div class="p-4">
                <div class="mb-3">
                    <label class="small fw-bold text-muted mb-1 text-uppercase">T칤tulo</label>
                    <input name="titulo" class="form-control bg-light border-0 py-2 fw-bold" required
                        placeholder="Ej. Pollo con Arroz">
                </div>
                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <label class="small fw-bold text-muted mb-1 text-uppercase">Dieta</label>
                        <select name="dieta" class="form-select bg-light border-0 fw-bold">
                            {% for code, name in opciones_dieta.items %}<option value="{{ code }}">{{ name }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold text-muted mb-1 text-uppercase">Categor칤a</label>
                        <select name="categoria" class="form-select bg-light border-0 fw-bold">
                            {% for cat in categorias_receta %}<option value="{{ cat }}">{{ cat|capfirst }}</option>{% endfor %}
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="small fw-bold text-muted mb-1 text-uppercase">Calor칤as</label>
                    <input type="number" name="calorias" class="form-control bg-light border-0 py-2 fw-bold"
                        placeholder="0">
                </div>
                <div class="mb-4">
                    <label class="small fw-bold text-muted mb-1 text-uppercase">Detalles</label>
                    <textarea name="descripcion" rows="4" class="form-control bg-light border-0 fw-bold"
                        placeholder="Ingredientes y pasos..."></textarea>
                </div>
                <button class="btn btn-primary-custom w-100 justify-content-center py-3">Guardar Receta</button>
            </div>
        </form>
    </div>
</div>


<script>
    // --- JS LOGIC (Preserved) ---

    // Tabs
    function switchTab(tabId) {
        document.querySelectorAll('#recipe-tabs .nav-link').forEach(b => b.classList.remove('active'));
        const btn = document.querySelector(`#recipe-tabs .nav-link[data-tab="${tabId}"]`);
        if (btn) btn.classList.add('active');
        applyFilters(tabId);
    }

    // Filters
    let activeTypeFilter = null;
    function setFilter(type, btn) {
        if (activeTypeFilter === type) {
            activeTypeFilter = null;
            btn.classList.remove('active');
        } else {
            activeTypeFilter = type;
            document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        applyFilters();
    }

    function applyFilters(forcedTab) {
        const activeTab = forcedTab || document.querySelector('#recipe-tabs .nav-link.active')?.dataset.tab || 'explorar';
        const query = document.querySelector('input[name="q"]')?.value.toLowerCase() || '';

        document.querySelectorAll('.filter-item').forEach(item => {
            const d = item.dataset;
            const isFav = d.favorite === 'true';
            const isMine = d.userrecipe === 'true';
            const title = (d.title || '').toLowerCase();

            let visible = true;

            if (activeTab === 'favoritos' && !isFav) visible = false;
            if (activeTab === 'mis-recetas' && !isMine) visible = false;
            if (query && !title.includes(query)) visible = false;

            if (activeTypeFilter) {
                if (activeTypeFilter === 'PROT') {
                    if (parseInt(d.prot || '0') < 25) visible = false;
                } else if ((d.type || '') !== activeTypeFilter) {
                    visible = false;
                }
            }

            item.classList.toggle('d-none', !visible);
        });
    }

    document.querySelector('input[name="q"]')?.addEventListener('input', () => applyFilters());

    // Detail
    let currentDetailRecipeId = null;
    let currentSelectedDate = null;

    function openRecipeDetail(card) {
        const d = card.dataset;
        currentDetailRecipeId = d.id;
        document.getElementById('detailTitle').innerText = d.title;
        document.getElementById('detailKcal').innerText = d.kcal + ' kcal';
        document.getElementById('detailTime').innerText = d.time;
        document.getElementById('detailRating').innerText = d.rating || '0';

        // Set hero image
        document.getElementById('detailHeroImg').style.backgroundImage = `url('${d.img}')`;

        // Macros: compute percentages if values available
        const prot = parseFloat(d.protVal || '0');
        const carbs = parseFloat(d.carbsVal || '0');
        const fats = parseFloat(d.fatsVal || '0');
        const total = (prot + carbs + fats) || 1;
        const protPct = Math.round((prot / total) * 100);
        const carbsPct = Math.round((carbs / total) * 100);
        const fatsPct = Math.round((fats / total) * 100);

        document.getElementById('detailProtPercent').innerText = `${prot}g (${protPct}%)`;
        document.getElementById('detailCarbsPercent').innerText = `${carbs}g (${carbsPct}%)`;
        document.getElementById('detailFatsPercent').innerText = `${fats}g (${fatsPct}%)`;

        document.getElementById('detailProtBar').style.width = protPct + '%';
        document.getElementById('detailCarbsBar').style.width = carbsPct + '%';
        document.getElementById('detailFatsBar').style.width = fatsPct + '%';

        // Parse description into ingredients and steps
        const temp = document.createElement('div');
        temp.innerHTML = d.desc || '';
        const fullText = temp.innerText || '';

        let ingredientsHtml = '';
        let stepsHtml = '';

        if (fullText.toUpperCase().includes('INGREDIENTES')) {
            const parts = fullText.split(/PREPARACI|PREPARACI칍N/);
            ingredientsHtml = parts[0].replace(/INGREDIENTES:\s*/i, '').trim();
            stepsHtml = (parts[1] || '').trim();
        } else {
            // Fallback: show whole description as steps
            stepsHtml = fullText;
        }

        // Populate ingredients: if ingredientsHtml contains lines, convert to cards
        const ingContainer = document.getElementById('detailIngredients');
        ingContainer.innerHTML = '';
        if (ingredientsHtml) {
            ingredientsHtml.split(/\n|\r\n/).map(s => s.trim()).filter(Boolean).forEach(line => {
                const card = document.createElement('div');
                card.className = 'custom-card p-3 d-flex justify-content-between align-items-center';
                card.innerHTML = `<div class="d-flex align-items-center gap-3"><span class="material-symbols-outlined" style="color: var(--primary-color);">check_circle</span><span class="fw-medium">${line}</span></div>`;
                ingContainer.appendChild(card);
            });
        }

        // Populate steps area
        const stepsContainer = document.getElementById('detailSteps');
        stepsContainer.innerHTML = '';
        if (stepsHtml) {
            // split by numbered or line breaks
            const stepLines = stepsHtml.split(/\n|\r\n/).map(s => s.trim()).filter(Boolean);
            if (stepLines.length > 0) {
                stepLines.forEach((line, idx) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'd-flex gap-3';
                    wrapper.innerHTML = `<div class="step-number">${idx + 1}</div><p class="small mb-0">${line}</p>`;
                    stepsContainer.appendChild(wrapper);
                });
            } else {
                stepsContainer.innerHTML = `<p class="small">${stepsHtml}</p>`;
            }
        }

        // Show overlay popup
        document.getElementById('recipe-detail-view').classList.add('show');
        document.body.style.overflow = 'hidden';

        hideDateSelector();
    }

    function closeRecipeDetail() {
        document.getElementById('recipe-detail-view').classList.remove('show');
        document.body.style.overflow = '';
        hideDateSelector();
    }

    // Date Selector Logic
    let selectedDates = [];
    let caloriasData = {};
    let recipeCalories = 0;

    async function showDateSelector() {
        selectedDates = [];
        const container = document.getElementById('miniCalendarDays');
        container.innerHTML = '<div class="text-center p-3"><span class="spinner-border spinner-border-sm"></span> Cargando...</div>';

        document.getElementById('dateSelector').classList.add('show');

        // Get recipe calories
        const kcalText = document.getElementById('detailKcal').innerText;
        recipeCalories = parseInt(kcalText) || 0;

        // Fetch calorie data for the next 7 days
        try {
            const response = await fetch('/api/obtener_calorias_dias/', {
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            });
            const data = await response.json();

            if (data.success) {
                caloriasData = {};
                data.dias.forEach(dia => {
                    caloriasData[dia.fecha] = {
                        calorias: dia.calorias,
                        meta: dia.meta
                    };
                });

                renderCalendar();
            }
        } catch (error) {
            console.error('Error fetching calorie data:', error);
            renderCalendar(); // Render anyway with default data
        }
    }

    function renderCalendar() {
        const container = document.getElementById('miniCalendarDays');
        container.innerHTML = '';

        const days = ['Dom', 'Lun', 'Mar', 'Mi칠', 'Jue', 'Vie', 'S치b'];
        const today = new Date();

        for (let i = 0; i < 7; i++) {
            const date = new Date();
            date.setDate(today.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];
            const isToday = i === 0;

            const dayData = caloriasData[dateStr] || { calorias: 0, meta: 2000 };
            const currentCal = dayData.calorias;
            const metaCal = dayData.meta;
            const currentProgress = Math.min((currentCal / metaCal) * 100, 100);

            const chip = document.createElement('div');
            chip.className = 'date-chip';
            chip.dataset.date = dateStr;
            chip.onclick = function () {
                toggleDateSelection(this);
            };

            chip.innerHTML = `
                <small>${isToday ? 'Hoy' : days[date.getDay()]}</small>
                <span class="day-number">${date.getDate()}</span>
                <div class="cal-info">
                    ${currentCal}/${metaCal} kcal
                </div>
                <div class="cal-progress-mini">
                    <div class="cal-progress-fill" style="width: ${currentProgress}%"></div>
                </div>
            `;
            container.appendChild(chip);
        }

        updateConfirmButton();
    }

    function toggleDateSelection(chipElement) {
        const dateStr = chipElement.dataset.date;
        const index = selectedDates.indexOf(dateStr);

        if (index > -1) {
            selectedDates.splice(index, 1);
            chipElement.classList.remove('selected');
            // Remove preview badge if exists
            const badge = chipElement.querySelector('.preview-badge');
            if (badge) badge.remove();

            // Reset progress bar to current
            const dayData = caloriasData[dateStr] || { calorias: 0, meta: 2000 };
            const currentProgress = Math.min((dayData.calorias / dayData.meta) * 100, 100);
            const progressBar = chipElement.querySelector('.cal-progress-fill');
            progressBar.style.width = currentProgress + '%';

            // Update cal info
            chipElement.querySelector('.cal-info').textContent = `${dayData.calorias}/${dayData.meta} kcal`;
        } else {
            selectedDates.push(dateStr);
            chipElement.classList.add('selected');

            // Show preview
            const dayData = caloriasData[dateStr] || { calorias: 0, meta: 2000 };
            const previewCal = dayData.calorias + recipeCalories;
            const previewProgress = Math.min((previewCal / dayData.meta) * 100, 100);

            // Update progress bar
            const progressBar = chipElement.querySelector('.cal-progress-fill');
            progressBar.style.width = previewProgress + '%';

            // Update cal info with preview
            chipElement.querySelector('.cal-info').textContent = `${previewCal}/${dayData.meta} kcal`;

            // Add preview badge
            const badge = document.createElement('div');
            badge.className = 'preview-badge';
            badge.textContent = `+${recipeCalories}`;
            chipElement.appendChild(badge);
        }

        updateConfirmButton();
    }

    function updateConfirmButton() {
        const btn = document.getElementById('finalAddBtn');
        if (selectedDates.length === 0) {
            btn.textContent = 'Selecciona al menos un d칤a';
            btn.disabled = true;
            btn.style.opacity = '0.5';
        } else {
            const count = selectedDates.length;
            btn.textContent = `A침adir a ${count} d칤a${count > 1 ? 's' : ''}`;
            btn.disabled = false;
            btn.style.opacity = '1';

            btn.onclick = function () {
                const title = document.getElementById('detailTitle').innerText;
                confirmAddRecipeMultiple(currentDetailRecipeId, title, selectedDates);
            };
        }
    }

    function hideDateSelector() {
        document.getElementById('dateSelector').classList.remove('show');
        selectedDates = [];
    }

    function confirmAddRecipeMultiple(id, title, dates) {
        if (dates.length === 0) return;

        const datesText = dates.length === 1 ? dates[0] : `${dates.length} d칤as`;
        if (confirm(`쮸침adir "${title}" a ${datesText}?`)) {
            // Helper to make request
            const makeRequest = (datesToProcess, force = false) => {
                const promises = datesToProcess.map(fecha => {
                    return fetch('/api/agregar_al_calendario/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ receta_ids: [id], fecha: fecha, force: force })
                    }).then(res => res.json());
                });

                Promise.all(promises).then(results => {
                    let allWarnings = [];
                    let lastMessage = "";
                    let retryItems = [];

                    results.forEach((data, index) => {
                        if (data.requires_confirmation) {
                            retryItems.push({ date: datesToProcess[index], msg: data.message });
                        } else {
                            if (data.warnings && data.warnings.length > 0) allWarnings.push(...data.warnings);
                            if (data.message) lastMessage = data.message;
                        }
                    });

                    if (retryItems.length > 0) {
                        const msg = "丘멆잺 Conflictos detectados:\n" + retryItems.map(i => i.msg).join("\n") + "\n\n쮸침adir igualmente?";
                        if (confirm(msg)) {
                            // Retry ONLY the ones that required confirmation
                            const retryDates = retryItems.map(i => i.date);
                            makeRequest(retryDates, true);
                            return;
                        }
                    }

                    let finalMsg = lastMessage || "춰Guardado con 칠xito!";
                    if (allWarnings.length > 0) {
                        finalMsg += "\n\n丘멆잺 Avisos:\n" + [...new Set(allWarnings)].join("\n");
                    }
                    alert(finalMsg);
                    location.reload();
                });
            };
            
            makeRequest(dates, false);
        }
    }

    // Close popup when clicking on backdrop
    function handleBackdropClick(event) {
        if (event.target.classList.contains('recipe-Detail-overlay') ||
            event.target.classList.contains('recipe-detail-backdrop')) {
            closeRecipeDetail();
        }
    }

    // Favorite
    function toggleFavorite(id, btn) {
        fetch(`/api/toggle_favorito/${id}/`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
            .then(res => res.json()).then(data => {
                if (data.status === 'success') {
                    if (data.is_favorite) btn.classList.add('active'); else btn.classList.remove('active');
                    btn.closest('.filter-item').dataset.favorite = data.is_favorite;
                }
            });
    }

    // Calendar Add
    let selectedDate = null;
    function openAddMealModal(date) {
        selectedDate = date;
        document.getElementById('calendar-week-container').classList.add('d-none');
        document.getElementById('add-meal-view').classList.add('show');
    }
    function closeAddMeal() {
        document.getElementById('add-meal-view').classList.remove('show');
        document.getElementById('calendar-week-container').classList.remove('d-none');
    }
    function filterModalRecipes() {
        const q = document.getElementById('recipeSearchModal').value.toLowerCase();
        document.querySelectorAll('.modal-recipe-item').forEach(item => {
            item.style.display = (item.dataset.title || '').includes(q) ? '' : 'none';
        });
    }
    function confirmAddRecipe(id, title, forceDate) {
        const targetDate = forceDate || selectedDate || new Date().toISOString().split('T')[0];
        if (confirm(`쮸침adir "${title}" al ${targetDate}?`)) {
            const makeRequest = (force = false) => {
                fetch('/api/agregar_al_calendario/', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
                    body: JSON.stringify({ receta_ids: [id], fecha: targetDate, force: force })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.requires_confirmation) {
                            if (confirm(data.message)) {
                                makeRequest(true);
                            }
                            return;
                        }

                        let msg = data.message || "춰A침adido!";
                        if (data.warnings && data.warnings.length > 0) {
                            msg += "\n\n丘멆잺 Atenci칩n:\n" + data.warnings.join("\n");
                        }
                        alert(msg);
                        location.reload();
                    });
            };
            makeRequest(false);
        }
    }
    function removeFromCalendar(id, btn) {
        if (confirm('쯈uitar del calendario?')) {
            fetch(`/api/quitar_del_calendario/${id}/`, {
                method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            }).then(r => location.reload());
        }
    }

    // AI Plan
    function generateAutoPlan() {
        const sec = document.getElementById('dailyPlanSection');
        sec.classList.remove('d-none');
        document.getElementById('dailyPlanContent').innerHTML = '<div class="text-center p-4 text-muted"><span class="material-symbols-outlined spin">sync</span> Generando...</div>';

        fetch('/api/generar_plan_ia/', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
            .then(res => res.json()).then(data => {
                if (data.success) {
                    window.currentAiPlan = data.plan;
                    let html = '<div class="row g-3">';
                    data.plan.forEach((m, idx) => {
                        html += `
                        <div class="col-6 col-md-3">
                            <div class="card h-100 border shadow-sm">
                                <img src="${m.imagen_url}" class="card-img-top" style="height:100px; object-fit:cover;">
                                <div class="card-body p-2">
                                    <div class="small fw-bold text-truncate">${m.titulo}</div>
                                    <div class="d-flex justify-content-between text-muted" style="font-size:10px;">
                                        <span>${m.tipo}</span>
                                        <span>${m.calorias} kcal</span>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    });
                    html += '</div>';
                    document.getElementById('dailyPlanContent').innerHTML = html;
                }
            });
    }
    function closeAiPlan() { document.getElementById('dailyPlanSection').classList.add('d-none'); }
    function addAllToCalendar() {
        if (!window.currentAiPlan) return;
        const ids = window.currentAiPlan.map(m => m.id);
        const today = new Date().toISOString().split('T')[0];
        if (confirm('쮸침adir plan a hoy?')) {
            const makeRequest = (force = false) => {
                fetch('/api/agregar_al_calendario/', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
                    body: JSON.stringify({ receta_ids: ids, fecha: today, force: force })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.requires_confirmation) {
                            if (confirm(data.message)) {
                                makeRequest(true);
                            }
                            return;
                        }

                        let msg = data.message || "춰Plan a침adido!";
                        if (data.warnings && data.warnings.length > 0) {
                            msg += "\n\n丘멆잺 Atenci칩n:\n" + data.warnings.join("\n");
                        }
                        alert(msg);
                        location.reload();
                    });
            };
            makeRequest(false);
        }
    }

</script>
{% endblock %}