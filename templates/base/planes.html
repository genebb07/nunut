{% extends base_template %}
{% load static %}

{% block title %}Explorador de Recetas | nunut{% endblock %}

{% block content %}
<style>
    :root {
        --primary-color: #85c81a;
        --primary-dark: #74b016;
        --macro-protein: rgba(56, 189, 248, 0.1);
        --macro-protein-text: #0284c7;
        --macro-carbs: rgba(251, 191, 36, 0.1);
        --macro-carbs-text: #b45309;
        --macro-fats: rgba(239, 68, 68, 0.1);
        --macro-fats-text: #b91c1c;
    }

    /* Estilos de Tarjetas */
    .recipe-card {
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 1.5rem;
        overflow: hidden;
        transition: var(--transition-fluid);
        background: var(--bg-content);
        height: 100%;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
    }

    .recipe-card:hover {
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
        transform: translateY(-8px);
    }

    .dark-mode .recipe-card {
        border-color: rgba(255, 255, 255, 0.05);
    }

    .img-container {
        position: relative;
        aspect-ratio: 16/10;
        overflow: hidden;
    }

    .recipe-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.6s cubic-bezier(0.165, 0.84, 0.44, 1);
    }

    .recipe-card:hover .recipe-img {
        transform: scale(1.1);
    }

    /* Bot칩n Favorito */
    .favorite-btn {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        width: 38px;
        height: 38px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(8px);
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: var(--transition-fluid);
        color: #adb5bd;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .favorite-btn:hover {
        background: white;
        transform: scale(1.1);
        color: var(--primary-color);
    }

    .favorite-btn.active {
        color: var(--primary-color);
    }

    .favorite-btn.active .fill-icon {
        font-variation-settings: 'FILL' 1;
    }

    /* Tabs y Filtros */
    .nav-tabs-custom {
        display: flex;
        gap: 2rem;
        border-bottom: 2px solid rgba(0, 0, 0, 0.05);
        overflow-x: auto;
        white-space: nowrap;
        margin-bottom: 2rem;
        padding-bottom: 0.5rem;
    }

    .nav-tabs-custom button {
        background: none;
        border: none;
        padding: 0.75rem 0;
        font-weight: 800;
        color: var(--text-muted);
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.05em;
    }

    .nav-tabs-custom button.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }

    /* Macros */
    .macro-pill {
        padding: 4px 10px;
        border-radius: 50px;
        font-size: 0.65rem;
        font-weight: 800;
        text-transform: uppercase;
    }

    /* FAB */
    .fab-btn {
        position: fixed;
        bottom: 110px;
        right: 2rem;
        width: 60px;
        height: 60px;
        background-color: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 25px var(--primary-glow);
        text-decoration: none !important;
        z-index: 1000;
        transition: var(--transition-fluid);
    }

    .fab-btn:hover {
        transform: scale(1.1) rotate(90deg);
        color: white;
    }

    .search-input-container {
        position: relative;
        min-width: 320px;
    }

    .search-input {
        border-radius: 15px;
        padding: 0.75rem 1rem 0.75rem 3rem;
        background-color: var(--bg-content);
        border: 1px solid rgba(0, 0, 0, 0.08);
        transition: all 0.3s;
    }

    .search-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px var(--primary-light);
    }

    .recipe-detail-offcanvas {
        width: 100% !important;
        max-width: 550px !important;
        border-left: 0;
        background-color: var(--bg-content) !important;
        box-shadow: -10px 0 40px rgba(0, 0, 0, 0.1);
    }

    .dark-mode .recipe-detail-offcanvas {
        background-color: var(--bg-content) !important;
        color: var(--text-main);
    }

    .stat-badge {
        background-color: var(--primary-light);
        padding: 8px 16px;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--primary-dark) !important;
    }

    .detail-hero-img {
        width: 100%;
        height: 250px;
        border-radius: 1.5rem;
        background-size: cover;
        background-position: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .custom-card-detail {
        background: var(--bg-page);
        border-radius: 1rem;
        padding: 1.5rem;
        /* Dark mode compatibility */
    }

    .dark-mode .custom-card-detail {
        background: rgba(255, 255, 255, 0.03);
    }

    .step-number-circle {
        width: 30px;
        height: 30px;
        min-width: 30px;
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 0.8rem;
    }

    .btn-add-diary {
        width: 100%;
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 1rem;
        border-radius: 1rem;
        font-weight: 800;
        transition: all 0.3s;
    }

    .btn-add-diary:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px var(--primary-glow);
    }

    /* Creator Overlay */
    .recipe-creator-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        z-index: 5000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: all 0.4s;
    }

    .recipe-creator-overlay.show {
        opacity: 1;
        pointer-events: auto;
    }

    .recipe-creator-container {
        width: 100%;
        max-width: 600px;
        height: 90vh;
        background: var(--bg-content);
        border-radius: 2rem;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transform: translateY(50px);
        transition: all 0.4s;
    }

    .recipe-creator-overlay.show .recipe-creator-container {
        transform: translateY(0);
    }

    .upload-box {
        border: 2px dashed rgba(133, 200, 26, 0.3);
        border-radius: 1.25rem;
        padding: 2.5rem;
        text-align: center;
        background: var(--bg-page);
        cursor: pointer;
        transition: all 0.3s;
    }

    .upload-box:hover {
        border-color: var(--primary-color);
        background: var(--primary-light);
    }

    .creator-input {
        background: var(--bg-page) !important;
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 12px;
        padding: 0.8rem 1rem;
        font-weight: 600;
    }

    .dark-mode .creator-input {
        border-color: rgba(255, 255, 255, 0.05);
    }

    .btn-creator-save {
        width: 100%;
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 1.2rem;
        border-radius: 15px;
        font-weight: 800;
        font-size: 1.1rem;
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

<div class="container py-4">
    <header class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
        <div>
            <h1 class="h3 fw-bolder m-0">Explorador de Recetas</h1>
            <p class="text-muted small mb-0 fw-bold">Descubre platos personalizados para tu objetivo.</p>
        </div>
        <div class="search-input-container">
            <span class="material-symbols-outlined position-absolute top-50 start-0 translate-middle-y ms-3"
                style="color: var(--primary-color)">auto_awesome</span>
            <form action="." method="get" class="w-100">
                <input type="text" name="q" class="form-control ps-5 search-input"
                    placeholder="Preg칰ntale a la IA (ej: 'algo keto con aguacate')..."
                    value="{{ request.GET.q|default:'' }}">
            </form>
        </div>
    </header>

    <nav class="nav-tabs-custom" id="recipe-tabs">
        <button class="active" data-tab="explorar">Explorar</button>
        <button data-tab="mis-recetas">Mis Recetas</button>
        <button data-tab="favoritos">Favoritos</button>
    </nav>

    <div class="d-flex gap-2 overflow-x-auto pb-3 mb-3" id="recipe-filters">
        <button class="filter-btn btn btn-sm rounded-pill px-3 fw-bold active" data-filter="todo"
            onclick="filterRecipes(this)" style="background-color: var(--primary-color); color: white;">Todo</button>
        <button class="filter-btn btn btn-sm bg-white border rounded-pill px-3 fw-bold text-secondary dark-mode-bg-dark"
            data-filter="tendencia" onclick="filterRecipes(this)">游댠
            Tendencia</button>
        <button class="filter-btn btn btn-sm bg-white border rounded-pill px-3 fw-bold text-secondary dark-mode-bg-dark"
            data-filter="keto" onclick="filterRecipes(this)">游볨
            Keto</button>
        <button class="filter-btn btn btn-sm bg-white border rounded-pill px-3 fw-bold text-secondary dark-mode-bg-dark"
            data-filter="vegana" onclick="filterRecipes(this)">游
            Vegana</button>
    </div>

    <div class="row row-cols-2 row-cols-lg-4 g-3 g-md-4" id="recipe-grid">
        <div id="no-results-msg" class="col-12 text-center py-5" style="display: none;">
            <span class="material-symbols-outlined fs-1 text-muted opacity-50 mb-2">search_off</span>
            <p class="text-muted fw-bold">No se encontraron recetas con este filtro.</p>
        </div>
        {% for receta in recetas %}
        <div class="col filter-item" data-category="{{ receta.categoria|lower }}" data-type="{{ receta.tipo_dieta }}"
            data-favorite="{% if receta.id in favoritas_ids %}true{% else %}false{% endif %}" data-userrecipe="false">
            <div class="recipe-card"
                onclick="showRecipeDetail('{{ receta.titulo }}', '{{ receta.calorias }} Kcal', '{{ receta.tiempo }}', '{{ receta.rating }}', '{{ receta.imagen_url }}', '{{ receta.proteinas }}', '0%', '{{ receta.carbos }}', '0%', '{{ receta.grasas }}', '0%')">
                <div class="img-container">
                    <button class="favorite-btn {% if receta.id in favoritas_ids %}active{% endif %}"
                        onclick="event.stopPropagation(); toggleFavorite({{ receta.id }}, this)">
                        <span class="material-symbols-outlined fill-icon">favorite</span>
                    </button>
                    <img src="{{ receta.imagen_url }}" class="recipe-img" alt="{{ receta.titulo }}">
                    <span class="badge-recipe bg-brand text-white" style="background-color: var(--primary-color);">{{
                        receta.tipo_dieta }}</span>
                </div>
                <div class="p-3">
                    <h3 class="h6 fw-bold line-clamp-2 mb-1" style="min-height: 2.4em;">{{ receta.titulo }}</h3>
                    <div class="d-flex flex-wrap gap-1 mb-3">
                        <span class="macro-pill"
                            style="background: var(--macro-protein); color: var(--macro-protein-text);">P: {{ receta.proteinas }}</span>
                        <span class="macro-pill"
                            style="background: var(--macro-carbs); color: var(--macro-carbs-text);">C: {{ receta.carbos }}</span>
                        <span class="macro-pill"
                            style="background: var(--macro-fats); color: var(--macro-fats-text);">G: {{ receta.grasas }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                        <div class="d-flex align-items-center gap-1 text-muted" style="font-size: 11px;">
                            <span class="material-symbols-outlined" style="font-size: 14px;">schedule</span> {{ receta.tiempo }}
                        </div>
                        <div class="d-flex align-items-center gap-1 fw-bold" style="font-size: 11px;">
                            <span class="material-symbols-outlined text-brand"
                                style="font-size: 14px;">local_fire_department</span> {{ receta.calorias }} Kcal
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 text-center py-5">
            <span class="material-symbols-outlined text-muted fs-1 mb-3">manage_search</span>
            <h3 class="h5 fw-bold text-muted">No encontramos recetas con esos filtros.</h3>
            <p class="small text-muted">Intenta ajustando tu b칰squeda o preg칰ntale a la IA.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Hidden element for JS empty state -->
    <div id="no-results-msg" class="d-none col-12 text-center py-5">
        <span class="material-symbols-outlined text-muted fs-1 mb-3">filter_list_off</span>
        <h3 class="h5 fw-bold text-muted">Sin resultados en esta categor칤a</h3>
        <p class="small text-muted">Prueba con otro filtro o la pesta침a "Explorar".</p>
    </div>


    <!-- Hardcoded cards removed -->

    <!-- SIDE RECIPE DETAIL OFF-CANVAS -->
    <div class="offcanvas offcanvas-end recipe-detail-offcanvas" tabindex="-1" id="recipeDetailOffcanvas"
        aria-labelledby="recipeDetailLabel">
        <div class="offcanvas-header p-3 border-bottom">
            <button type="button" class="btn border-0 d-flex align-items-center justify-content-center p-0"
                data-bs-dismiss="offcanvas"
                style="width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.05);">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h5 class="offcanvas-title fw-800 m-0 text-center flex-grow-1 h6" id="recipeDetailLabel">Detalle de Comida
            </h5>
            <button type="button" class="btn border-0 d-flex align-items-center justify-content-center p-0"
                style="width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.05);">
                <span class="material-symbols-outlined">share</span>
            </button>
        </div>
        <div class="offcanvas-body p-0">
            <div class="p-4">
                <div id="detailHeroImg" class="detail-hero-img mb-4"></div>

                <h1 id="detailTitle" class="fw-800 mb-3 h2 dark-mode-text-white" style="font-weight: 800;"></h1>

                <div class="d-flex flex-wrap gap-2 mb-4">
                    <div class="stat-badge">
                        <span class="material-symbols-outlined">local_fire_department</span>
                        <span id="detailKcal"></span>
                    </div>
                    <div class="stat-badge">
                        <span class="material-symbols-outlined">schedule</span>
                        <span id="detailTime"></span>
                    </div>
                    <div class="stat-badge">
                        <span class="material-symbols-outlined">star</span>
                        <span id="detailRating"></span>
                    </div>
                </div>

                <h2 class="h5 fw-bold mb-3 mt-5">Macros Detallados</h2>
                <div class="custom-card-detail mb-5">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="small fw-bold">Prote칤nas</span>
                            <span class="small fw-bold" id="detailProtText"></span>
                        </div>
                        <div class="progress" style="height: 10px; border-radius: 10px;">
                            <div id="detailProtBar" class="progress-bar bg-primary"
                                style="width: 0%; border-radius: 10px;">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="small fw-bold">Carbohidratos</span>
                            <span class="small fw-bold" id="detailCarbsText"></span>
                        </div>
                        <div class="progress" style="height: 10px; border-radius: 10px;">
                            <div id="detailCarbsBar" class="progress-bar bg-warning"
                                style="width: 0%; border-radius: 10px;"></div>
                        </div>
                    </div>
                    <div>
                        <div class="d-flex justify-content-between mb-1">
                            <span class="small fw-bold">Grasas</span>
                            <span class="small fw-bold" id="detailFatsText"></span>
                        </div>
                        <div class="progress" style="height: 10px; border-radius: 10px;">
                            <div id="detailFatsBar" class="progress-bar bg-info"
                                style="width: 0%; border-radius: 10px;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h5 fw-bold m-0">Ingredientes</h2>
                    <span class="small fw-bold text-brand">1 raci칩n</span>
                </div>
                <div class="d-grid gap-2 mb-5" id="detailIngredients">
                    <!-- Se poblar치 por JS -->
                </div>

                <h2 class="h5 fw-bold mb-3">Preparaci칩n</h2>
                <div class="d-grid gap-4 mb-5" id="detailSteps">
                    <!-- Se poblar치 por JS -->
                </div>
            </div>
        </div>
        <div class="offcanvas-footer p-3 bg-white border-top sticky-bottom dark-mode-bg-dark">
            <button class="btn-add-diary">A침adir a mi diario</button>
        </div>
    </div>

    <a href="javascript:void(0)" class="fab-btn" id="openCreator">
        <span class="material-symbols-outlined fs-2">add</span>
    </a>

    <!-- RECIPE CREATOR OVERLAY -->
    <div class="recipe-creator-overlay" id="recipeOverlay">
        <div class="recipe-creator-container">
            <!-- Header -->
            <header class="sticky-top p-3 d-flex align-items-center"
                style="background: var(--bg-content); border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 100;">
                <div id="closeCreator" class="d-flex align-items-center justify-content-center"
                    style="width: 48px; cursor: pointer;">
                    <span class="material-symbols-outlined">arrow_back</span>
                </div>
                <h2 class="h6 m-0 fw-bold flex-grow-1 text-center" style="margin-right: 48px !important;">Creador de
                    Recetas
                </h2>
            </header>

            <main class="p-4">
                <!-- Info section -->
                <section class="mb-4">
                    <h3 class="h6 fw-bold mb-3 text-uppercase opacity-75" style="letter-spacing: 1px;">Informaci칩n
                        General
                    </h3>

                    <div class="mb-3">
                        <label class="small fw-bold mb-2 opacity-75">T칤tulo de la receta</label>
                        <input type="text" class="form-control creator-input" placeholder="Ej. Ensalada Mediterr치nea">
                    </div>

                    <div class="row g-3">
                        <div class="col-sm-6">
                            <label class="small fw-bold mb-2 opacity-75">Categor칤a</label>
                            <select class="form-select creator-input">
                                <option value="">Seleccionar</option>
                                <option value="keto">游볨 Keto</option>
                                <option value="vegano">游 Vegano</option>
                                <option value="paleo">游꼤 Paleo</option>
                            </select>
                        </div>
                        <div class="col-sm-6">
                            <label class="small fw-bold mb-2 opacity-75">Tiempo</label>
                            <div class="input-group">
                                <input type="text" class="form-control creator-input border-end-0" placeholder="20 min">
                                <span class="input-group-text creator-input border-start-0 bg-transparent">
                                    <span class="material-symbols-outlined fs-6 opacity-50">schedule</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Photo section -->
                <section class="mb-4">
                    <h3 class="h6 fw-bold mb-3 text-uppercase opacity-75" style="letter-spacing: 1px;">Foto del Plato
                    </h3>
                    <div class="upload-box">
                        <span class="material-symbols-outlined fs-1 mb-2"
                            style="color: var(--primary-color);">add_a_photo</span>
                        <p class="mb-0 fw-bold small">Arrastra o selecciona una imagen</p>
                        <p class="x-small mb-0 opacity-50">PNG, JPG hasta 5MB</p>
                    </div>
                </section>

                <!-- Ingredients -->
                <section class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="h6 fw-bold m-0 text-uppercase opacity-75" style="letter-spacing: 1px;">Ingredientes
                        </h3>
                        <div class="small fw-bold" style="color: var(--primary-color);">
                            <span class="material-symbols-outlined fs-6">calculate</span> 0 Kcal
                        </div>
                    </div>

                    <div class="ingredient-row d-flex gap-2">
                        <input type="text" class="form-control creator-input flex-grow-1 py-2" placeholder="Ej. Quinoa">
                        <input type="text" class="form-control creator-input text-center py-2" placeholder="Cant."
                            style="width: 80px;">
                        <button class="btn btn-light text-danger d-flex align-items-center justify-content-center"
                            style="width: 44px; border-radius: 12px; background: var(--bg-page); border: 1px solid rgba(0,0,0,0.05);">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>

                    <button
                        class="btn w-100 py-2 mt-2 d-flex align-items-center justify-content-center gap-2 small fw-bold"
                        style="background: var(--primary-light); color: var(--primary-color); border: 1px dashed var(--primary-color); border-radius: 12px;">
                        <span class="material-symbols-outlined fs-6">add</span> A침adir ingrediente
                    </button>
                </section>

                <!-- Steps -->
                <section class="mb-4">
                    <h3 class="h6 fw-bold mb-3 text-uppercase opacity-75" style="letter-spacing: 1px;">Preparaci칩n</h3>
                    <div class="rounded-3 border overflow-hidden" style="border-color: rgba(0,0,0,0.05);">
                        <div class="p-2 d-flex gap-2 border-bottom"
                            style="background: var(--bg-page); border-color: rgba(0,0,0,0.05) !important;">
                            <button class="btn btn-sm text-muted"><span
                                    class="material-symbols-outlined fs-6">format_bold</span></button>
                            <button class="btn btn-sm text-muted"><span
                                    class="material-symbols-outlined fs-6">format_italic</span></button>
                            <button class="btn btn-sm text-muted"><span
                                    class="material-symbols-outlined fs-6); border-color: rgba(0,0,0,0.05) !important;">format_list_numbered</span></button>
                        </div>
                        <textarea class="form-control border-0 creator-input rounded-0" rows="4"
                            placeholder="Escribe el paso a paso aqu칤..."
                            style="height: auto; background: transparent !important;"></textarea>
                    </div>
                </section>

                <div class="pt-2">
                    <button class="btn-creator-save d-flex align-items-center justify-content-center gap-2">
                        <span class="material-symbols-outlined">save</span>
                        Guardar Receta
                    </button>
                </div>
            </main>
        </div>
    </div>

    <script>
        const offcanvas = new bootstrap.Offcanvas(document.getElementById('recipeDetailOffcanvas'));

        // Toggle favorite via AJAX
        function toggleFavorite(recetaId, btn) {
            fetch(`/api/toggle_favorito/${recetaId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        btn.classList.toggle('active');
                        const card = btn.closest('.filter-item');
                        if (card) {
                            card.dataset.favorite = data.is_favorite ? 'true' : 'false';
                        }
                        const activeTab = document.querySelector('#recipe-tabs button.active')?.dataset.tab;
                        if (activeTab === 'favoritos') {
                            applyFilters();
                        }
                    }
                });
        }

        // Recipe Creator Overlay Logic
        const openBtn = document.getElementById('openCreator');
        const closeBtn = document.getElementById('closeCreator');
        const overlay = document.getElementById('recipeOverlay');

        if (openBtn && overlay) {
            openBtn.addEventListener('click', () => {
                overlay.classList.add('show');
                document.body.classList.add('overlay-active');
            });
        }

        if (closeBtn && overlay) {
            closeBtn.addEventListener('click', () => {
                overlay.classList.remove('show');
                document.body.classList.remove('overlay-active');
            });
        }

        // Close on click outside
        if (overlay) {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('show');
                    document.body.classList.remove('overlay-active');
                }
            });
        }

        // Close on ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && overlay && overlay.classList.contains('show')) {
                overlay.classList.remove('show');
                document.body.classList.remove('overlay-active');
            }
        });

        // Combined Tab and Filter Logic
        function applyFilters() {
            const activeTab = document.querySelector('#recipe-tabs button.active')?.dataset.tab || 'explorar';
            const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'todo';
            const cards = document.querySelectorAll('.filter-item');
            let visibleCount = 0;

            cards.forEach(card => {
                const cardCategory = card.dataset.category ? card.dataset.category.toLowerCase() : '';
                const cardType = card.dataset.type ? card.dataset.type.toString() : '';
                const isFavorite = card.dataset.favorite === 'true';
                const isUserRecipe = card.dataset.userrecipe === 'true';

                // Tab filtering
                let showByTab = false;
                if (activeTab === 'explorar') {
                    showByTab = true;
                } else if (activeTab === 'mis-recetas') {
                    showByTab = isUserRecipe;
                } else if (activeTab === 'favoritos') {
                    showByTab = isFavorite;
                }

                // Category filtering
                let showByFilter = false;
                if (activeFilter === 'todo') {
                    showByFilter = true;
                } else if (activeFilter === 'tendencia') {
                    showByFilter = cardCategory === 'tendencia' || cardCategory === 'smart';
                } else if (activeFilter === 'keto') {
                    showByFilter = cardCategory === 'keto' || cardType === 'KETO';
                } else if (activeFilter === 'vegana') {
                    showByFilter = cardCategory === 'vegana' || cardType === 'VEGA' || cardType === 'VEGE';
                } else {
                    showByFilter = cardCategory === activeFilter;
                }

                // Show only if both conditions are met
                if (showByTab && showByFilter) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Toggle no results message
            const noResMsg = document.getElementById('no-results-msg');
            if (noResMsg) {
                noResMsg.style.display = visibleCount === 0 ? 'block' : 'none';
            }
        }

        // Tab switching
        document.querySelectorAll('#recipe-tabs button').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('#recipe-tabs button').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                applyFilters();
            });
        });

        // Filter button switching
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('active');
                    b.style.backgroundColor = '';
                    b.style.color = '';
                });
                btn.classList.add('active');
                btn.style.backgroundColor = 'var(--primary-color)';
                btn.style.color = 'white';
                applyFilters();
            });
        });

        // Recipe Detail Sidebar Logic
        function showRecipeDetail(title, kcal, time, rating, img, prot, protPct, carbs, carbsPct, fats, fatsPct) {
            // Datos b치sicos
            document.getElementById('detailTitle').innerText = title;
            document.getElementById('detailKcal').innerText = kcal;
            document.getElementById('detailTime').innerText = time;
            document.getElementById('detailRating').innerText = rating;
            document.getElementById('detailHeroImg').style.backgroundImage = `url('${img}')`;

            // Macros con validaci칩n
            document.getElementById('detailProtText').innerText = `${prot} (${protPct})`;
            document.getElementById('detailProtBar').style.width = protPct;

            document.getElementById('detailCarbsText').innerText = `${carbs} (${carbsPct})`;
            document.getElementById('detailCarbsBar').style.width = carbsPct;

            document.getElementById('detailFatsText').innerText = `${fats} (${fatsPct})`;
            document.getElementById('detailFatsBar').style.width = fatsPct;

            // Limpiar ingredientes y pasos (Ejemplo est치tico por ahora)
            const ingredientsBox = document.getElementById('detailIngredients');
            ingredientsBox.innerHTML = `
            <div class="custom-card-detail p-3 d-flex justify-content-between align-items-center border-0 shadow-sm" style="background: rgba(133,200,26,0.05);">
                <div class="d-flex align-items-center gap-3">
                    <span class="material-symbols-outlined text-brand">check_circle</span>
                    <span class="fw-medium">Ingrediente Principal</span>
                </div>
                <span class="small text-secondary fw-bold">150g</span>
            </div>
            <div class="custom-card-detail p-3 d-flex justify-content-between align-items-center border-0 shadow-sm" style="background: rgba(133,200,26,0.05);">
                <div class="d-flex align-items-center gap-3">
                    <span class="material-symbols-outlined text-brand">check_circle</span>
                    <span class="fw-medium">Acompa침amiento</span>
                </div>
                <span class="small text-secondary fw-bold">1/2 taza</span>
            </div>
        `;

            const stepsBox = document.getElementById('detailSteps');
            stepsBox.innerHTML = `
            <div class="d-flex gap-3">
                <div class="step-number-circle">1</div>
                <p class="small m-0 opacity-75">Sazona y cocina el ingrediente principal a la plancha hasta que est칠 dorado.</p>
            </div>
            <div class="d-flex gap-3">
                <div class="step-number-circle">2</div>
                <p class="small m-0 opacity-75">Prepara el acompa침amiento y sirve en un bowl con vegetales frescos.</p>
            </div>
        `;

            // Mostrar Panel
            offcanvas.show();
        }

        function filterRecipes(btn) {
            // Update active state
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.style.backgroundColor = '';
                b.style.color = '';
            });

            btn.classList.add('active');
            btn.style.backgroundColor = 'var(--primary-color)';
            btn.style.color = 'white';

            const activeFilter = btn.dataset.filter;
            const cards = document.querySelectorAll('.filter-item');
            let visibleCount = 0;

            cards.forEach(card => {
                const cardCategory = card.dataset.category ? card.dataset.category.toLowerCase() : '';
                const cardType = card.dataset.type ? card.dataset.type.toString() : ''; // KETO, VEGA, etc.

                let show = false;

                if (activeFilter === 'todo') {
                    show = true;
                } else if (activeFilter === 'tendencia') {
                    // Mostrar si es expl칤citamente tendencia o si es smart/popular
                    show = cardCategory === 'tendencia' || cardCategory === 'smart';
                } else if (activeFilter === 'keto') {
                    // Match category OR diet type KETO
                    show = cardCategory === 'keto' || cardType === 'KETO';
                } else if (activeFilter === 'vegana') {
                    // Match category OR diet type VEGA/VEGE
                    show = cardCategory === 'vegana' || cardType === 'VEGA' || cardType === 'VEGE';
                } else {
                    // Fallback direct match
                    show = cardCategory === activeFilter;
                }

                if (show) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Toggle No Results Msg
            const noResMsg = document.getElementById('no-results-msg');
            if (noResMsg) {
                noResMsg.style.display = visibleCount === 0 ? 'block' : 'none';
            }
        }
    </script>
    {% endblock %}