{% extends base_template %}
{% load static %}

{% block title %}Dashboard Administrativo | nunut AI{% endblock %}

{% block content %}
<div class="container-fluid py-4 px-md-5"
    style="background: radial-gradient(circle at top right, rgba(133, 200, 26, 0.05), transparent 400px);">

    <!-- Top Header -->
    <div class="row align-items-center mb-5 animate__animated animate__fadeIn">
        <div class="col-md-7">
            <div class="d-flex align-items-center gap-3 mb-2">
                <span class="badge bg-brand text-white rounded-pill px-3 py-1 x-small fw-black shadow-sm">MODO
                    ADMINISTRACIÓN</span>
                <span class="text-muted x-small fw-bold">v2.5.0-premium</span>
            </div>
            <h1 class="fw-black m-0 display-5">Panel <span class="text-brand">Inteligente</span></h1>
            <p class="text-muted fw-bold">Monitorización global y curación de ecosistema en tiempo real.</p>
        </div>
        <div class="col-md-5 text-md-end">
            <div class="d-inline-flex align-items-center gap-3">
                <div
                    class="d-inline-flex align-items-center gap-2 bg-white dark-mode-bg-dark px-4 py-3 rounded-4 shadow-sm border">
                    <div class="text-end me-3">
                        <p class="x-small text-muted mb-0 fw-bold">FECHA DEL SISTEMA</p>
                        <p class="fw-black mb-0">{% now "l, d F Y" %}</p>
                    </div>
                    <span class="material-symbols-outlined text-brand fs-1">analytics</span>
                </div>
                <button onclick="handleLogout()"
                    class="btn btn-white dark-mode-bg-dark text-danger rounded-circle p-3 d-flex align-items-center justify-content-center shadow-sm border transform-hover"
                    title="Cerrar Sesión">
                    <span class="material-symbols-outlined">logout</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Actions & Stats -->
    <div class="row g-4 mb-5 animate__animated animate__fadeInUp">
        <div class="col-md-3">
            <div class="premium-stat-card p-4 rounded-5 bg-white shadow-sm border-0 position-relative overflow-hidden">
                <div class="position-absolute top-0 end-0 p-3 opacity-10">
                    <span class="material-symbols-outlined display-1">group</span>
                </div>
                <p class="x-small text-muted fw-black text-uppercase tracking-wider mb-2">Comunidad Total</p>
                <h2 class="display-5 fw-black mb-1">{{ stats.total_users }}</h2>
                <div class="d-flex align-items-center gap-2 text-success x-small fw-bold">
                    <span class="material-symbols-outlined fs-6">trending_up</span> +{{ stats.crecimiento.dia }}% hoy
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="premium-stat-card p-4 rounded-5 bg-white shadow-sm border-0 position-relative overflow-hidden">
                <div class="position-absolute top-0 end-0 p-3 opacity-10">
                    <span class="material-symbols-outlined display-1">bolt</span>
                </div>
                <p class="x-small text-muted fw-black text-uppercase tracking-wider mb-2">Engagement (7d)</p>
                <h2 class="display-5 fw-black mb-1">{{ stats.active_7d }}</h2>
                <div class="d-flex align-items-center gap-2 text-info x-small fw-bold">
                    <span class="material-symbols-outlined fs-6">query_stats</span> {{ stats.crecimiento.semana }}%
                    semana
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="premium-stat-card p-4 rounded-5 bg-white shadow-sm border-0 position-relative overflow-hidden">
                <div class="position-absolute top-0 end-0 p-3 opacity-10">
                    <span class="material-symbols-outlined display-1">forum</span>
                </div>
                <p class="x-small text-muted fw-black text-uppercase tracking-wider mb-2">Feedback Abierto</p>
                <h2 class="display-5 fw-black mb-1">{{ sugerencias|length }}</h2>
                <div class="d-flex align-items-center gap-2 text-warning x-small fw-bold">
                    <span class="material-symbols-outlined fs-6">priority_high</span> Requiere atención
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div
                class="premium-stat-card p-4 rounded-5 bg-dark text-white shadow-lg border-0 d-flex flex-column justify-content-center">
                <p class="x-small text-white-50 fw-black text-uppercase tracking-wider mb-3">Gestión Humana</p>
                <a href="{% url 'base:admin_registro' %}"
                    class="btn btn-brand w-100 rounded-pill py-2 fw-black shadow-sm transform-hover">
                    NUEVO ADMIN <span class="material-symbols-outlined fs-6 ms-1">person_add</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row g-4 mb-5">
        <div class="col-lg-8 animate__animated animate__fadeInLeft">
            <div class="premium-card p-4 rounded-5 bg-white shadow-sm border-0 h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="h6 fw-black text-uppercase tracking-widest m-0">Curva de Crecimiento</h3>
                    <div class="btn-group btn-group-sm bg-light rounded-pill p-1">
                        <button
                            class="btn {% if charts.evolucion.current_period == 'semana' %}btn-brand text-white shadow-sm{% else %}btn-light{% endif %} rounded-pill px-3 x-small fw-black transition-all"
                            onclick="changeEvoPeriod('semana')">Semana</button>
                        <button
                            class="btn {% if charts.evolucion.current_period == 'mes' %}btn-brand text-white shadow-sm{% else %}btn-light{% endif %} rounded-pill px-3 x-small fw-black transition-all"
                            onclick="changeEvoPeriod('mes')">Mes</button>
                        <button
                            class="btn {% if charts.evolucion.current_period == 'ano' %}btn-brand text-white shadow-sm{% else %}btn-light{% endif %} rounded-pill px-3 x-small fw-black transition-all"
                            onclick="changeEvoPeriod('ano')">Año</button>
                    </div>
                </div>
                <div style="height: 350px;">
                    <canvas id="adminPageEvolutionChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4 animate__animated animate__fadeInRight">
            <div class="premium-card p-4 rounded-5 bg-white shadow-sm border-0 h-100">
                <h3 class="h6 fw-black text-uppercase tracking-widest mb-4">Alcance Global</h3>
                <div class="country-list">
                    {% for pais in charts.dist_paises|slice:":6" %}
                    <div class="d-flex align-items-center gap-3 mb-3 pb-3 border-bottom border-light">
                        <div class="bg-light rounded-3 p-2 fw-black x-small text-muted">{{ forloop.counter }}</div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="small fw-black">{{ pais.localidad|default:"Global" }}</span>
                                <span class="badge bg-light text-dark rounded-pill x-small fw-bold">{{ pais.count
                                    }}</span>
                            </div>
                            <div class="progress rounded-pill overflow-hidden bg-light" style="height: 6px;">
                                <div class="progress-bar bg-brand shadow-sm"
                                    style="width: {% widthratio pais.count stats.total_users 100 %}%"></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- New Section: Recent Community Activity -->
    <div class="row g-4 mb-5 animate__animated animate__fadeInUp">
        <div class="col-12">
            <div class="premium-card p-4 rounded-5 bg-white shadow-sm border-0">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="h6 fw-black text-uppercase tracking-widest m-0">Comunidad Reciente</h3>
                    <span class="badge bg-light text-muted rounded-pill x-small px-3">Últimas incorporaciones</span>
                </div>
                <div class="row g-3">
                    {% for u in recent_users %}
                    <div class="col-md-4 col-lg-2">
                        <div
                            class="bg-light-soft p-3 rounded-4 text-center transform-hover border h-100 d-flex flex-column align-items-center justify-content-center">
                            <div class="rounded-circle bg-brand bg-opacity-10 text-brand d-flex align-items-center justify-content-center mb-2 fw-black"
                                style="width: 50px; height: 50px; font-size: 1.3rem;">
                                {{ u.email.0|upper|default:u.username.0|upper }}
                            </div>
                            <p class="x-small fw-black text-truncate mb-1 w-100" title="{{ u.email }}">{{
                                u.username|default:"Usuario" }}</p>
                            <p class="text-muted" style="font-size: 0.6rem;">{{ u.date_joined|date:"d M, H:i" }}</p>
                            <span
                                class="badge {% if u.is_active %}bg-success{% else %}bg-secondary{% endif %} bg-opacity-10 {% if u.is_active %}text-success{% else %}text-secondary{% endif %} rounded-pill x-small px-2"
                                style="font-size: 0.5rem;">
                                {% if u.is_active %}ACTIVO{% else %}INACTIVO{% endif %}
                            </span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center py-4">
                        <p class="text-muted small mb-0">No hay registros recientes.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analytics & Curation -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="premium-card p-4 rounded-5 bg-white shadow-sm border-0">
                <h3 class="h6 fw-black text-uppercase tracking-widest mb-4">Demografía</h3>
                <div style="height: 200px;" class="mb-4">
                    <canvas id="adminPageGenderChart"></canvas>
                </div>
                <div class="d-flex justify-content-around text-center border-top pt-4">
                    <div>
                        <p class="x-small text-muted fw-bold mb-1 text-uppercase tracking-tighter">Promedio Edad</p>
                        <p class="h5 fw-black mb-0">{{ stats.avg_edad }}</p>
                    </div>
                    <div class="vr opacity-10"></div>
                    <div>
                        <p class="x-small text-muted fw-bold mb-1 text-uppercase tracking-tighter">Retención</p>
                        <p class="h5 fw-black mb-0 text-brand">{{ stats.retencion }}%</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="premium-card p-4 rounded-5 bg-white shadow-sm border-0">
                <h3 class="h6 fw-black text-uppercase tracking-widest mb-4">Objetivos Predominantes</h3>
                <div style="height: 200px;" class="mb-4">
                    <canvas id="adminPageObjectivesChart"></canvas>
                </div>
                <div style="height: 100px;">
                    <canvas id="adminPageAgeChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="premium-card p-4 rounded-5 bg-white shadow-sm border-0 bg-light-soft">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="h6 fw-black text-uppercase tracking-widest m-0">Curación Inteligente</h3>
                    <span class="badge bg-brand text-white rounded-pill x-small px-3">{{ recetas_pendientes|length
                        }}</span>
                </div>
                <div class="scroll-container" style="max-height: 380px; overflow-y: auto;">
                    {% for rec in recetas_pendientes %}
                    <div class="bg-white p-3 rounded-4 border mb-2 d-flex gap-3 align-items-center transform-hover">
                        <img src="{{ rec.imagen_url|default:'https://images.unsplash.com/photo-1490645935967-10de6ba17061?w=60' }}"
                            class="rounded-3 shadow-sm" style="width: 50px; height: 50px; object-fit: cover;">
                        <div class="flex-grow-1 overflow-hidden">
                            <p class="small fw-black mb-0 text-truncate">{{ rec.titulo }}</p>
                            <p class="x-small text-muted mb-2">{{ rec.tipo_dieta }}</p>
                            <div class="d-flex gap-2">
                                <button class="btn btn-brand btn-sm px-3 rounded-pill x-small text-white fw-black"
                                    onclick="curarAdmin('{{ rec.id }}', 'aprobar')">APROBAR</button>
                                <button class="btn btn-outline-danger btn-sm px-2 rounded-circle x-small"
                                    onclick="curarAdmin('{{ rec.id }}', 'rechazar')">✕</button>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5">
                        <div
                            class="bg-brand bg-opacity-5 rounded-circle d-inline-flex p-4 mb-3 border border-brand border-opacity-10 animate__animated animate__pulse animate__infinite">
                            <span class="material-symbols-outlined display-4 text-brand">verified</span>
                        </div>
                        <p class="small text-muted fw-black text-uppercase tracking-widest mb-0">Ecosistema purificado
                        </p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Suggestions Mastery Board -->
    <div class="row animate__animated animate__fadeInUp">
        <div class="col-12">
            <div class="premium-card p-0 rounded-5 bg-white shadow-lg border-0 overflow-hidden">
                <!-- Header with Filters -->
                <div
                    class="p-4 bg-dark text-white d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                    <div>
                        <h2 class="h4 fw-black m-0 mb-1 d-flex align-items-center gap-2">
                            <span class="material-symbols-outlined text-brand">forum</span> Buzón Maestro de Feedback
                        </h2>
                        <p class="x-small text-white-50 fw-bold mb-0 text-uppercase tracking-widest">Escuchando a la
                            comunidad • <span id="sug-count">{{ sugerencias|length }}</span> Pendientes</p>
                    </div>

                    <div class="d-flex flex-wrap gap-2">
                        <!-- Star Filter -->
                        <div class="btn-group btn-group-sm">
                            <button
                                class="btn btn-outline-light rounded-start-pill px-3 fw-bold {% if not request.GET.sug_rating %}active{% endif %}"
                                onclick="filterStars('')">Toda Calidad</button>
                            {% for i in "54321"|make_list %}
                            <button
                                class="btn btn-outline-light px-3 fw-bold {% if request.GET.sug_rating == i %}active{% endif %}"
                                onclick="filterStars('{{ i }}')">
                                {{ i }}<span class="material-symbols-outlined fs-6 ms-1"
                                    style="color: #f1c40f;">star</span>
                            </button>
                            {% endfor %}
                        </div>

                        <!-- State Filter -->
                        <select
                            class="form-select form-select-sm rounded-pill px-3 bg-dark text-white border-secondary fw-bold"
                            style="min-width: 150px;" onchange="filterStatus(this.value)">
                            <option value="">Todos los Estados</option>
                            <option value="PENDIENTE" {% if request.GET.sug_estado=='PENDIENTE' %}selected{% endif %}>
                                Pendientes</option>
                            <option value="LEIDO" {% if request.GET.sug_estado=='LEIDO' %}selected{% endif %}>Leídos
                            </option>
                            <option value="REVISION" {% if request.GET.sug_estado=='REVISION' %}selected{% endif %}>En
                                Revisión</option>
                            <option value="ARCHIVADO">Archivados</option>
                        </select>
                    </div>
                </div>

                <!-- Suggestions List -->
                <div class="suggestion-list scroll-container" style="max-height: 700px; overflow-y: auto;">
                    {% for sug in sugerencias %}
                    <div class="sug-item border-bottom p-4 animate-fade-up {% if sug.estado == 'PENDIENTE' %}bg-light-soft{% endif %}"
                        id="sug-card-{{ sug.id }}" style="transition: all 0.3s ease;">
                        <div class="row align-items-start gy-3">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <div class="rounded-circle bg-brand bg-opacity-10 text-brand d-flex align-items-center justify-content-center fw-black shadow-sm"
                                        style="width: 40px; height: 40px;">
                                        {{ sug.perfil.usuario.email.0|upper }}
                                    </div>
                                    <div>
                                        <div class="d-flex align-items-center gap-2">
                                            <h6 class="fw-black mb-0">{{ sug.perfil.usuario.email|default:"Usuario
                                                Anónimo" }}</h6>
                                            <span
                                                class="badge {% if sug.estado == 'PENDIENTE' %}bg-danger{% elif sug.estado == 'LEIDO' %}bg-info{% else %}bg-success{% endif %} bg-opacity-10 {% if sug.estado == 'PENDIENTE' %}text-danger{% elif sug.estado == 'LEIDO' %}text-info{% else %}text-success{% endif %} rounded-pill x-small fw-black px-2">
                                                {{ sug.get_estado_display|upper }}
                                            </span>
                                        </div>
                                        <p class="x-small text-muted mb-0 fw-bold">{{ sug.fecha|date:"d M Y • H:i" }}
                                        </p>
                                    </div>
                                </div>
                                <h5 class="fw-black mb-2 text-dark">{{ sug.asunto }}</h5>
                                <p class="text-secondary small mb-3 lh-base" style="font-weight: 500;">{{ sug.mensaje }}
                                </p>

                                <div class="d-flex gap-1 mb-3">
                                    {% for i in "12345"|make_list %}<span
                                        class="material-symbols-outlined fs-5 {% if sug.calificacion >= forloop.counter|add:0 %}text-warning{% else %}text-muted opacity-25{% endif %}">star</span>{%
                                    endfor %}
                                </div>

                                {% if sug.respuesta_admin %}
                                <div
                                    class="admin-response-box p-3 rounded-4 bg-brand bg-opacity-5 border border-brand border-opacity-10 mb-3">
                                    <p
                                        class="x-small text-brand fw-black text-uppercase mb-2 d-flex align-items-center gap-2">
                                        <span class="material-symbols-outlined fs-6">reply</span> Respuesta de nunut
                                        Labs
                                    </p>
                                    <p class="small mb-0 italic" style="font-weight: 500;">{{ sug.respuesta_admin }}</p>
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-md-4 text-md-end">
                                <div class="d-flex flex-md-column gap-2 justify-content-end">
                                    {% if sug.estado == 'PENDIENTE' %}
                                    <button class="btn btn-brand btn-sm rounded-pill px-4 fw-black text-white"
                                        onclick="marcarLeido({{ sug.id }})">MARCAR LEÍDO</button>
                                    {% endif %}
                                    <button class="btn btn-outline-dark btn-sm rounded-pill px-4 fw-black"
                                        onclick="openReplyModal({{ sug.id }}, '{{ sug.perfil.usuario.email }}')">RESPONDER</button>
                                    <button class="btn btn-outline-secondary btn-sm rounded-pill px-4"
                                        onclick="archivarSugerencia({{ sug.id }})">ARCHIVAR</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5">
                        <span class="material-symbols-outlined display-1 text-muted opacity-10">inbox</span>
                        <p class="fw-black text-muted mt-3">No hay sugerencias con estos filtros.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reply Modal -->
<div class="modal fade" id="replyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-5 shadow-lg overflow-hidden">
            <div class="modal-header bg-dark text-white border-0 py-3">
                <h5 class="modal-title fw-black">Responder Sugerencia</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="x-small text-muted fw-bold text-uppercase mb-2">PARA: <span id="reply-to-user"
                        class="text-brand"></span></p>
                <textarea id="reply-text" class="form-control border-light shadow-sm rounded-4 mb-3" rows="5"
                    placeholder="Escribe tu respuesta aquí..."></textarea>
                <div class="d-flex gap-2">
                    <button class="btn btn-brand w-100 rounded-pill py-3 fw-bold shadow-sm"
                        onclick="submitReply()">ENVIAR RESPUESTA</button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modal & Scripts from index.html assumed to be available or added here -->
<!-- Re-adding scripts for standalone page functionality -->
<script>
    // Charts Initialization
    document.addEventListener('DOMContentLoaded', function () {
        const evoContainer = document.getElementById('adminPageEvolutionChart');
        if (evoContainer) {
            const evoData = JSON.parse(document.getElementById('evolution-json').textContent);
            new Chart(evoContainer, {
                type: 'line',
                data: {
                    labels: evoData.labels,
                    datasets: [{
                        label: 'Nuevos Usuarios',
                        data: evoData.values,
                        borderColor: '#85c81a',
                        backgroundColor: 'rgba(133, 200, 26, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: '#85c81a',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        const genContainer = document.getElementById('adminPageGenderChart');
        if (genContainer) {
            const genData = JSON.parse(document.getElementById('gender-json').textContent);
            const h = genData.find(g => g.genero === 'H')?.count || 0;
            const m = genData.find(g => g.genero === 'M')?.count || 0;
            new Chart(genContainer, {
                type: 'doughnut',
                data: { labels: ['Hombres', 'Mujeres'], datasets: [{ data: [h, m], backgroundColor: ['#3498db', '#fd79a8'], borderWeight: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: { display: false } } }
            });
        }

        const objContainer = document.getElementById('adminPageObjectivesChart');
        if (objContainer) {
            const objData = JSON.parse(document.getElementById('objectives-json').textContent);
            const lose = objData.find(o => o.objetivo === 'PERDER')?.count || 0;
            const ga = objData.find(o => o.objetivo === 'GANAR')?.count || 0;
            const ma = objData.find(o => o.objetivo === 'MANTENER')?.count || 0;
            new Chart(objContainer, {
                type: 'bar',
                data: {
                    labels: ['Perder', 'Ganar', 'Mantener'],
                    datasets: [{
                        data: [lose, ga, ma],
                        backgroundColor: ['#ff7675', '#00b894', '#00cec9'],
                        borderRadius: 8,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }
    });

    // Growth Curve Period Switcher
    window.changeEvoPeriod = function (val) {
        const url = new URL(window.location);
        url.searchParams.set('evo_period', val);
        window.location.href = url.toString();
    };

    // Suggestion Management Logic
    let activeReplyId = null;

    window.filterStars = function (val) {
        const url = new URL(window.location);
        if (val) url.searchParams.set('sug_rating', val);
        else url.searchParams.delete('sug_rating');
        window.location.href = url.toString();
    };

    window.filterStatus = function (val) {
        const url = new URL(window.location);
        if (val) url.searchParams.set('sug_estado', val);
        else url.searchParams.delete('sug_estado');
        window.location.href = url.toString();
    };

    window.marcarLeido = function (id) {
        fetch(`/api/marcar_leido_sugerencia/${id}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    const badge = document.querySelector(`#sug-card-${id} .badge`);
                    if (badge) {
                        badge.className = 'badge bg-info bg-opacity-10 text-info rounded-pill x-small fw-black px-2';
                        badge.innerText = 'LEÍDO';
                    }
                    const btn = document.querySelector(`#sug-card-${id} button[onclick^="marcarLeido"]`);
                    if (btn) btn.remove();
                    showToast("Sugerencia marcada como leída", "success");
                }
            });
    };

    window.archivarSugerencia = function (id) {
        if (!confirm('¿Estás seguro de archivar esta sugerencia?')) return;
        fetch(`/api/archivar_sugerencia/${id}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    const el = document.getElementById(`sug-card-${id}`);
                    el.style.opacity = '0';
                    setTimeout(() => el.remove(), 300);
                    showToast("Sugerencia archivada", "info");
                }
            });
    };

    window.openReplyModal = function (id, email) {
        activeReplyId = id;
        document.getElementById('reply-to-user').innerText = email;
        const modal = new bootstrap.Modal(document.getElementById('replyModal'));
        modal.show();
    };

    window.submitReply = function () {
        const text = document.getElementById('reply-text').value;
        if (!text) return showToast("Escribe una respuesta", "warning");

        fetch(`/api/responder_sugerencia/${activeReplyId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ respuesta: text, estado: 'REVISION' })
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast("Respuesta enviada", "success");
                    bootstrap.Modal.getInstance(document.getElementById('replyModal')).hide();
                    setTimeout(() => location.reload(), 500);
                }
            });
    };


    window.curarAdmin = function (id, accion) {
        if (!confirm('¿Confirmar acción: ' + accion + '?')) return;
        fetch(`/api/curar_receta/${id}/`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/x-www-form-urlencoded' }, body: `accion=${accion}` })
            .then(res => res.json()).then(data => { if (data.status === 'success') { location.reload(); } });
    };


</script>

{{ charts.evolucion|json_script:"evolution-json" }}
{{ charts.dist_genero|json_script:"gender-json" }}
{{ charts.dist_edad|json_script:"age-json" }}
{{ charts.dist_objetivos|json_script:"objectives-json" }}

<style>
    .text-brand {
        color: var(--brand-primary);
    }

    .btn-brand {
        background-color: var(--brand-primary);
        color: white;
        border: none;
    }

    .btn-brand:hover {
        background-color: var(--brand-dark);
        color: white;
    }

    .bg-light-soft {
        background-color: #f8fafc;
    }

    .premium-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(0, 0, 0, 0.03) !important;
    }

    .premium-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05) !important;
    }

    .premium-stat-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: default;
        border: 1px solid rgba(0, 0, 0, 0.03) !important;
    }

    .premium-stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1) !important;
    }

    .rounded-5 {
        border-radius: 1.5rem !important;
    }

    .fw-black {
        font-weight: 900 !important;
    }

    .x-small {
        font-size: 0.7rem !important;
    }

    .tracking-widest {
        letter-spacing: 2px;
    }

    .transform-hover {
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .transform-hover:hover {
        transform: scale(1.02);
    }

    .scroll-container::-webkit-scrollbar {
        width: 4px;
    }

    .scroll-container::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
    }
</style>
{% endblock %}